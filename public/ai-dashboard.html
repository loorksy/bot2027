<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Agent Dashboard - ุฃุจู ุณูุทุงู</title>
  <link rel="stylesheet" href="styles.css">
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Cairo', sans-serif;
      background: #0f172a;
      color: #e2e8f0;
      min-height: 100vh;
    }

    /* Main Layout */
    .app-layout {
      display: flex;
      min-height: 100vh;
    }

    /* Sidebar */
    .sidebar {
      width: 280px;
      background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%);
      border-left: 1px solid rgba(255,255,255,0.1);
      position: fixed;
      right: 0;
      top: 0;
      bottom: 0;
      z-index: 100;
      display: flex;
      flex-direction: column;
      transition: transform 0.3s ease;
    }

    .sidebar-header {
      padding: 24px 20px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .sidebar-logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo-icon {
      width: 45px;
      height: 45px;
      background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }

    .logo-text {
      font-size: 1.1rem;
      font-weight: 700;
      color: #fff;
    }

    .logo-subtitle {
      font-size: 0.75rem;
      color: #64748b;
    }

    .sidebar-nav {
      flex: 1;
      padding: 16px 12px;
      overflow-y: auto;
    }

    .nav-section {
      margin-bottom: 24px;
    }

    .nav-section-title {
      font-size: 0.7rem;
      font-weight: 600;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 1px;
      padding: 0 12px;
      margin-bottom: 8px;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      border-radius: 10px;
      cursor: pointer;
      color: #94a3b8;
      transition: all 0.2s ease;
      margin-bottom: 4px;
    }

    .nav-item:hover {
      background: rgba(59, 130, 246, 0.1);
      color: #e2e8f0;
    }

    .nav-item.active {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.2) 0%, rgba(139, 92, 246, 0.2) 100%);
      color: #fff;
      border: 1px solid rgba(59, 130, 246, 0.3);
    }

    .nav-item-icon {
      font-size: 1.2rem;
      width: 24px;
      text-align: center;
    }

    .nav-item-text {
      font-size: 0.9rem;
      font-weight: 500;
    }

    .sidebar-footer {
      padding: 16px 20px;
      border-top: 1px solid rgba(255,255,255,0.1);
    }

    .back-home {
      display: flex;
      align-items: center;
      gap: 10px;
      color: #64748b;
      text-decoration: none;
      font-size: 0.85rem;
      padding: 10px 12px;
      border-radius: 8px;
      transition: all 0.2s ease;
    }

    .back-home:hover {
      background: rgba(255,255,255,0.05);
      color: #e2e8f0;
    }

    /* Main Content */
    .main-content {
      flex: 1;
      margin-right: 280px;
      min-height: 100vh;
    }

    /* Top Header */
    .top-header {
      background: rgba(30, 41, 59, 0.8);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255,255,255,0.1);
      padding: 16px 32px;
      position: sticky;
      top: 0;
      z-index: 50;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .page-title {
      font-size: 1.3rem;
      font-weight: 600;
      color: #fff;
    }

    .header-actions {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    /* Content Area */
    .content-area {
      padding: 32px;
    }

    /* Cards */
    .ai-card {
      background: #1e293b;
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
      border: 1px solid rgba(255,255,255,0.1);
    }

    .ai-card h2 {
      margin: 0 0 24px 0;
      color: #fff;
      font-size: 1.1rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
      padding-bottom: 16px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .ai-card h2::before {
      content: '';
      width: 4px;
      height: 20px;
      background: linear-gradient(180deg, #3b82f6, #8b5cf6);
      border-radius: 2px;
    }

    /* Form Elements */
    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #94a3b8;
      font-size: 0.85rem;
      font-weight: 500;
    }

    .form-group input,
    .form-group select {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #334155;
      border-radius: 10px;
      background: #0f172a;
      color: #fff;
      font-size: 0.95rem;
      font-family: inherit;
      transition: all 0.2s ease;
    }

    .form-group input:focus,
    .form-group select:focus {
      border-color: #3b82f6;
      outline: none;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
    }

    .form-group input::placeholder {
      color: #475569;
    }

    .form-group input[type="password"] {
      font-family: monospace;
      letter-spacing: 2px;
    }

    /* Toggle Switch */
    .toggle-container {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .toggle {
      position: relative;
      width: 52px;
      height: 28px;
    }

    .toggle input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      cursor: pointer;
      inset: 0;
      background: #334155;
      border-radius: 14px;
      transition: 0.3s;
    }

    .toggle-slider:before {
      content: '';
      position: absolute;
      height: 20px;
      width: 20px;
      right: 4px;
      bottom: 4px;
      background: #fff;
      border-radius: 50%;
      transition: 0.3s;
    }

    .toggle input:checked+.toggle-slider {
      background: linear-gradient(135deg, #3b82f6, #8b5cf6);
    }

    .toggle input:checked+.toggle-slider:before {
      transform: translateX(-24px);
    }

    /* Buttons */
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 600;
      font-family: inherit;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
      color: #fff;
      box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
    }

    .btn-secondary {
      background: #334155;
      color: #fff;
      border: 1px solid #475569;
    }

    .btn-secondary:hover {
      background: #3d4f66;
      border-color: #64748b;
    }

    .btn-danger {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: #fff;
    }

    .btn-danger:hover {
      transform: translateY(-2px);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }

    /* Row Layout */
    .row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
    }

    .row .form-group {
      margin-bottom: 0;
    }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .stat-card {
      background: linear-gradient(145deg, #1e293b, #0f172a);
      padding: 20px;
      border-radius: 12px;
      text-align: center;
      border: 1px solid rgba(255,255,255,0.05);
    }

    .stat-value {
      font-size: 1.8rem;
      font-weight: 700;
      background: linear-gradient(135deg, #3b82f6, #8b5cf6);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .stat-label {
      font-size: 0.8rem;
      color: #64748b;
      margin-top: 4px;
    }

    /* Tables */
    .clients-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
    }

    .clients-table th,
    .clients-table td {
      padding: 14px 16px;
      text-align: right;
    }

    .clients-table thead th {
      background: rgba(59, 130, 246, 0.1);
      color: #94a3b8;
      font-weight: 600;
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .clients-table thead th:first-child {
      border-radius: 0 10px 0 0;
    }

    .clients-table thead th:last-child {
      border-radius: 10px 0 0 0;
    }

    .clients-table tbody tr {
      border-bottom: 1px solid rgba(255,255,255,0.05);
      transition: all 0.2s ease;
    }

    .clients-table tbody tr:hover {
      background: rgba(59, 130, 246, 0.05);
    }

    /* Status Badges */
    .status-badge {
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .status-complete {
      background: rgba(34, 197, 94, 0.2);
      color: #22c55e;
    }

    .status-incomplete {
      background: rgba(245, 158, 11, 0.2);
      color: #f59e0b;
    }

    /* Period Items */
    .period-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      background: #0f172a;
      border-radius: 12px;
      margin-bottom: 12px;
      border: 1px solid rgba(255,255,255,0.05);
    }

    .period-info h4 {
      margin: 0 0 4px 0;
      color: #fff;
      font-weight: 600;
    }

    .period-info span {
      font-size: 0.8rem;
      color: #64748b;
    }

    .period-badge {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: #fff;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.7rem;
      font-weight: 600;
      margin-right: 8px;
    }

    /* File Upload */
    .file-upload {
      border: 2px dashed #334155;
      border-radius: 16px;
      padding: 40px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      background: rgba(15, 23, 42, 0.5);
    }

    .file-upload:hover {
      border-color: #3b82f6;
      background: rgba(59, 130, 246, 0.05);
    }

    .file-upload.dragover {
      border-color: #3b82f6;
      background: rgba(59, 130, 246, 0.1);
    }

    .file-upload input[type="file"] {
      display: none;
    }

    .file-upload-icon {
      font-size: 48px;
      color: #475569;
      margin-bottom: 12px;
    }

    /* Usage Log */
    .usage-log {
      max-height: 350px;
      overflow-y: auto;
    }

    .log-entry {
      display: flex;
      gap: 16px;
      padding: 14px 16px;
      background: #0f172a;
      border-radius: 10px;
      margin-bottom: 8px;
      font-size: 0.85rem;
      align-items: center;
    }

    .log-type {
      font-weight: 600;
      width: 60px;
      padding: 4px 10px;
      border-radius: 6px;
      text-align: center;
      font-size: 0.75rem;
    }

    .log-type.CHAT {
      background: rgba(59, 130, 246, 0.2);
      color: #3b82f6;
    }

    .log-type.STT {
      background: rgba(34, 197, 94, 0.2);
      color: #22c55e;
    }

    .log-type.TTS {
      background: rgba(245, 158, 11, 0.2);
      color: #f59e0b;
    }

    .log-details {
      flex: 1;
      color: #94a3b8;
    }

    .log-cost {
      color: #8b5cf6;
      font-weight: 600;
    }

    /* Alerts */
    .alert {
      padding: 16px 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .alert-success {
      background: rgba(34, 197, 94, 0.15);
      border: 1px solid rgba(34, 197, 94, 0.3);
      color: #22c55e;
    }

    .alert-error {
      background: rgba(239, 68, 68, 0.15);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: #ef4444;
    }

    /* Tab Content */
    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Hide old tabs */
    .tab-container {
      display: none;
    }

    /* Checkbox */
    input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: #3b82f6;
      cursor: pointer;
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb {
      background: #475569;
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #64748b;
    }

    /* Mobile Responsive */
    .mobile-menu-btn {
      display: none;
      background: #1e293b;
      border: 1px solid #334155;
      color: #fff;
      padding: 10px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1.2rem;
    }

    @media (max-width: 1024px) {
      .sidebar {
        transform: translateX(100%);
      }

      .sidebar.open {
        transform: translateX(0);
      }

      .main-content {
        margin-right: 0;
      }

      .mobile-menu-btn {
        display: block;
      }

      .content-area {
        padding: 20px;
      }

      .row {
        grid-template-columns: 1fr;
      }
    }

    /* Quick Action Buttons */
    .quick-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }

    .quick-actions .btn {
      padding: 10px 16px;
      font-size: 0.85rem;
    }

    /* Fields List */
    #fieldsList {
      display: grid;
      gap: 12px;
    }

    .field-card {
      background: #0f172a;
      border: 1px solid rgba(255,255,255,0.05);
      border-radius: 12px;
      padding: 16px;
    }

    /* Old back-link hide */
    .back-link {
      display: none;
    }

    /* Old h1 hide */
    .ai-container > h1 {
      display: none;
    }
  </style>
</head>

<body>
  <div class="app-layout">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-logo">
          <div class="logo-icon">๐ค</div>
          <div>
            <div class="logo-text">AI Agent</div>
            <div class="logo-subtitle">ูุณุงุนุฏ ุฃุจู ุณูุทุงู</div>
          </div>
        </div>
      </div>

      <nav class="sidebar-nav">
        <div class="nav-section">
          <div class="nav-section-title">ุงูุฅุนุฏุงุฏุงุช</div>
          <div class="nav-item active" data-tab="settings">
            <span class="nav-item-icon">โ๏ธ</span>
            <span class="nav-item-text">ุฅุนุฏุงุฏุงุช AI</span>
          </div>
          <div class="nav-item" data-tab="fields">
            <span class="nav-item-icon">๐</span>
            <span class="nav-item-text">ุงูุญููู ุงููุฎุตุตุฉ</span>
          </div>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">ุฅุฏุงุฑุฉ ุงูุนููุงุก</div>
          <div class="nav-item" data-tab="registered">
            <span class="nav-item-icon">๐ฅ</span>
            <span class="nav-item-text">ุงูุนููุงุก ุงููุณุฌููู</span>
          </div>
          <div class="nav-item" data-tab="linked">
            <span class="nav-item-icon">๐</span>
            <span class="nav-item-text">ุงูุนููุงุก ุงููุฑุจูุทูู</span>
          </div>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">ุงููุงููุฉ</div>
          <div class="nav-item" data-tab="salary">
            <span class="nav-item-icon">๐ฐ</span>
            <span class="nav-item-text">ุงูุฑูุงุชุจ</span>
          </div>
          <div class="nav-item" data-tab="usage">
            <span class="nav-item-icon">๐</span>
            <span class="nav-item-text">ุงูุงุณุชููุงู</span>
          </div>
        </div>
      </nav>

      <div class="sidebar-footer">
        <a href="/" class="back-home">
          <span>โ</span>
          <span>ุงูุนูุฏุฉ ูููุญุฉ ุงูุฑุฆูุณูุฉ</span>
        </a>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <header class="top-header">
        <div style="display: flex; align-items: center; gap: 16px;">
          <button class="mobile-menu-btn" onclick="toggleSidebar()">โฐ</button>
          <h1 class="page-title" id="pageTitle">โ๏ธ ุฅุนุฏุงุฏุงุช AI</h1>
        </div>
        <div class="header-actions">
          <span style="color: #64748b; font-size: 0.85rem;">ุงูุฅุตุฏุงุฑ 2.0</span>
        </div>
      </header>

      <div class="content-area">
        <div id="alertContainer"></div>

        <div class="ai-container">

    <!-- Settings Tab -->
    <div id="settings" class="tab-content active">
      <div class="ai-card">
        <h2>ุฅุนุฏุงุฏุงุช ุงูุฐูุงุก ุงูุงุตุทูุงุนู</h2>

        <div class="form-group">
          <div class="toggle-container">
            <label class="toggle">
              <input type="checkbox" id="aiEnabled">
              <span class="toggle-slider"></span>
            </label>
            <span style="color: #fff;">ุชูุนูู AI Agent</span>
          </div>
        </div>

        <div class="form-group">
          <label>ูุฒูุฏ ุงูุฐูุงุก ุงูุงุตุทูุงุนู</label>
          <select id="aiProvider" onchange="toggleProviderSettings()">
            <option value="openai">OpenAI</option>
            <option value="openrouter">OpenRouter.ai (500+ ููุฏูู)</option>
          </select>
        </div>

        <!-- OpenAI Settings -->
        <div id="openaiSettings">
          <div class="form-group">
            <label>OpenAI API Key</label>
            <input type="password" id="openaiKey" placeholder="sk-...">
          </div>

          <div class="row">
            <div class="form-group">
              <label>ููุฏูู ุงููุญุงุฏุซุฉ (Chat)</label>
              <select id="modelChat">
                <option value="gpt-4o-mini">GPT-4o Mini (ุฃุฑุฎุต)</option>
                <option value="gpt-4o">GPT-4o (ูุชูุงุฒู)</option>
                <option value="gpt-4-turbo">GPT-4 Turbo</option>
                <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
              </select>
            </div>
            <div class="form-group">
              <label>ููุฏูู ุชุญููู ุงูุตูุช ููุต (STT)</label>
              <select id="modelStt">
                <option value="whisper-1">Whisper-1</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div class="form-group">
              <label>ููุฏูู ุชุญููู ุงููุต ูุตูุช (TTS)</label>
              <select id="modelTts">
                <option value="tts-1">TTS-1 (ุณุฑูุน)</option>
                <option value="tts-1-hd">TTS-1 HD (ุฌูุฏุฉ ุนุงููุฉ)</option>
              </select>
            </div>
            <div class="form-group">
              <label>ุตูุช TTS</label>
              <select id="voiceTts">
                <option value="alloy">Alloy</option>
                <option value="echo">Echo</option>
                <option value="fable">Fable</option>
                <option value="onyx">Onyx</option>
                <option value="nova">Nova</option>
                <option value="shimmer">Shimmer</option>
              </select>
            </div>
          </div>
        </div>

        <!-- OpenRouter Settings -->
        <div id="openrouterSettings" style="display: none;">
          <div class="form-group">
            <label>OpenRouter API Key</label>
            <input type="password" id="openrouterKey" placeholder="sk-or-...">
            <small style="color: #64748b; display: block; margin-top: 4px;">
              ุงุญุตู ุนูู ููุชุงุญู ูู <a href="https://openrouter.ai/keys" target="_blank" style="color: #3b82f6;">openrouter.ai/keys</a>
            </small>
          </div>

          <div class="form-group">
            <label>ููุฏูู ุงููุญุงุฏุซุฉ</label>
            <select id="openrouterModel">
              <optgroup label="๐ข OpenAI">
                <option value="openai/gpt-4o-mini">GPT-4o Mini - ุณุฑูุน ูุฑุฎูุต</option>
                <option value="openai/gpt-4o">GPT-4o - ูุชูุงุฒู</option>
                <option value="openai/gpt-4-turbo">GPT-4 Turbo</option>
                <option value="openai/o1-mini">O1 Mini - ุชูููุฑ ูุชูุฏู</option>
                <option value="openai/o1-preview">O1 Preview - ุชูููุฑ ุนููู</option>
              </optgroup>
              <optgroup label="๐ฃ Anthropic">
                <option value="anthropic/claude-3.5-sonnet">Claude 3.5 Sonnet - ุงูุฃูุถู</option>
                <option value="anthropic/claude-3-opus">Claude 3 Opus - ุงูุฃููู</option>
                <option value="anthropic/claude-3-haiku">Claude 3 Haiku - ุณุฑูุน</option>
              </optgroup>
              <optgroup label="๐ต Google">
                <option value="google/gemini-pro-1.5">Gemini Pro 1.5</option>
                <option value="google/gemini-flash-1.5">Gemini Flash 1.5 - ุณุฑูุน</option>
                <option value="google/gemini-2.0-flash-exp">Gemini 2.0 Flash</option>
              </optgroup>
              <optgroup label="๐ก Meta Llama">
                <option value="meta-llama/llama-3.1-70b-instruct">Llama 3.1 70B</option>
                <option value="meta-llama/llama-3.1-405b-instruct">Llama 3.1 405B - ุงูุฃูุจุฑ</option>
                <option value="meta-llama/llama-3.2-90b-vision-instruct">Llama 3.2 90B Vision</option>
              </optgroup>
              <optgroup label="๐ด Mistral">
                <option value="mistralai/mistral-large">Mistral Large</option>
                <option value="mistralai/mistral-medium">Mistral Medium</option>
                <option value="mistralai/mixtral-8x22b-instruct">Mixtral 8x22B</option>
              </optgroup>
              <optgroup label="โซ DeepSeek">
                <option value="deepseek/deepseek-chat">DeepSeek Chat - ุฑุฎูุต ุฌุฏุงู</option>
                <option value="deepseek/deepseek-r1">DeepSeek R1 - ุชูููุฑ</option>
              </optgroup>
              <optgroup label="๐ Qwen">
                <option value="qwen/qwen-2.5-72b-instruct">Qwen 2.5 72B</option>
                <option value="qwen/qwen-2.5-coder-32b-instruct">Qwen 2.5 Coder 32B</option>
              </optgroup>
              <optgroup label="โช ูุฌุงูู">
                <option value="meta-llama/llama-3.2-3b-instruct:free">Llama 3.2 3B (ูุฌุงูู)</option>
                <option value="google/gemma-2-9b-it:free">Gemma 2 9B (ูุฌุงูู)</option>
                <option value="mistralai/mistral-7b-instruct:free">Mistral 7B (ูุฌุงูู)</option>
              </optgroup>
            </select>
          </div>

          <div class="form-group" style="background: rgba(59, 130, 246, 0.1); padding: 12px; border-radius: 8px; border: 1px solid rgba(59, 130, 246, 0.2);">
            <p style="margin: 0; font-size: 0.85rem; color: #94a3b8;">
              ๐ก <strong>OpenRouter</strong> ูููุฑ ูุตููุงู ูุฃูุซุฑ ูู 500 ููุฏูู ูู ูุฒูุฏูู ูุฎุชูููู ุจู API ูุงุญุฏ.
              <br>ููููู ุฑุคูุฉ ูู ุงูููุฏููุงุช ูุงูุฃุณุนุงุฑ ุนูู <a href="https://openrouter.ai/models" target="_blank" style="color: #3b82f6;">openrouter.ai/models</a>
            </p>
          </div>
        </div>

        <div class="row">
          <div class="form-group">
            <label>ูุฏุฉ ุงูุฌูุณุฉ ุงูููุซููุฉ (ุฏูุงุฆู)</label>
            <input type="number" id="trustedSessionMinutes" min="1" max="1440" value="15">
          </div>
          <div class="form-group">
            <label>ูุณุจุฉ ุงูููุงูุฉ ุงูุงูุชุฑุงุถูุฉ (%)</label>
            <input type="number" id="agencyPercent" min="0" max="100" step="0.1" value="0">
          </div>
        </div>
      </div>

      <!-- New Personality Settings Card -->
      <div class="ai-card">
        <h2>๐ญ ุฅุนุฏุงุฏุงุช ุดุฎุตูุฉ ุงูุจูุช</h2>

        <div class="row">
          <div class="form-group">
            <label>ุงุณู ุงูุจูุช</label>
            <input type="text" id="botName" placeholder="ูุณุงุนุฏ ุฃุจู ุณูุทุงู">
          </div>
          <div class="form-group">
            <label>ุงุณู ุตุงุญุจ ุงูุนูู</label>
            <input type="text" id="ownerName" placeholder="ุฃุจู ุณูุทุงู">
          </div>
        </div>

        <div class="row">
          <div class="form-group">
            <label>ุงูููุฌุฉ</label>
            <select id="dialect">
              <option value="ุณูุฑูุฉ">๐ธ๐พ ุณูุฑูุฉ</option>
              <option value="ุฎููุฌูุฉ">๐ธ๐ฆ ุฎููุฌูุฉ</option>
              <option value="ูุตุฑูุฉ">๐ช๐ฌ ูุตุฑูุฉ</option>
              <option value="ูุตุญู">๐ ูุตุญู</option>
            </select>
          </div>
          <div class="form-group">
            <label>ุตูุบุฉ ุงููุฎุงุทุจุฉ</label>
            <select id="clientGender">
              <option value="ูุคูุซ">๐ฉ ูุคูุซ (ุญุจูุจุชูุ ุงุจุนุชููู)</option>
              <option value="ูุฐูุฑ">๐จ ูุฐูุฑ (ุญุจูุจูุ ุงุจุนุชูู)</option>
              <option value="ูุญุงูุฏ">โช ูุญุงูุฏ</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div class="form-group">
            <label>ูุณุชูู ุงููุฏูุฉ</label>
            <select id="friendliness">
              <option value="ุนุงูู">๐ ุนุงูู (ุฅูููุฌู + ููุงู ูุฏูุฏ)</option>
              <option value="ูุชูุณุท">๐ ูุชูุณุท (ูุทูู)</option>
              <option value="ุฑุณูู">๐ ุฑุณูู (ุจุฏูู ุฅูููุฌู)</option>
            </select>
          </div>
          <div class="form-group">
            <label>ุนููุฉ ุงูุฑุงุชุจ</label>
            <input type="text" id="salaryCurrency" placeholder="ุฑ.ุณ">
          </div>
        </div>

        <div class="row">
          <div class="form-group">
            <label>ุฑุณุงูุฉ ุงูุชูุงุตู ูุน ุงูุฅุฏุงุฑุฉ</label>
            <input type="text" id="adminContact" placeholder="ุชูุงุตูู ูุน ุงูุฅุฏุงุฑุฉ">
          </div>
          <div class="form-group">
            <div class="toggle-container" style="margin-top: 28px;">
              <label class="toggle">
                <input type="checkbox" id="enableVoiceReplies">
                <span class="toggle-slider"></span>
              </label>
              <span style="color: #fff;">ุงูุฑุฏ ุตูุชูุงู ุนูู ุงูุฑุณุงุฆู ุงูุตูุชูุฉ</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Google Sheet Auto Sync -->
      <div class="ai-card">
        <h2>๐ ุงููุฒุงููุฉ ุงูุชููุงุฆูุฉ ูู Google Sheet</h2>
        
        <div class="form-group">
          <div class="toggle-container">
            <label class="toggle">
              <input type="checkbox" id="googleSheetAutoSync" onchange="toggleAutoSyncSettings()">
              <span class="toggle-slider"></span>
            </label>
            <span style="color: #fff;">ุชูุนูู ุงููุฒุงููุฉ ุงูุชููุงุฆูุฉ</span>
          </div>
        </div>

        <div id="autoSyncSettings" style="display: none;">
          <div class="form-group">
            <label>ุฑุงุจุท Google Sheet</label>
            <input type="text" id="googleSheetUrlAuto" placeholder="https://docs.google.com/spreadsheets/d/...">
            <small style="color: #64748b; display: block; margin-top: 4px;">
              โ๏ธ ุชุฃูุฏ ุฃู ุงูููู ูุดุงุฑู ูู "ุฃู ุดุฎุต ูุฏูู ุงูุฑุงุจุท ููููู ุงูุนุฑุถ"
            </small>
          </div>

          <div class="row">
            <div class="form-group">
              <label>ุงุณู ุงููุฑูุฉ (ุงุฎุชูุงุฑู)</label>
              <input type="text" id="googleSheetNameAuto" placeholder="Sheet1">
            </div>
            <div class="form-group">
              <label>ูุชุฑุฉ ุงููุฒุงููุฉ</label>
              <select id="googleSheetSyncInterval">
                <option value="1">ูู ุฏูููุฉ</option>
                <option value="5" selected>ูู 5 ุฏูุงุฆู</option>
                <option value="10">ูู 10 ุฏูุงุฆู</option>
                <option value="15">ูู 15 ุฏูููุฉ</option>
                <option value="30">ูู 30 ุฏูููุฉ</option>
                <option value="60">ูู ุณุงุนุฉ</option>
              </select>
            </div>
          </div>

          <div id="syncStatus" style="background: rgba(15, 23, 42, 0.5); padding: 16px; border-radius: 10px; margin-top: 16px;">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
              <div>
                <p style="margin: 0 0 4px 0; color: #94a3b8; font-size: 0.85rem;">ุญุงูุฉ ุงููุฒุงููุฉ:</p>
                <p id="syncStatusText" style="margin: 0; color: #fff; font-weight: 600;">ุบูุฑ ููุนููุฉ</p>
              </div>
              <div>
                <p style="margin: 0 0 4px 0; color: #94a3b8; font-size: 0.85rem;">ุขุฎุฑ ูุฒุงููุฉ:</p>
                <p id="lastSyncTime" style="margin: 0; color: #fff; font-weight: 600;">-</p>
              </div>
              <button class="btn btn-secondary" onclick="triggerManualSync()" style="padding: 8px 16px;">
                ๐ ูุฒุงููุฉ ุงูุขู
              </button>
            </div>
          </div>
        </div>
      </div>

        <button class="btn btn-primary" id="saveSettingsBtn">๐พ ุญูุธ ุงูุฅุนุฏุงุฏุงุช</button>
      </div>
    </div>



    <!-- Custom Fields Tab -->
    <div id="fields" class="tab-content">
      <div class="ai-card">
        <h2>ุฅุถุงูุฉ ุญูู ุฌุฏูุฏ</h2>

        <div class="row">
          <div class="form-group">
            <label>ุงุณู ุงูุญูู *</label>
            <input type="text" id="fieldName" placeholder="ูุซุงู: ุฑูู ุงูุฅูุงูุฉ">
          </div>
          <div class="form-group">
            <label>ููุน ุงูุญูู</label>
            <select id="fieldType">
              <option value="text">ูุต</option>
              <option value="dropdown">ูุงุฆูุฉ ููุณุฏูุฉ</option>
              <option value="number">ุฑูู</option>
              <option value="date">ุชุงุฑูุฎ</option>
            </select>
          </div>
          <div class="form-group">
            <label>ูุทููุจ</label>
            <select id="fieldRequired">
              <option value="false">ูุง</option>
              <option value="true">ูุนู</option>
            </select>
          </div>
        </div>

        <div id="dropdownOptionsSection" style="display: none;">
          <div class="form-group">
            <label>ุฎูุงุฑุงุช ุงููุงุฆูุฉ ุงูููุณุฏูุฉ</label>
            <p style="color: #a0a0b0; font-size: 0.8rem; margin-bottom: 12px;">ููู ุฎูุงุฑุ ููููู ุฅุถุงูุฉ ุญูู ูุฑุนู (ูุซู:
              ูุญูุธุฉ ุฅููุชุฑูููุฉ โ ุนููุงู ุงููุญูุธุฉ)</p>
            <div id="dropdownOptionsInputs">
              <div class="option-row"
                style="display: flex; gap: 8px; margin-bottom: 12px; align-items: flex-start; flex-wrap: wrap;">
                <input type="text" class="dropdown-option-value" placeholder="ุงุณู ุงูุฎูุงุฑ"
                  style="flex: 2; min-width: 150px;">
                <select class="dropdown-option-subtype" style="flex: 1; min-width: 100px;">
                  <option value="">ุจุฏูู ุญูู ูุฑุนู</option>
                  <option value="text">ูุต</option>
                  <option value="number">ุฑูู</option>
                  <option value="date">ุชุงุฑูุฎ</option>
                </select>
                <input type="text" class="dropdown-option-sublabel" placeholder="ุนููุงู ุงูุญูู ุงููุฑุนู"
                  style="flex: 2; min-width: 150px; display: none;">
              </div>
            </div>
            <button type="button" class="btn btn-secondary" style="padding: 6px 12px; font-size: 0.8rem;"
              onclick="addDropdownOptionInputWithSubField()">+ ุฅุถุงูุฉ ุฎูุงุฑ</button>
          </div>
        </div>

        <button class="btn btn-primary" id="addFieldBtn">โ ุฅุถุงูุฉ ุงูุญูู</button>
        <button class="btn btn-danger" id="cancelEditBtn" style="display: none; margin-right: 8px;"
          onclick="cancelEdit()">ุฅูุบุงุก</button>
      </div>

      <div class="ai-card">
        <h2>ุงูุญููู ุงููุฎุตุตุฉ</h2>
        <button class="btn btn-secondary" id="refreshFieldsBtn" style="margin-bottom: 16px;">๐ ุชุญุฏูุซ</button>
        <div id="fieldsList">
          <p style="color: #666; text-align: center;">ูุง ุชูุฌุฏ ุญููู ูุฎุตุตุฉ</p>
        </div>
      </div>
    </div>

    <!-- Registered Clients Tab -->
    <div id="registered" class="tab-content">
      <div class="ai-card">
        <h2>ุฅุถุงูุฉ ุนููู ุฌุฏูุฏ</h2>

        <div class="row">
          <div class="form-group">
            <label>ุฑูู ุงูู ID *</label>
            <div id="regIdsContainer">
              <div class="input-group" style="margin-bottom: 5px; display: flex; gap: 5px;">
                <input type="text" name="regClientId" placeholder="ูุซุงู: 7099026" style="flex: 1;">
              </div>
            </div>
            <button class="btn btn-secondary" style="padding: 2px 8px; font-size: 0.8rem; margin-top: 5px;"
              onclick="addIdField()">โ ุฅุถุงูุฉ ID ุขุฎุฑ</button>
          </div>
          <div class="form-group">
            <label>ุงูุงุณู ุงููุงูู *</label>
            <input type="text" id="regFullName" placeholder="ุงูุงุณู ุงูุซูุงุซู">
          </div>
        </div>

        <div class="row">
          <div class="form-group">
            <label>๐ฑ ุฑูู ูุงุชุณุงุจ (ููุจูุช)</label>
            <input type="text" id="regWhatsapp" placeholder="ูุซุงู: 963935990348">
            <small style="color: #64748b; font-size: 0.75rem;">ุงูุฑูู ุงูุฐู ุณูุชูุงุตู ูุนู ุงูุจูุช</small>
          </div>
          <div class="form-group">
            <label>๐ ุฑูู ุงูุงุชุตุงู</label>
            <input type="text" id="regPhone" placeholder="ูุซุงู: 00963935990348">
            <small style="color: #64748b; font-size: 0.75rem;">ุฑูู ููุชูุงุตู ุงูุนุงุฏู (ุงุฎุชูุงุฑู)</small>
          </div>
          <div class="form-group">
            <label>ุงูููุงูุฉ <a href="#" onclick="promptManageLookups('agency'); return false;"
                style="font-size: 0.8rem;">(ุฅุฏุงุฑุฉ)</a></label>
            <select id="regAgency">
              <option value="">ุงุฎุชุฑ ุงูููุงูุฉ...</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div class="form-group">
            <label>ุงูุฏููุฉ <a href="#" onclick="promptManageLookups('country'); return false;"
                style="font-size: 0.8rem;">(ุฅุฏุงุฑุฉ)</a></label>
            <select id="regCountry" onchange="renderCityOptions()">
              <option value="">ุงุฎุชุฑ ุงูุฏููุฉ...</option>
            </select>
          </div>
          <div class="form-group">
            <label>ุงููุฏููุฉ <a href="#" onclick="promptManageLookups('city'); return false;"
                style="font-size: 0.8rem;">(ุฅุฏุงุฑุฉ)</a></label>
            <select id="regCity">
              <option value="">ุงุฎุชุฑ ุงูุฏููุฉ ุฃููุงู...</option>
            </select>
          </div>
          <div class="form-group">
            <label>ุงูุนููุงู ุงูุชูุตููู</label>
            <input type="text" id="regAddress" placeholder="ุงูุนููุงู">
          </div>
        </div>

        <!-- Custom Fields Container -->
        <div id="customFieldsContainer" class="row"></div>

        <button class="btn btn-primary" id="addRegClientBtn">โ ุฅุถุงูุฉ ุงูุนููู</button>
        <button class="btn btn-secondary" id="clearRegFormBtn">ูุณุญ</button>
      </div>

      <div class="ai-card">
        <h2>ุงูุนููุงุก ุงููุณุฌููู</h2>
        <div class="row" style="margin-bottom: 16px; align-items: center; gap: 10px;">

          <div class="row" style="margin-bottom: 16px; align-items: center; gap: 10px; flex-wrap: wrap;">
            <button class="btn btn-secondary" id="refreshRegClientsBtn">๐ ุชุญุฏูุซ</button>
            <button class="btn btn-primary" onclick="promptBroadcast()" style="background: #8b5cf6;">๐ข ุฅุฑุณุงู
              ุฌูุงุนู</button>
            <button class="btn btn-primary" onclick="sendSalaryToAll()" style="background: #10b981;">๐ฐ ุฅุฑุณุงู
              ุงูุฑูุงุชุจ</button>

            <span style="border-left: 1px solid #444; height: 24px; margin: 0 4px;"></span>

            <button class="btn btn-secondary" onclick="exportClients()" style="padding: 8px 16px;">๐ค ุชุตุฏูุฑ
              (Excel)</button>
            <button class="btn btn-secondary" onclick="downloadTemplate()" style="padding: 8px 16px;">๐ ุชุญููู
              ุงููุงูุจ</button>
            <button class="btn btn-secondary" onclick="document.getElementById('importClientsFile').click()"
              style="padding: 8px 16px;">๐ฅ ุงุณุชูุฑุงุฏ CSV</button>
            <input type="file" id="importClientsFile" accept=".csv" style="display: none;"
              onchange="importClients(this)">
            <button class="btn btn-secondary" onclick="showGoogleSheetModal()" style="padding: 8px 16px; background: #34a853;">
              <span style="color: #fff;">๐ Google Sheet</span>
            </button>

            <span id="regClientCount" style="color: #a0a0b0; margin-right: 16px;"></span>
          </div>
        </div>

        <!-- Google Sheet Modal -->
        <div id="googleSheetModal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 1000; display: none; align-items: center; justify-content: center;">
          <div style="background: #1e293b; border-radius: 16px; padding: 24px; max-width: 600px; width: 90%; border: 1px solid rgba(255,255,255,0.1);">
            <h3 style="margin: 0 0 20px 0; color: #fff; display: flex; align-items: center; gap: 10px;">
              <span style="font-size: 28px;">๐</span> ุงุณุชูุฑุงุฏ ูู Google Sheet
            </h3>
            
            <div class="form-group">
              <label>ุฑุงุจุท Google Sheet</label>
              <input type="text" id="googleSheetUrl" placeholder="https://docs.google.com/spreadsheets/d/...">
              <small style="color: #64748b; display: block; margin-top: 8px;">
                โ๏ธ ุชุฃูุฏ ุฃู ุงูููู ูุดุงุฑู ูู "ุฃู ุดุฎุต ูุฏูู ุงูุฑุงุจุท ููููู ุงูุนุฑุถ"
              </small>
            </div>

            <div class="form-group">
              <label>ุงุณู ุงููุฑูุฉ (ุงุฎุชูุงุฑู)</label>
              <input type="text" id="googleSheetName" placeholder="Sheet1">
              <small style="color: #64748b; display: block; margin-top: 8px;">
                ุงุชุฑูู ูุงุฑุบุงู ูุงุณุชุฎุฏุงู ุงููุฑูุฉ ุงูุฃููู
              </small>
            </div>

            <div style="background: rgba(59, 130, 246, 0.1); padding: 16px; border-radius: 10px; margin-bottom: 20px; border: 1px solid rgba(59, 130, 246, 0.2);">
              <p style="margin: 0 0 8px 0; font-weight: 600; color: #3b82f6;">๐ ุงูุฃุนูุฏุฉ ุงููุทููุจุฉ:</p>
              <p style="margin: 0 0 12px 0; font-size: 0.85rem; color: #94a3b8;">
                id, fullName, phone, country, city, address, agencyName
              </p>
              <p style="margin: 0 0 8px 0; font-weight: 600; color: #22c55e;">๐ ุฃุนูุฏุฉ ุฅุถุงููุฉ (ุงุฎุชูุงุฑูุฉ):</p>
              <p style="margin: 0; font-size: 0.85rem; color: #94a3b8;">
                paymentMethod (ุทุฑููุฉ ุงูุงุณุชูุงู), paymentInfo (ูุนูููุงุช ุงูุงุณุชูุงู), currency (ุงูุนููุฉ), notes (ููุงุญุธุงุช)
              </p>
            </div>

            <div style="display: flex; gap: 12px; justify-content: flex-end;">
              <button class="btn btn-secondary" onclick="hideGoogleSheetModal()">ุฅูุบุงุก</button>
              <button class="btn btn-primary" onclick="importFromGoogleSheet()" id="importGoogleSheetBtn">
                ๐ฅ ุงุณุชูุฑุงุฏ
              </button>
            </div>
          </div>
        </div>

        <!-- Receipts Modal -->
        <div id="receiptsModal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center;">
          <div style="background: #1e293b; border-radius: 16px; padding: 24px; max-width: 700px; width: 95%; max-height: 90vh; overflow-y: auto; border: 1px solid rgba(255,255,255,0.1);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
              <h3 id="receiptsModalTitle" style="margin: 0; color: #fff;">๐งพ ุฅูุตุงูุงุช ุงูุนููู</h3>
              <button onclick="closeReceiptsModal()" style="background: transparent; border: none; color: #fff; font-size: 24px; cursor: pointer;">&times;</button>
            </div>
            
            <!-- Upload Section -->
            <div style="background: rgba(236, 72, 153, 0.1); padding: 16px; border-radius: 12px; margin-bottom: 20px; border: 1px solid rgba(236, 72, 153, 0.2);">
              <h4 style="margin: 0 0 12px 0; color: #ec4899;">๐ค ุฑูุน ุฅูุตุงู ุฌุฏูุฏ</h4>
              <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: flex-end;">
                <div style="flex: 1; min-width: 200px;">
                  <label style="display: block; margin-bottom: 6px; font-size: 0.85rem; color: #888;">ุงุฎุชุฑ ููู</label>
                  <input type="file" id="receiptFile" style="width: 100%; padding: 8px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; color: white;">
                </div>
                <div style="flex: 1; min-width: 150px;">
                  <label style="display: block; margin-bottom: 6px; font-size: 0.85rem; color: #888;">ููุงุญุธุฉ (ุงุฎุชูุงุฑู)</label>
                  <input type="text" id="receiptDescription" placeholder="ูุซุงู: ุฑุงุชุจ ุดูุฑ ููุงูุฑ" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; color: white;">
                </div>
                <button id="uploadReceiptBtn" onclick="uploadReceipt()" class="btn btn-primary" style="padding: 10px 20px; background: #ec4899; white-space: nowrap;">๐ค ุฑูุน</button>
              </div>
              <small style="color: #888; display: block; margin-top: 8px;">โ ุณูุชู ุฅุฑุณุงู ุฅุดุนุงุฑ ุชููุงุฆู ููุนููู ุนูู ุงููุงุชุณุงุจ</small>
            </div>

            <!-- Receipts List -->
            <div>
              <h4 style="margin: 0 0 12px 0; color: #fff;">๐ ุงูุฅูุตุงูุงุช ุงููุฑููุนุฉ</h4>
              <div id="receiptsList" style="min-height: 100px;">
                <div style="text-align: center; padding: 20px; color: #888;">ุฌุงุฑู ุงูุชุญููู...</div>
              </div>
            </div>
          </div>
        </div>

        <div style="margin-bottom: 16px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
          <input type="text" id="searchRegClientInput" placeholder="๐ ุจุญุซ ุนู ุนููู (ุงูุงุณูุ ุงููุงุชูุ ID)..."
            style="flex: 1; min-width: 200px; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 4px; color: white;">
          <button class="btn btn-primary" style="background: #8b5cf6; padding: 10px 15px; white-space: nowrap;" onclick="sendPortalLinksToAll()">
            ๐ค ุฅุฑุณุงู ุฑูุงุจุท ุงูุจูุงุจุฉ ููู ุนููุงุก Main
          </button>
          <button class="btn btn-danger" style="padding: 10px 15px; white-space: nowrap; display: none;" id="deleteSelectedBtn" onclick="deleteSelectedClients()">
            ๐๏ธ ุญุฐู ุงููุญุฏุฏ (<span id="selectedCount">0</span>)
          </button>
        </div>
        <div style="overflow-x: auto;">
          <table class="clients-table">
            <thead>
              <tr>
                <th style="width: 40px;"><input type="checkbox" id="selectAllClients" onchange="toggleSelectAll(this)"></th>
                <th>ID</th>
                <th>ุงูุงุณู</th>
                <th>๐ฑ ูุงุชุณุงุจ</th>
                <th>๐ ุงุชุตุงู</th>
                <th>ุงููุฏููุฉ</th>
                <th>ุงูููุงูุฉ</th>
                <th>ุฅุฌุฑุงุกุงุช</th>
              </tr>
            </thead>
            <tbody id="regClientsBody">
              <tr>
                <td colspan="9" style="text-align: center; color: #666;">ูุง ููุฌุฏ ุนููุงุก ูุณุฌููู</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Salary Tab (Old) -->

  <!-- Salary Tab -->
  <div id="salary" class="tab-content">
    <div class="ai-card">
      <h2>ุฑูุน ููู ุงูุฑูุงุชุจ</h2>

      <div class="file-upload" id="fileUploadArea">
        <input type="file" id="salaryFile" accept=".csv,.xlsx,.xls">
        <div class="file-upload-icon">๐</div>
        <p style="color: #a0a0b0; margin: 0;">ุงุณุญุจ ููู CSV ููุง ุฃู ุงููุฑ ููุงุฎุชูุงุฑ</p>
        <p style="color: #666; font-size: 0.85rem; margin-top: 8px;">ุงูุญุฏ ุงูุฃูุตู: 10MB</p>
      </div>

      <div id="filePreview" style="display: none; margin-top: 20px;">
        <h3 style="color: #fff; margin-bottom: 16px;">ูุนุงููุฉ ุงูููู</h3>

        <div class="row">
          <div class="form-group">
            <label>ุงุณู ุงููุณู (Period)</label>
            <input type="text" id="periodName" placeholder="ูุซุงู: 1-15 ููุงูุฑ 2024">
          </div>
          <div class="form-group">
            <label>ุนููุฏ ID</label>
            <select id="idColumn"></select>
          </div>
        </div>

        <div class="row">
          <div class="form-group">
            <label>ุนููุฏ ุงูุฑุงุชุจ</label>
            <select id="salaryColumn"></select>
          </div>
          <div class="form-group">
            <label>ูุณุจุฉ ุงูููุงูุฉ (%)</label>
            <input type="number" id="uploadAgencyPercent" min="0" max="100" step="0.1" value="0">
          </div>
        </div>

        <div id="previewTable" style="overflow-x: auto; margin: 16px 0;"></div>

        <p style="color: #a0a0b0; font-size: 0.9rem;" id="rowCount"></p>

        <button class="btn btn-primary" id="uploadBtn">๐ค ุฑูุน ูุชุฃููุฏ</button>
        <button class="btn btn-secondary" id="cancelUploadBtn">ุฅูุบุงุก</button>
      </div>
    </div>

    <div class="ai-card">
      <h2>ุงูุฃูุณุงู ุงููุฑููุนุฉ</h2>
      <div class="periods-list" id="periodsList">
        <p style="color: #666; text-align: center;">ูุง ุชูุฌุฏ ุฃูุณุงู ูุฑููุนุฉ</p>
      </div>
    </div>
  </div>

  <!-- Usage Tab -->
  <div id="usage" class="tab-content">
    <div class="ai-card">
      <h2>ููุฎุต ุงูุงุณุชููุงู</h2>
      <div class="stats-grid" id="usageStats">
        <div class="stat-card">
          <div class="stat-value" id="totalChats">0</div>
          <div class="stat-label">ุฑุณุงุฆู Chat</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="totalStt">0</div>
          <div class="stat-label">ุชุญููู ุตูุชโูุต</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="totalTts">0</div>
          <div class="stat-label">ุชุญููู ูุตโุตูุช</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="totalTokens">0</div>
          <div class="stat-label">ุฅุฌูุงูู Tokens</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="estimatedCost">$0</div>
          <div class="stat-label">ุงูุชูููุฉ ุงูุชูุฏูุฑูุฉ</div>
        </div>
      </div>

      <div style="margin-top: 16px;">
        <button class="btn btn-secondary" id="refreshUsageBtn">๐ ุชุญุฏูุซ</button>
        <button class="btn btn-danger" id="resetUsageBtn">๐๏ธ ุฅุนุงุฏุฉ ุชุนููู</button>
      </div>
    </div>

    <div class="ai-card">
      <h2>ุณุฌู ุงูุนูููุงุช (ุขุฎุฑ 100)</h2>
      <div class="usage-log" id="usageLog">
        <p style="color: #666; text-align: center;">ูุง ุชูุฌุฏ ุนูููุงุช ูุณุฌูุฉ</p>
      </div>
    </div>
  </div>

  <!-- Linked Clients Tab -->
  <div id="linked" class="tab-content">
    <div class="ai-card">
      <h2>ุงูุนููุงุก ุงููุฑุจูุทูู ุจูุงุชุณุงุจ</h2>
      <div style="margin-bottom: 16px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
        <button class="btn btn-secondary" id="refreshLinkedClientsBtn">๐ ุชุญุฏูุซ</button>
        <button class="btn btn-danger" style="display: none;" id="deleteSelectedLinkedBtn" onclick="deleteSelectedLinkedClients()">
          ๐๏ธ ุญุฐู ุงููุญุฏุฏ (<span id="selectedLinkedCount">0</span>)
        </button>
      </div>
      <div style="overflow-x: auto;">
        <table class="clients-table" id="linkedClientsTable">
          <thead>
            <tr>
              <th style="width: 40px;"><input type="checkbox" id="selectAllLinked" onchange="toggleSelectAllLinked(this)"></th>
              <th>WhatsApp ID</th>
              <th>ุงูุงุณู</th>
              <th>ุงููุฏููุฉ</th>
              <th>ุงูููุงูุฉ</th>
              <th>ID ูุฑุจูุท</th>
              <th>ุงูุญุงูุฉ</th>
              <th>ุฅุฌุฑุงุกุงุช</th>
            </tr>
          </thead>
          <tbody id="linkedClientsBody">
            <tr>
              <td colspan="8" style="text-align: center; color: #666;">ูุง ููุฌุฏ ุนููุงุก ูุฑุจูุทูู</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
  </div>

  <script>
    // Tab switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(tab.dataset.tab).classList.add('active');
      });
    });

    // Alert helper
    function showAlert(message, type = 'success') {
      const container = document.getElementById('alertContainer');
      container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
      setTimeout(() => container.innerHTML = '', 5000);
    }

    // Cookie helper
    function getCookie(name) {
      const match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
      if (match) return match[2];
      return null;
    }

    // API helper
    async function api(method, url, data = null) {
      const options = { method, credentials: 'include' };
      if (data && !(data instanceof FormData)) {
        options.headers = { 'Content-Type': 'application/json' };
        options.body = JSON.stringify(data);
      } else if (data) {
        options.body = data;
      }
      const res = await fetch(url, options);
      const json = await res.json();
      if (!res.ok) throw new Error(json.error || 'Unknown error');
      return json;
    }

    // Load settings
    async function loadSettings() {
      try {
        const settings = await api('GET', '/api/ai/settings');
        document.getElementById('aiEnabled').checked = settings.enabled;
        document.getElementById('openaiKey').value = settings.openaiKey || '';
        document.getElementById('modelChat').value = settings.modelChat || 'gpt-4o-mini';
        document.getElementById('modelStt').value = settings.modelStt || 'whisper-1';
        document.getElementById('modelTts').value = settings.modelTts || 'tts-1';
        document.getElementById('voiceTts').value = settings.voiceTts || 'alloy';
        document.getElementById('trustedSessionMinutes').value = settings.trustedSessionMinutes || 15;
        document.getElementById('agencyPercent').value = settings.agencyPercent || 0;
        
        // New personality settings
        document.getElementById('botName').value = settings.botName || 'ูุณุงุนุฏ ุฃุจู ุณูุทุงู';
        document.getElementById('ownerName').value = settings.ownerName || 'ุฃุจู ุณูุทุงู';
        document.getElementById('dialect').value = settings.dialect || 'ุณูุฑูุฉ';
        document.getElementById('clientGender').value = settings.clientGender || 'ูุคูุซ';
        document.getElementById('friendliness').value = settings.friendliness || 'ุนุงูู';
        document.getElementById('salaryCurrency').value = settings.salaryCurrency || 'ุฑ.ุณ';
        document.getElementById('adminContact').value = settings.adminContact || 'ุชูุงุตูู ูุน ุงูุฅุฏุงุฑุฉ';
        document.getElementById('enableVoiceReplies').checked = settings.enableVoiceReplies || false;
      } catch (err) {
        showAlert('ูุดู ุชุญููู ุงูุฅุนุฏุงุฏุงุช: ' + err.message, 'error');
      }
    }

    // Save settings
    document.getElementById('saveSettingsBtn').addEventListener('click', async () => {
      try {
        const data = {
          enabled: document.getElementById('aiEnabled').checked,
          modelChat: document.getElementById('modelChat').value,
          modelStt: document.getElementById('modelStt').value,
          modelTts: document.getElementById('modelTts').value,
          voiceTts: document.getElementById('voiceTts').value,
          trustedSessionMinutes: parseInt(document.getElementById('trustedSessionMinutes').value) || 15,
          agencyPercent: parseFloat(document.getElementById('agencyPercent').value) || 0,
          
          // New personality settings
          botName: document.getElementById('botName').value || 'ูุณุงุนุฏ ุฃุจู ุณูุทุงู',
          ownerName: document.getElementById('ownerName').value || 'ุฃุจู ุณูุทุงู',
          dialect: document.getElementById('dialect').value || 'ุณูุฑูุฉ',
          clientGender: document.getElementById('clientGender').value || 'ูุคูุซ',
          friendliness: document.getElementById('friendliness').value || 'ุนุงูู',
          salaryCurrency: document.getElementById('salaryCurrency').value || 'ุฑ.ุณ',
          adminContact: document.getElementById('adminContact').value || 'ุชูุงุตูู ูุน ุงูุฅุฏุงุฑุฉ',
          enableVoiceReplies: document.getElementById('enableVoiceReplies').checked
        };

        const keyInput = document.getElementById('openaiKey').value;
        if (keyInput && !keyInput.includes('โข')) {
          data.openaiKey = keyInput;
        }

        await api('POST', '/api/ai/settings', data);
        showAlert('ุชู ุญูุธ ุงูุฅุนุฏุงุฏุงุช ุจูุฌุงุญ โ');
      } catch (err) {
        showAlert('ูุดู ุญูุธ ุงูุฅุนุฏุงุฏุงุช: ' + err.message, 'error');
      }
    });

    // File upload
    const fileUploadArea = document.getElementById('fileUploadArea');
    const salaryFileInput = document.getElementById('salaryFile');
    let uploadedFileData = null;

    fileUploadArea.addEventListener('click', () => salaryFileInput.click());
    fileUploadArea.addEventListener('dragover', e => { e.preventDefault(); fileUploadArea.classList.add('dragover'); });
    fileUploadArea.addEventListener('dragleave', () => fileUploadArea.classList.remove('dragover'));
    fileUploadArea.addEventListener('drop', e => {
      e.preventDefault();
      fileUploadArea.classList.remove('dragover');
      if (e.dataTransfer.files.length) {
        salaryFileInput.files = e.dataTransfer.files;
        handleFileSelect(e.dataTransfer.files[0]);
      }
    });

    salaryFileInput.addEventListener('change', e => {
      if (e.target.files.length) handleFileSelect(e.target.files[0]);
    });

    async function handleFileSelect(file) {
      try {
        const formData = new FormData();
        formData.append('file', file);

        const preview = await api('POST', '/api/ai/salary/upload/preview', formData);
        uploadedFileData = { file, preview };

        // Populate column selects
        const idCol = document.getElementById('idColumn');
        const salaryCol = document.getElementById('salaryColumn');
        idCol.innerHTML = '';
        salaryCol.innerHTML = '';

        preview.columns.forEach(col => {
          idCol.innerHTML += `<option value="${col}">${col}</option>`;
          salaryCol.innerHTML += `<option value="${col}">${col}</option>`;
        });

        // Try to auto-detect columns
        const idGuess = preview.columns.find(c => c.toLowerCase().includes('id'));
        const salaryGuess = preview.columns.find(c => c.toLowerCase().includes('salary') || c.toLowerCase().includes('ุฑุงุชุจ'));
        if (idGuess) idCol.value = idGuess;
        if (salaryGuess) salaryCol.value = salaryGuess;

        // Show preview table
        let tableHtml = '<table class="clients-table"><thead><tr>';
        preview.columns.forEach(col => tableHtml += `<th>${col}</th>`);
        tableHtml += '</tr></thead><tbody>';
        preview.sampleRows.forEach(row => {
          tableHtml += '<tr>';
          preview.columns.forEach(col => tableHtml += `<td>${row[col] || ''}</td>`);
          tableHtml += '</tr>';
        });
        tableHtml += '</tbody></table>';
        document.getElementById('previewTable').innerHTML = tableHtml;
        document.getElementById('rowCount').textContent = `ุฅุฌูุงูู ุงูุตููู: ${preview.totalRows}`;

        document.getElementById('filePreview').style.display = 'block';
        fileUploadArea.style.display = 'none';

      } catch (err) {
        showAlert('ูุดู ูุฑุงุกุฉ ุงูููู: ' + err.message, 'error');
      }
    }

    document.getElementById('cancelUploadBtn').addEventListener('click', () => {
      document.getElementById('filePreview').style.display = 'none';
      fileUploadArea.style.display = 'block';
      uploadedFileData = null;
      salaryFileInput.value = '';
    });

    document.getElementById('uploadBtn').addEventListener('click', async () => {
      if (!uploadedFileData) return;

      const periodName = document.getElementById('periodName').value.trim();
      if (!periodName) {
        showAlert('ูุฑุฌู ุฅุฏุฎุงู ุงุณู ุงููุณู', 'error');
        return;
      }

      try {
        const formData = new FormData();
        formData.append('file', uploadedFileData.file);
        formData.append('name', periodName);
        formData.append('idColumn', document.getElementById('idColumn').value);
        formData.append('salaryColumn', document.getElementById('salaryColumn').value);
        formData.append('agencyPercent', document.getElementById('uploadAgencyPercent').value || 0);

        await api('POST', '/api/ai/salary/upload', formData);
        showAlert('ุชู ุฑูุน ุงููุณู ุจูุฌุงุญ');

        document.getElementById('filePreview').style.display = 'none';
        fileUploadArea.style.display = 'block';
        uploadedFileData = null;
        salaryFileInput.value = '';
        document.getElementById('periodName').value = '';

        loadPeriods();

      } catch (err) {
        showAlert('ูุดู ุงูุฑูุน: ' + err.message, 'error');
      }
    });

    // Load periods
    async function loadPeriods() {
      try {
        const periods = await api('GET', '/api/ai/salary/periods');
        const container = document.getElementById('periodsList');

        if (!periods.length) {
          container.innerHTML = '<p style="color: #666; text-align: center;">ูุง ุชูุฌุฏ ุฃูุณุงู ูุฑููุนุฉ</p>';
          return;
        }

        container.innerHTML = periods.map(p => `
          <div class="period-item">
            <div class="period-info">
              <h4>${p.name} ${p.isCurrent ? '<span class="period-badge">ุงูุญุงูู</span>' : ''}</h4>
              <span>${p.recordCount} ุณุฌู โข ุฑูุน: ${new Date(p.uploadedAt).toLocaleDateString('ar')} โข ูุณุจุฉ: ${p.agencyPercent}%</span>
            </div>
            <div>
              ${!p.isCurrent ? `<button class="btn btn-secondary btn-sm" onclick="setCurrentPeriod('${p.id}')">ุชุนููู ูุญุงูู</button>` : ''}
              <button class="btn btn-danger btn-sm" onclick="deletePeriod('${p.id}')">ุญุฐู</button>
            </div>
          </div>
        `).join('');

      } catch (err) {
        showAlert('ูุดู ุชุญููู ุงูุฃูุณุงู: ' + err.message, 'error');
      }
    }

    window.setCurrentPeriod = async (id) => {
      try {
        await api('POST', `/api/ai/salary/period/${id}/current`);
        showAlert('ุชู ุชุนููู ุงููุณู ูุญุงูู');
        loadPeriods();
      } catch (err) {
        showAlert('ูุดู: ' + err.message, 'error');
      }
    };

    window.deletePeriod = async (id) => {
      if (!confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐุง ุงููุณูุ')) return;
      try {
        await api('DELETE', `/api/ai/salary/period/${id}`);
        showAlert('ุชู ุญุฐู ุงููุณู');
        loadPeriods();
      } catch (err) {
        showAlert('ูุดู ุงูุญุฐู: ' + err.message, 'error');
      }
    };

    // Load usage
    async function loadUsage() {
      try {
        const summary = await api('GET', '/api/ai/usage');
        document.getElementById('totalChats').textContent = summary.totalChatCalls || 0;
        document.getElementById('totalStt').textContent = summary.totalSttCalls || 0;
        document.getElementById('totalTts').textContent = summary.totalTtsCalls || 0;
        document.getElementById('totalTokens').textContent = (summary.totalInputTokens + summary.totalOutputTokens) || 0;
        document.getElementById('estimatedCost').textContent = '$' + (summary.estimatedCost || 0).toFixed(4);

        const log = await api('GET', '/api/ai/usage/log');
        const logContainer = document.getElementById('usageLog');

        if (!log.length) {
          logContainer.innerHTML = '<p style="color: #666; text-align: center;">ูุง ุชูุฌุฏ ุนูููุงุช ูุณุฌูุฉ</p>';
          return;
        }

        logContainer.innerHTML = log.reverse().map(entry => `
          <div class="log-entry">
            <span class="log-type ${entry.type}">${entry.type}</span>
            <span class="log-details">
              ${entry.type === 'CHAT' ? `${entry.inputTokens}+${entry.outputTokens} tokens` : ''}
              ${entry.type === 'STT' ? `${entry.durationSeconds?.toFixed(1)}s` : ''}
              ${entry.type === 'TTS' ? `${entry.characterCount} chars` : ''}
              โข ${entry.model}
            </span>
            <span class="log-cost">$${entry.cost?.toFixed(4) || 0}</span>
            <span style="color: #666; font-size: 0.8rem;">${new Date(entry.time).toLocaleString('ar')}</span>
          </div>
        `).join('');

      } catch (err) {
        showAlert('ูุดู ุชุญููู ุงูุงุณุชููุงู: ' + err.message, 'error');
      }
    }

    document.getElementById('refreshUsageBtn').addEventListener('click', loadUsage);
    document.getElementById('resetUsageBtn').addEventListener('click', async () => {
      if (!confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุฅุนุงุฏุฉ ุชุนููู ุฅุญุตุงุฆูุงุช ุงูุงุณุชููุงูุ')) return;
      try {
        await api('POST', '/api/ai/usage/reset');
        showAlert('ุชู ุฅุนุงุฏุฉ ุชุนููู ุงูุงุณุชููุงู');
        loadUsage();
      } catch (err) {
        showAlert('ูุดู: ' + err.message, 'error');
      }
    });

    // Load clients
    async function loadClients() {
      try {
        const clients = await api('GET', '/api/ai/clients');
        const tbody = document.getElementById('clientsBody');

        const clientsArray = Object.values(clients);
        if (!clientsArray.length) {
          tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #666;">ูุง ููุฌุฏ ุนููุงุก</td></tr>';
          return;
        }

        tbody.innerHTML = clientsArray.map(c => `
          <tr>
            <td style="font-family: monospace; font-size: 0.85rem;">${c.whatsappId}</td>
            <td>${c.profile?.fullName || '-'}</td>
            <td>${c.profile?.city || '-'}</td>
            <td>${c.profile?.agencyName || '-'}</td>
            <td>${c.profile?.ids?.join(', ') || '-'}</td>
            <td><span class="status-badge status-${c.status}">${c.status === 'complete' ? 'ููุชูู' : 'ุบูุฑ ููุชูู'}</span></td>
            <td>${c.createdAt ? new Date(c.createdAt).toLocaleDateString('ar') : '-'}</td>
          </tr>
        `).join('');

      } catch (err) {
        showAlert('ูุดู ุชุญููู ุงูุนููุงุก: ' + err.message, 'error');
      }
    }

    document.getElementById('refreshLinkedClientsBtn').addEventListener('click', loadLinkedClients);

    // =====================================================
    // Registered Clients Management
    // =====================================================

    async function loadRegisteredClients() {
      try {
        const clients = await api('GET', '/api/ai/registered-clients');
        const tbody = document.getElementById('regClientsBody');
        const countEl = document.getElementById('regClientCount');

        const clientsArray = Object.values(clients);
        countEl.textContent = `ุฅุฌูุงูู: ${clientsArray.length} ุนููู`;

        renderClientsList(clientsArray);

      } catch (err) {
        showAlert('ูุดู ุชุญููู ุงูุนููุงุก: ' + err.message, 'error');
      }
    }

    document.getElementById('refreshRegClientsBtn').addEventListener('click', loadRegisteredClients);

    document.getElementById('addRegClientBtn').addEventListener('click', async () => {
      // Gather inputs first to avoid errors
      const fullName = document.getElementById('regFullName').value.trim();
      const whatsappPhone = document.getElementById('regWhatsapp').value.trim();
      const phone = document.getElementById('regPhone').value.trim();
      const agencyName = document.getElementById('regAgency').value.trim();
      const country = document.getElementById('regCountry').value.trim();
      const city = document.getElementById('regCity').value.trim();
      const address = document.getElementById('regAddress').value.trim();

      if (!fullName) {
        showAlert('ุงูุงุณู ุงููุงูู ูุทููุจ', 'error');
        return;
      }

      // Parse IDs from dynamic fields
      const ids = [];
      document.querySelectorAll('input[name="regClientId"]').forEach(input => {
        const val = input.value.trim();
        if (val) ids.push(val);
      });

      if (ids.length === 0) {
        showAlert('ูุฌุจ ุฅุฏุฎุงู ID ูุงุญุฏ ุนูู ุงูุฃูู', 'error');
        return;
      }

      // Collect Custom Fields
      const customFields = {};
      const customFieldInputs = document.querySelectorAll('#customFieldsContainer input, #customFieldsContainer select');

      customFieldInputs.forEach(input => {
        // Skip sub-field inputs here, we handle them with their parent
        if (input.classList.contains('sub-field-input')) return;

        if (input.id.startsWith('customField_')) {
          const key = input.id.replace('customField_', '');
          const value = input.value.trim() || null;

          if (value) {
            customFields[key] = value;

            // Check for sub-field value if this is a dropdown
            if (input.tagName === 'SELECT') {
              const subInput = document.getElementById(`${input.id}_sub`);
              if (subInput && subInput.offsetParent !== null) { // Check if visible
                const subKey = `${key}__sub`;
                customFields[subKey] = subInput.value.trim() || null;
              }
            }
          }
        }
      });

      try {
        if (editingRegClientKey) {
          // Update Mode
          const data = {
            ids,
            fullName, phone, whatsappPhone, agencyName, country, city, address, customFields
          };
          await api('PUT', `/api/ai/registered-clients/${editingRegClientKey}`, data);
          showAlert('ุชู ุชุญุฏูุซ ุงูุนููู ุจูุฌุงุญ');
          editingRegClientKey = null;
          document.getElementById('addRegClientBtn').innerHTML = 'โ ุฅุถุงูุฉ ุงูุนููู';
          document.getElementById('addRegClientBtn').classList.remove('btn-success');
          document.getElementById('addRegClientBtn').classList.add('btn-primary');
        } else {
          // Create Mode
          const data = {
            ids,
            fullName, phone, whatsappPhone, agencyName, country, city, address, customFields
          };
          await api('POST', '/api/ai/registered-clients', data);
          showAlert('ุชู ุฅุถุงูุฉ ุงูุนููู ุจูุฌุงุญ');
        }

        clearRegForm();
        loadRegisteredClients();

      } catch (err) {
        showAlert('ูุดู ุงูุนูููุฉ: ' + err.message, 'error');
      }
    });

    document.getElementById('clearRegFormBtn').addEventListener('click', clearRegForm);

    function clearRegForm() {
      // Reset IDs container to single empty input
      document.getElementById('regIdsContainer').innerHTML = `
           <div class="input-group" style="margin-bottom: 5px; display: flex; gap: 5px;">
              <input type="text" name="regClientId" placeholder="ูุซุงู: 7099026" style="flex: 1;">
           </div>
      `;

      document.getElementById('regFullName').value = '';
      document.getElementById('regWhatsapp').value = '';
      document.getElementById('regPhone').value = '';
      document.getElementById('regAgency').value = '';
      document.getElementById('regCountry').value = '';
      document.getElementById('regCity').value = '';
      document.getElementById('regAddress').value = '';

      document.querySelectorAll('#customFieldsContainer input, #customFieldsContainer select').forEach(i => {
        if (i.tagName === 'SELECT') {
          i.selectedIndex = 0;
        } else {
          i.value = '';
        }
      });

      // Hide all sub fields
      document.querySelectorAll('[id$="_subFieldContainer"]').forEach(el => {
        el.style.display = 'none';
        el.innerHTML = '';
      });

      // Reset Edit Mode
      editingRegClientKey = null;
      const btn = document.getElementById('addRegClientBtn');
      btn.innerHTML = 'โ ุฅุถุงูุฉ ุงูุนููู';
      btn.classList.remove('btn-success');
      btn.classList.add('btn-primary');
    }

    window.deleteRegClient = async (key) => {
      if (!confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐุง ุงูุนูููุ')) return;
      try {
        await api('DELETE', `/api/ai/registered-clients/${key}`);
        showAlert('ุชู ุญุฐู ุงูุนููู');
        loadRegisteredClients();
      } catch (err) {
        showAlert('ูุดู ุงูุญุฐู: ' + err.message, 'error');
      }
    };

    window.promptAddId = async (key) => {
      const newId = prompt('ุฃุฏุฎู ุฑูู ุงูู ID ุงูุฌุฏูุฏ:');
      if (!newId || !newId.trim()) return;

      try {
        await api('POST', '/api/ai/registered-clients/${key}/add-id', { newId: newId.trim() });
        showAlert('ุชู ุฅุถุงูุฉ ุงูู ID ุจูุฌุงุญ');
        loadRegisteredClients();
      } catch (err) {
        showAlert('ูุดู ุฅุถุงูุฉ ุงูู ID: ' + err.message, 'error');
      }
    };

    // Reset Client PIN
    window.resetClientPin = async (clientKey, clientName) => {
      if (!confirm(`ูู ุชุฑูุฏ ุชุฌุฏูุฏ ุฑูุฒ PIN ููุนููู "${clientName}"ุ\n\nุณูุชู ุฅุฑุณุงู ุงูุฑูุฒ ุงูุฌุฏูุฏ ุนุจุฑ ูุงุชุณุงุจ.`)) return;
      
      try {
        const result = await api('POST', `/api/admin/clients/${clientKey}/reset-pin`);
        
        if (result.warning) {
          // WhatsApp failed but PIN was generated
          showAlert(`โ๏ธ ${result.warning}\n\nุงูุฑูุฒ ุงูุฌุฏูุฏ: ${result.newPin}`, 'error');
        } else {
          showAlert(`โ ุชู ุชุฌุฏูุฏ PIN ููุนููู ${result.clientName} ูุฅุฑุณุงู ุฑุณุงูุฉ ูุงุชุณุงุจ ุจูุฌุงุญ`);
        }
      } catch (err) {
        showAlert('โ ูุดู ุชุฌุฏูุฏ PIN: ' + err.message, 'error');
      }
    };

    // Generate Portal Link
    window.generatePortalLink = async (clientKey, clientName) => {
      try {
        const result = await api('POST', `/api/admin/portal/generate/${clientKey}`);
        const fullUrl = window.location.origin + result.url;
        
        // Copy to clipboard
        await navigator.clipboard.writeText(fullUrl);
        
        showAlert(`โ ุฑุงุจุท ุงูุจูุงุจุฉ ููุนููู "${clientName}":\n\n${fullUrl}\n\n๐ ุชู ูุณุฎ ุงูุฑุงุจุท!`);
      } catch (err) {
        showAlert('โ ูุดู ุฅูุดุงุก ุงูุฑุงุจุท: ' + err.message, 'error');
      }
    };

    // Send Portal Links to All Main Agency Clients
    window.sendPortalLinksToAll = async () => {
      if (!confirm('ูู ุชุฑูุฏ ุฅุฑุณุงู ุฑูุงุจุท ุงูุจูุงุจุฉ ููู ุนููุงุก ุงูููุงูุฉ ุงูุฑุฆูุณูุฉ (Main)?\n\nุณูุชู ุฅุฑุณุงู ุฑุณุงูุฉ ูุงุชุณุงุจ ููู ุนููู ูุฏูู ุฑูู ูุงุชู.')) return;
      
      try {
        showAlert('โณ ุฌุงุฑู ุฅุฑุณุงู ุงูุฑูุงุจุท...');
        const result = await api('POST', '/api/admin/portal/send-all');
        
        showAlert(`โ ุชู ุงูุฅุฑุณุงู!\n\n๐ค ุฃูุฑุณู: ${result.results.sent}\nโ ูุดู: ${result.results.failed}\nโญ๏ธ ุชุฎุทู: ${result.results.skipped}`);
      } catch (err) {
        showAlert('โ ูุดู ุงูุฅุฑุณุงู: ' + err.message, 'error');
      }
    };

    // =====================================================
    // Linked Clients (WhatsApp linked users)
    // =====================================================

    async function loadLinkedClients() {
      try {
        const clients = await api('GET', '/api/ai/clients');
        const tbody = document.getElementById('linkedClientsBody');

        const clientsArray = Object.values(clients);
        
        // Reset select all checkbox
        document.getElementById('selectAllLinked').checked = false;
        updateLinkedDeleteButton();
        
        if (!clientsArray.length) {
          tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #666;">ูุง ููุฌุฏ ุนููุงุก ูุฑุจูุทูู</td></tr>';
          return;
        }

        tbody.innerHTML = clientsArray.map(c => `
          <tr data-whatsapp-id="${c.whatsappId}">
            <td><input type="checkbox" class="linked-checkbox" data-whatsapp-id="${c.whatsappId}" onchange="updateLinkedDeleteButton()"></td>
            <td style="font-family: monospace; font-size: 0.85rem;">${c.whatsappId}</td>
            <td>${c.profile?.fullName || '-'}</td>
            <td>${c.profile?.city || '-'}</td>
            <td>${c.profile?.agencyName || '-'}</td>
            <td>${c.linkedClientId || c.profile?.ids?.join(', ') || '-'}</td>
            <td><span class="status-badge status-${c.status}">${c.status === 'complete' ? 'ูุฑุจูุท' : 'ููุฏ ุงูุฑุจุท'}</span></td>
            <td>
              <button class="btn btn-danger" style="padding: 4px 8px; font-size: 0.8rem;" onclick="deleteLinkedClient('${c.whatsappId}')">๐๏ธ</button>
            </td>
          </tr>
        `).join('');

      } catch (err) {
        showAlert('ูุดู ุชุญููู ุงูุนููุงุก ุงููุฑุจูุทูู: ' + err.message, 'error');
      }
    }

    // Toggle select all linked checkboxes
    window.toggleSelectAllLinked = (checkbox) => {
      const checkboxes = document.querySelectorAll('.linked-checkbox');
      checkboxes.forEach(cb => cb.checked = checkbox.checked);
      updateLinkedDeleteButton();
    };

    // Update linked delete button visibility and count
    window.updateLinkedDeleteButton = () => {
      const checkboxes = document.querySelectorAll('.linked-checkbox:checked');
      const count = checkboxes.length;
      const btn = document.getElementById('deleteSelectedLinkedBtn');
      const countEl = document.getElementById('selectedLinkedCount');
      
      if (count > 0) {
        btn.style.display = 'inline-block';
        countEl.textContent = count;
      } else {
        btn.style.display = 'none';
      }
    };

    // Delete single linked client
    window.deleteLinkedClient = async (whatsappId) => {
      if (!confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐุง ุงูุนููู ุงููุฑุจูุทุ')) return;
      
      try {
        await api('DELETE', `/api/ai/clients/${encodeURIComponent(whatsappId)}`);
        showAlert('ุชู ุญุฐู ุงูุนููู ุงููุฑุจูุท ุจูุฌุงุญ ๐๏ธ');
        loadLinkedClients();
      } catch (err) {
        showAlert('ูุดู ุงูุญุฐู: ' + err.message, 'error');
      }
    };

    // Delete selected linked clients
    window.deleteSelectedLinkedClients = async () => {
      const checkboxes = document.querySelectorAll('.linked-checkbox:checked');
      const ids = Array.from(checkboxes).map(cb => cb.dataset.whatsappId);
      
      if (ids.length === 0) {
        showAlert('ูู ูุชู ุชุญุฏูุฏ ุฃู ุนููู', 'error');
        return;
      }
      
      if (!confirm(`ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ${ids.length} ุนููู ูุฑุจูุทุ\n\nโ๏ธ ูุง ูููู ุงูุชุฑุงุฌุน ุนู ูุฐุง ุงูุฅุฌุฑุงุก!`)) return;
      
      try {
        const result = await api('POST', '/api/ai/clients/bulk-delete', { ids });
        showAlert(`โ ุชู ุญุฐู ${result.deleted} ุนููู${result.failed > 0 ? `\nโ ูุดู ุญุฐู ${result.failed}` : ''}`);
        loadLinkedClients();
      } catch (err) {
        showAlert('โ ูุดู ุงูุญุฐู: ' + err.message, 'error');
      }
    };

    // =====================================================
    // Custom Fields Management
    // =====================================================

    // Toggle dropdown options visibility
    document.getElementById('fieldType').addEventListener('change', function () {
      document.getElementById('dropdownOptionsSection').style.display =
        this.value === 'dropdown' ? 'block' : 'none';
    });

    async function loadCustomFields() {
      try {
        const fields = await api('GET', '/api/ai/custom-fields');
        const container = document.getElementById('fieldsList');

        if (!fields.length) {
          container.innerHTML = '<p style="color: #666; text-align: center;">ูุง ุชูุฌุฏ ุญููู ูุฎุตุตุฉ</p>';
          return;
        }

        container.innerHTML = fields.map(f => `
          <div class="period-item">
            <div class="period-info">
              <h4>${f.name} <span class="period-badge">${f.type}</span> ${f.required ? '<span style="color: #dc2626;">*</span>' : ''}</h4>
              <span>${f.type === 'dropdown' ? 'ุงูุฎูุงุฑุงุช: ' + (f.options?.join(', ') || 'ูุง ููุฌุฏ') : ''}</span>
            </div>
            <div>
              ${f.type === 'dropdown' ? `<button class="btn btn-secondary" style="padding: 6px 12px; font-size: 0.8rem;" onclick="promptAddOption('${f.id}')">+ ุฎูุงุฑ</button>` : ''}
              <button class="btn btn-danger" style="padding: 6px 12px; font-size: 0.8rem;" onclick="deleteField('${f.id}')">ุญุฐู</button>
            </div>
          </div>
        `).join('');

      } catch (err) {
        showAlert('ูุดู ุชุญููู ุงูุญููู: ' + err.message, 'error');
      }
    }

    // State for editing
    let editingFieldId = null;

    document.getElementById('refreshFieldsBtn').addEventListener('click', loadCustomFields);

    // Cancel edit mode
    function cancelEdit() {
      editingFieldId = null;
      document.getElementById('addFieldBtn').innerHTML = 'โ ุฅุถุงูุฉ ุงูุญูู';
      document.getElementById('cancelEditBtn').style.display = 'none';
      document.getElementById('fieldName').value = '';
      document.getElementById('fieldType').value = 'text';
      document.getElementById('fieldRequired').value = 'false';
      document.getElementById('fieldType').disabled = false; // Allow changing type only when adding
      document.getElementById('dropdownOptionsSection').style.display = 'none';
      document.getElementById('dropdownOptionsInputs').innerHTML = `
        <div class="option-row" style="display: flex; gap: 8px; margin-bottom: 12px; align-items: flex-start; flex-wrap: wrap;">
          <input type="text" class="dropdown-option-value" placeholder="ุงุณู ุงูุฎูุงุฑ" style="flex: 2; min-width: 150px;">
          <select class="dropdown-option-subtype" style="flex: 1; min-width: 100px;" onchange="this.nextElementSibling.style.display = this.value ? 'block' : 'none'">
            <option value="">ุจุฏูู ุญูู ูุฑุนู</option>
            <option value="text">ูุต</option>
            <option value="number">ุฑูู</option>
            <option value="date">ุชุงุฑูุฎ</option>
          </select>
          <input type="text" class="dropdown-option-sublabel" placeholder="ุนููุงู ุงูุญูู ุงููุฑุนู" style="flex: 2; min-width: 150px; display: none;">
        </div>
      `;
      document.querySelector('.ai-card h2').textContent = 'ุฅุถุงูุฉ ุญูู ุฌุฏูุฏ';
    }

    // Add dropdown option input field with sub-field support
    window.addDropdownOptionInputWithSubField = function (value = '', subType = '', subLabel = '') {
      const container = document.getElementById('dropdownOptionsInputs');
      const div = document.createElement('div');
      div.className = 'option-row';
      div.style.cssText = 'display: flex; gap: 8px; margin-bottom: 12px; align-items: flex-start; flex-wrap: wrap;';

      const subDisplay = subType ? 'block' : 'none';

      div.innerHTML = `
        <input type="text" class="dropdown-option-value" placeholder="ุงุณู ุงูุฎูุงุฑ" value="${value}" style="flex: 2; min-width: 150px;">
        <select class="dropdown-option-subtype" style="flex: 1; min-width: 100px;" onchange="this.nextElementSibling.style.display = this.value ? 'block' : 'none'">
          <option value="" ${subType === '' ? 'selected' : ''}>ุจุฏูู ุญูู ูุฑุนู</option>
          <option value="text" ${subType === 'text' ? 'selected' : ''}>ูุต</option>
          <option value="number" ${subType === 'number' ? 'selected' : ''}>ุฑูู</option>
          <option value="date" ${subType === 'date' ? 'selected' : ''}>ุชุงุฑูุฎ</option>
        </select>
        <input type="text" class="dropdown-option-sublabel" placeholder="ุนููุงู ุงูุญูู ุงููุฑุนู" value="${subLabel}" style="flex: 2; min-width: 150px; display: ${subDisplay};">
        <button type="button" class="btn btn-danger" style="padding: 6px 12px;" onclick="this.parentElement.remove()">โ</button>
      `;
      container.appendChild(div);
    };

    // Edit field
    window.editField = function (id) {
      // Lookup by ID since cache uses key
      const f = window.customFieldsCache[id];

      if (!f) return;

      editingFieldId = id;

      // Update UI
      document.querySelector('.ai-card h2').textContent = 'ุชุนุฏูู ุงูุญูู: ' + f.name;
      document.getElementById('addFieldBtn').innerHTML = '๐พ ุญูุธ ุงูุชุนุฏููุงุช';
      document.getElementById('cancelEditBtn').style.display = 'inline-block';

      // Set values
      document.getElementById('fieldName').value = f.name;
      document.getElementById('fieldType').value = f.type;
      document.getElementById('fieldRequired').value = f.required.toString();

      // Type cannot be changed during edit to avoid data inconsistency
      document.getElementById('fieldType').disabled = true;

      // Handle dropdown options
      const dropdownSection = document.getElementById('dropdownOptionsSection');
      const dropdownInputs = document.getElementById('dropdownOptionsInputs');

      if (f.type === 'dropdown') {
        dropdownSection.style.display = 'block';
        dropdownInputs.innerHTML = ''; // Clear existing inputs

        f.options.forEach(opt => {
          let val = opt;
          let subType = '';
          let subLabel = '';

          if (typeof opt === 'object') {
            val = opt.value;
            if (opt.subField) {
              subType = opt.subField.type;
              subLabel = opt.subField.label;
            }
          }

          addDropdownOptionInputWithSubField(val, subType, subLabel);
        });
      } else {
        dropdownSection.style.display = 'none';
      }

      // Scroll to form
      document.querySelector('.ai-card').scrollIntoView({ behavior: 'smooth' });
    };

    document.getElementById('addFieldBtn').addEventListener('click', async () => {
      const name = document.getElementById('fieldName').value.trim();
      const type = document.getElementById('fieldType').value;
      const required = document.getElementById('fieldRequired').value === 'true';

      // Get dropdown options from inputs
      let options = [];
      let validationError = null;

      if (type === 'dropdown') {
        const rows = document.querySelectorAll('#dropdownOptionsInputs .option-row');
        rows.forEach(row => {
          const value = row.querySelector('.dropdown-option-value').value.trim();
          const subType = row.querySelector('.dropdown-option-subtype').value;
          const subLabel = row.querySelector('.dropdown-option-sublabel').value.trim();

          if (value) {
            if (subType) {
              if (!subLabel) {
                validationError = `ุงูุฑุฌุงุก ูุชุงุจุฉ ุนููุงู ุงูุญูู ุงููุฑุนู ููุฎูุงุฑ "${value}"`;
                return;
              }
              options.push({
                value: value,
                subField: { type: subType, label: subLabel }
              });
            } else {
              options.push(value);
            }
          }
        });
      }

      if (validationError) {
        showAlert(validationError, 'error');
        return;
      }

      if (!name) {
        showAlert('ุงุณู ุงูุญูู ูุทููุจ', 'error');
        return;
      }

      if (type === 'dropdown' && options.length === 0) {
        showAlert('ูุฌุจ ุฅุถุงูุฉ ุฎูุงุฑ ูุงุญุฏ ุนูู ุงูุฃูู ูููุงุฆูุฉ ุงูููุณุฏูุฉ', 'error');
        return;
      }

      try {
        if (editingFieldId) {
          // Update existing field
          await api('PUT', `/api/ai/custom-fields/${editingFieldId}`, { name, required, options });
          showAlert('ุชู ุชุญุฏูุซ ุงูุญูู ุจูุฌุงุญ');
          cancelEdit(); // Reset mode
        } else {
          // Create new field
          await api('POST', '/api/ai/custom-fields', { name, type, required, options });
          showAlert('ุชู ุฅุถุงูุฉ ุงูุญูู ุจูุฌุงุญ');

          // Clear inputs
          document.getElementById('fieldName').value = '';
          document.getElementById('fieldType').value = 'text';
          document.getElementById('dropdownOptionsSection').style.display = 'none';
          document.getElementById('dropdownOptionsInputs').innerHTML = `
            <div class="option-row" style="display: flex; gap: 8px; margin-bottom: 12px; align-items: flex-start; flex-wrap: wrap;">
              <input type="text" class="dropdown-option-value" placeholder="ุงุณู ุงูุฎูุงุฑ" style="flex: 2; min-width: 150px;">
              <select class="dropdown-option-subtype" style="flex: 1; min-width: 100px;" onchange="this.nextElementSibling.style.display = this.value ? 'block' : 'none'">
                <option value="">ุจุฏูู ุญูู ูุฑุนู</option>
                <option value="text">ูุต</option>
                <option value="number">ุฑูู</option>
                <option value="date">ุชุงุฑูุฎ</option>
              </select>
              <input type="text" class="dropdown-option-sublabel" placeholder="ุนููุงู ุงูุญูู ุงููุฑุนู" style="flex: 2; min-width: 150px; display: none;">
            </div>
          `;
        }

        loadCustomFields();
        renderCustomFieldsInForm();
      } catch (err) {
        showAlert('ูุดู ุงูุนูููุฉ: ' + err.message, 'error');
      }
    });

    // Store fields data globally to avoid HTML attribute escaping issues
    window.customFieldsCache = {};
    window.customFieldsCacheByKey = {}; // Also store by key for easier lookup in form rendering

    // Render custom fields in client registration form
    async function renderCustomFieldsInForm() {
      try {
        const fields = await api('GET', '/api/ai/custom-fields');
        const container = document.getElementById('customFieldsContainer');

        // Update cache
        window.customFieldsCache = {}; // Clear previous cache
        window.customFieldsCacheByKey = {}; // New cache for lookup by key
        fields.forEach(f => {
          window.customFieldsCache[f.id] = f; // Cache by ID
          window.customFieldsCacheByKey[f.key] = f; // Cache by key
        });

        if (!fields.length) {
          container.innerHTML = '';
          return;
        }

        container.innerHTML = fields.map(f => {
          let inputHtml = '';
          const fieldId = `customField_${f.key}`;

          if (f.type === 'dropdown') {
            inputHtml = `
              <select id="${fieldId}" onchange="handleDropdownSubField(this, '${f.key}')">
                <option value="">ุงุฎุชุฑ...</option>
                ${f.options.map(o => {
              const val = typeof o === 'object' ? o.value : o;
              return `<option value="${val}">${val}</option>`;
            }).join('')}
              </select>
              <div id="${fieldId}_subFieldContainer" style="margin-top: 8px; display: none; padding: 8px; background: rgba(255,255,255,0.05); border-radius: 4px;">
                <!-- Sub field will be injected here -->
              </div>
            `;
          } else if (f.type === 'date') {
            inputHtml = `<input type="date" id="${fieldId}">`;
          } else if (f.type === 'number') {
            inputHtml = `<input type="number" id="${fieldId}">`;
          } else {
            inputHtml = `<input type="text" id="${fieldId}" placeholder="${f.name}">`;
          }

          return `
            <div class="field-group" style="margin-bottom: 12px;">
               <label style="display: block; margin-bottom: 4px; color: #a0a0b0;">${f.name} ${f.required ? '<span style="color: #ef4444">*</span>' : ''}</label>
               ${inputHtml}
            </div>
          `;
        }).join('');

      } catch (err) {
        console.error('Failed to render custom fields', err);
      }
    }

    // Lookups Logic
    async function loadLookups() {
      try {
        const data = await api('GET', '/api/ai/lookups');
        // Store lookups if needed, or just populate (but we don't have lookup dropdowns in add form YET, only input text)
        // Wait, the plan was to replace inputs with dropdowns? "update Dashboard: Selects".
        // The user code seems to rely on simple inputs still or I missed the selects update.
        // Effectively, if the inputs are IDs "agency", "country", "city", we can try to populate them if they are selects.
        // Let's check if elements are selects.

        const agencySelect = document.getElementById('agency');
        if (agencySelect && agencySelect.tagName === 'SELECT') {
          agencySelect.innerHTML = '<option value="">ุงุฎุชุฑ ุงูููุงูุฉ...</option>' +
            data.agencies.map(a => `<option value="${a}">${a}</option>`).join('');
        }

        const countrySelect = document.getElementById('country');
        if (countrySelect && countrySelect.tagName === 'SELECT') {
          countrySelect.innerHTML = '<option value="">ุงุฎุชุฑ ุงูุฏููุฉ...</option>' +
            Object.keys(data.countries).map(c => `<option value="${c}">${c}</option>`).join('');

          // City logic
          countrySelect.onchange = () => {
            const citySelect = document.getElementById('city');
            if (citySelect) {
              const cities = data.countries[countrySelect.value] || [];
              citySelect.innerHTML = '<option value="">ุงุฎุชุฑ ุงููุฏููุฉ...</option>' +
                cities.map(c => `<option value="${c}">${c}</option>`).join('');
            }
          };
        }

      } catch (err) {
        console.error('Failed to load lookups', err);
      }
    }


    // Load custom fields for management
    async function loadCustomFields() {
      try {
        const fields = await api('GET', '/api/ai/custom-fields');
        const container = document.getElementById('fieldsList');
        container.innerHTML = fields.map(f => `
          <div class="period-item">
            <div class="period-info">
              <h4>${f.name} <span class="period-badge">${f.type}</span> ${f.required ? '<span style="color: #dc2626;">*</span>' : ''}</h4>
              <span>${f.type === 'dropdown' ? 'ุงูุฎูุงุฑุงุช: ' + (f.options?.map(o => typeof o === 'object' ? o.value : o).join(', ') || 'ูุง ููุฌุฏ') : ''}</span>
            </div>
            <div>
              ${f.type === 'dropdown' ? `<button class="btn btn-secondary" style="padding: 6px 12px; font-size: 0.8rem;" onclick="promptAddOption('${f.id}')">+ ุฎูุงุฑ</button>` : ''}
              <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 0.8rem; background: #3b82f6;" onclick="editField('${f.id}')">ุชุนุฏูู</button>
              <button class="btn btn-danger" style="padding: 6px 12px; font-size: 0.8rem;" onclick="deleteField('${f.id}')">ุญุฐู</button>
            </div>
          </div>
        `).join('');

      } catch (err) {
        showAlert('ูุดู ุชุญููู ุงูุญููู: ' + err.message, 'error');
      }
    }

    // Handle showing/hiding sub-fields for dropdowns
    window.handleDropdownSubField = function (selectEl, fieldKey) {
      const field = window.customFieldsCacheByKey[fieldKey];
      if (!field) return;

      const selectedValue = selectEl.value;
      const subContainer = document.getElementById(`${selectEl.id}_subFieldContainer`);

      const selectedOption = field.options.find(o => (typeof o === 'object' ? o.value : o) === selectedValue);

      if (selectedOption && typeof selectedOption === 'object' && selectedOption.subField) {
        const sf = selectedOption.subField;
        const subId = `${selectEl.id}_sub`;

        let subInput = '';
        if (sf.type === 'date') subInput = `<input type="date" id="${subId}" class="sub-field-input">`;
        else if (sf.type === 'number') subInput = `<input type="number" id="${subId}" class="sub-field-input" placeholder="${sf.label}">`;
        else subInput = `<input type="text" id="${subId}" class="sub-field-input" placeholder="${sf.label}">`;

        subContainer.innerHTML = `
          <label style="font-size: 0.85em; color: #a0a0b0; display: block; margin-bottom: 4px;">${sf.label}</label>
          ${subInput}
        `;
        subContainer.style.display = 'block';
      } else {
        subContainer.style.display = 'none';
        subContainer.innerHTML = '';
      }
    };

    // Import / Export Logic
    window.exportClients = async () => {
      try {
        const token = getCookie('token');
        const response = await fetch('/api/ai/registered-clients/export', {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) {
          const text = await response.text();
          throw new Error(`${response.status} ${response.statusText}: ${text}`);
        }

        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'clients_export.csv';
        document.body.appendChild(a);
        a.click();
        a.remove();
      } catch (err) {
        showAlert('ูุดู ุงูุชุตุฏูุฑ: ' + err.message, 'error');
      }
    };

    window.downloadTemplate = async () => {
      try {
        const token = getCookie('token');
        const response = await fetch('/api/ai/registered-clients/template', {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) {
          const text = await response.text();
          throw new Error(`${response.status} ${response.statusText}: ${text}`);
        }

        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'clients_template.csv';
        document.body.appendChild(a);
        a.click();
        a.remove();
      } catch (err) {
        showAlert('ูุดู ุชุญููู ุงููุงูุจ: ' + err.message, 'error');
      }
    };

    window.importClients = async (input) => {
      if (!input.files || !input.files[0]) return;

      const file = input.files[0];
      const formData = new FormData();
      formData.append('file', file);

      try {
        showAlert('ุฌุงุฑู ุฑูุน ุงูููู ููุนุงูุฌุฉ ุงูุจูุงูุงุช... โณ');
        const token = getCookie('token');
        const response = await fetch('/api/ai/registered-clients/import', {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}` },
          body: formData
        });

        const result = await response.json();

        if (result.success) {
          let msg = `ุชู ุงูุงุณุชูุฑุงุฏ ุจูุฌุงุญ! โ\nุฅุถุงูุฉ: ${result.imported}\nุชุญุฏูุซ: ${result.updated}`;
          if (result.errors && result.errors.length > 0) {
            msg += `\n\nโ๏ธ ุฃุฎุทุงุก (${result.errors.length}):\n` + result.errors.slice(0, 5).join('\n') + (result.errors.length > 5 ? '\n...' : '');
          }
          showAlert(msg, result.errors.length > 0 ? 'warning' : 'success');
          loadRegisteredClients(); // Refresh list
        } else {
          throw new Error(result.error || 'Unknown error');
        }
      } catch (err) {
        showAlert('ูุดู ุงูุงุณุชูุฑุงุฏ: ' + err.message, 'error');
      } finally {
        input.value = ''; // Reset input
      }
    };

    // Send Salary To All
    window.sendSalaryToAll = async () => {
      if (!confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุฅุฑุณุงู ุฅุดุนุงุฑุงุช ุงูุฑุงุชุจ ูุฌููุน ุงูุนููุงุก ุงูุฐูู ูุฏููู ุฑุงุชุจ ูู ุงููุชุฑุฉ ุงูุญุงููุฉุ\nูุฐุง ูุฏ ูุณุชุบุฑู ุจุนุถ ุงูููุช.')) return;

      try {
        showAlert('ุฌุงุฑู ุงูุฅุฑุณุงู... โณ', 'info');
        const token = getCookie('token');
        const response = await fetch('/api/ai/notify/salary-all', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        const result = await response.json();
        if (result.success) {
          let msg = `ุชู ุงูุฅูุชูุงุก! โ\nุชู ุงูุฅุฑุณุงู: ${result.sent}\nุชุฌุงูุฒ (ูุง ููุฌุฏ ุฑุงุชุจ): ${result.skipped}`;
          if (result.errors > 0) msg += `\nุฃุฎุทุงุก: ${result.errors}`;
          showAlert(msg, 'success');
        } else {
          throw new Error(result.error);
        }
      } catch (err) {
        showAlert('ูุดู ุงูุฅุฑุณุงู ุงูุฌูุงุนู: ' + err.message, 'error');
      }
    };

    window.deleteField = async (id) => {
      if (!confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐุง ุงูุญููุ')) return;
      try {
        await api('DELETE', `/api/ai/custom-fields/${id}`);
        showAlert('ุชู ุญุฐู ุงูุญูู');
        loadCustomFields();
        renderCustomFieldsInForm();
      } catch (err) {
        showAlert('ูุดู ุงูุญุฐู: ' + err.message, 'error');
      }
    };

    window.promptAddOption = async (id) => {
      const option = prompt('ุฃุฏุฎู ุงูุฎูุงุฑ ุงูุฌุฏูุฏ:');
      if (!option || !option.trim()) return;

      try {
        await api('POST', `/api/ai/custom-fields/${id}/options`, { option: option.trim() });
        showAlert('ุชู ุฅุถุงูุฉ ุงูุฎูุงุฑ');
        loadCustomFields();
        renderCustomFieldsInForm();
      } catch (err) {
        showAlert('ูุดู ุฅุถุงูุฉ ุงูุฎูุงุฑ: ' + err.message, 'error');
      }
    };

    // Dynamic ID Fields Logic
    window.addIdField = (value = '') => {
      const container = document.getElementById('regIdsContainer');
      const div = document.createElement('div');
      div.className = 'input-group';
      div.style.cssText = 'margin-bottom: 5px; display: flex; gap: 5px;';

      div.innerHTML = `
           <input type="text" name="regClientId" value="${value}" placeholder="ID ุฅุถุงูู" style="flex: 1;">
           <button class="btn btn-danger" style="padding: 0 8px;" onclick="this.parentElement.remove()">โ</button>
        `;
      container.appendChild(div);
    };

    // Initial load
    loadSettings();
    loadPeriods();
    loadUsage();
    loadLookups(); // NEW
    loadRegisteredClients();
    loadLinkedClients();
    loadCustomFields();
    renderCustomFieldsInForm();
    loadSettingsFromBackend(); // NEW: Load initial settings

    // Toggle Provider Settings
    window.toggleProviderSettings = function() {
      const provider = document.getElementById('aiProvider').value;
      const openaiSettings = document.getElementById('openaiSettings');
      const openrouterSettings = document.getElementById('openrouterSettings');
      
      if (provider === 'openai') {
        openaiSettings.style.display = 'block';
        openrouterSettings.style.display = 'none';
      } else {
        openaiSettings.style.display = 'none';
        openrouterSettings.style.display = 'block';
      }
    };

    // Toggle Auto Sync Settings
    window.toggleAutoSyncSettings = function() {
      const enabled = document.getElementById('googleSheetAutoSync').checked;
      document.getElementById('autoSyncSettings').style.display = enabled ? 'block' : 'none';
    };

    // Trigger Manual Sync
    window.triggerManualSync = async function() {
      const btn = event.target;
      const originalText = btn.innerHTML;
      btn.innerHTML = 'โณ ุฌุงุฑู ุงููุฒุงููุฉ...';
      btn.disabled = true;
      
      try {
        const result = await api('POST', '/api/ai/google-sheet/sync-now');
        document.getElementById('syncStatusText').textContent = 'โ ุชูุช ุงููุฒุงููุฉ';
        document.getElementById('syncStatusText').style.color = '#22c55e';
        document.getElementById('lastSyncTime').textContent = new Date().toLocaleString('ar-SA');
        showAlert(`โ ุชูุช ุงููุฒุงููุฉ: ${result.imported} ุฌุฏูุฏุ ${result.updated} ูุญุฏูุซุ ${result.skipped} ููุฌูุฏ`);
        loadRegisteredClients();
      } catch (err) {
        document.getElementById('syncStatusText').textContent = 'โ ูุดูุช ุงููุฒุงููุฉ';
        document.getElementById('syncStatusText').style.color = '#ef4444';
        showAlert('โ ูุดูุช ุงููุฒุงููุฉ: ' + err.message, 'error');
      } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
      }
    };

    // Load sync status
    async function loadSyncStatus() {
      try {
        const status = await api('GET', '/api/ai/google-sheet/status');
        if (status.enabled) {
          document.getElementById('googleSheetAutoSync').checked = true;
          toggleAutoSyncSettings();
          document.getElementById('googleSheetUrlAuto').value = status.url || '';
          document.getElementById('googleSheetNameAuto').value = status.sheetName || '';
          document.getElementById('googleSheetSyncInterval').value = status.interval || '5';
          document.getElementById('syncStatusText').textContent = status.running ? '๐ข ุชุนูู' : 'โธ๏ธ ูุชูููุฉ';
          document.getElementById('syncStatusText').style.color = status.running ? '#22c55e' : '#f59e0b';
          if (status.lastSync) {
            document.getElementById('lastSyncTime').textContent = new Date(status.lastSync).toLocaleString('ar-SA');
          }
        }
      } catch (err) {
        console.error('Failed to load sync status:', err);
      }
    }
    
    loadSyncStatus();

    // Settings Logic
    async function loadSettingsFromBackend() {
      try {
        const settings = await api('GET', '/api/ai/settings');
        
        // AI Provider
        if (settings.aiProvider) {
          document.getElementById('aiProvider').value = settings.aiProvider;
          toggleProviderSettings();
        }
        
        // OpenAI settings
        if (settings.enabled !== undefined) document.getElementById('aiEnabled').checked = settings.enabled;
        if (settings.openaiKey) document.getElementById('openaiKey').value = settings.openaiKey;
        if (settings.modelChat) document.getElementById('modelChat').value = settings.modelChat;
        if (settings.modelStt) document.getElementById('modelStt').value = settings.modelStt;
        if (settings.modelTts) document.getElementById('modelTts').value = settings.modelTts;
        if (settings.voiceTts) document.getElementById('voiceTts').value = settings.voiceTts;
        
        // OpenRouter settings
        if (settings.openrouterKey) document.getElementById('openrouterKey').value = settings.openrouterKey;
        if (settings.openrouterModel) document.getElementById('openrouterModel').value = settings.openrouterModel;
        
        // General settings
        if (settings.trustedSessionMinutes) document.getElementById('trustedSessionMinutes').value = settings.trustedSessionMinutes;
        if (settings.agencyPercent !== undefined) document.getElementById('agencyPercent').value = settings.agencyPercent;
        
      } catch (err) {
        console.error('Failed to load settings', err);
      }
    }

    // Template Variable Insertion


    document.getElementById('saveSettingsBtn').addEventListener('click', async (e) => {
      e.preventDefault();
      const btn = e.target;
      const originalText = btn.innerText;
      btn.innerText = 'ุฌุงุฑู ุงูุญูุธ...';
      btn.disabled = true;

      try {
        const data = {
          // AI Provider
          aiProvider: document.getElementById('aiProvider')?.value || 'openai',
          
          // AI Settings (OpenAI)
          enabled: document.getElementById('aiEnabled')?.checked || false,
          openaiKey: document.getElementById('openaiKey')?.value || '',
          modelChat: document.getElementById('modelChat')?.value || 'gpt-4o-mini',
          modelStt: document.getElementById('modelStt')?.value || 'whisper-1',
          modelTts: document.getElementById('modelTts')?.value || 'tts-1',
          voiceTts: document.getElementById('voiceTts')?.value || 'alloy',
          
          // OpenRouter Settings
          openrouterKey: document.getElementById('openrouterKey')?.value || '',
          openrouterModel: document.getElementById('openrouterModel')?.value || 'openai/gpt-4o-mini',
          
          // General
          trustedSessionMinutes: parseInt(document.getElementById('trustedSessionMinutes')?.value) || 15,
          agencyPercent: parseFloat(document.getElementById('agencyPercent')?.value) || 0,
          
          // Google Sheet Auto Sync
          googleSheetAutoSync: document.getElementById('googleSheetAutoSync')?.checked || false,
          googleSheetUrlAuto: document.getElementById('googleSheetUrlAuto')?.value || '',
          googleSheetNameAuto: document.getElementById('googleSheetNameAuto')?.value || '',
          googleSheetSyncInterval: parseInt(document.getElementById('googleSheetSyncInterval')?.value) || 5
        };

        // Send all to unified endpoint
        await api('POST', '/api/ai/settings', data);
        showAlert('ุชู ุญูุธ ุฌููุน ุงูุฅุนุฏุงุฏุงุช ุจูุฌุงุญ โ');
        
        // Reload sync status
        loadSyncStatus();

      } catch (err) {
        console.error(err);
        showAlert('ุฎุทุฃ ูู ุญูุธ ุงูุฅุนุฏุงุฏุงุช: ' + err.message, 'error');
      } finally {
        btn.innerText = originalText;
        btn.disabled = false;
      }
    });



    // Broadcast Logic
    let currentBroadcastTargets = [];

    function promptBroadcast() {
      const searchQ = document.getElementById('searchRegClientInput').value.trim();
      const filterText = searchQ ? `ูุชุงุฆุฌ ุงูุจุญุซ ุนู: "${searchQ}"` : 'ูู ุงูุนููุงุก ุงููุณุฌููู';

      // Collect current list IDs (or fetch fresh if needed, but UI list is easiest reference)
      // Ideally we fetch from backend search if we want to be robust, but for now lets use the ones we have in memory 
      // Or better yet, pass the current query to the backend to resolve targets.
      // Let's rely on the frontend list logic since we have `renderClientsList` populating `clientsArray`.
      // BUT `clientsArray` is local scope to `loadRegisteredClients`. Let's assume we send ALL or Filtered.

      // Strategy: We will fetch all clients again to be safe.
      // If search is active, we use search endpoint.

      document.getElementById('broadcastFilterInfo').textContent = filterText;
      document.getElementById('broadcastMessage').value = '';
      document.getElementById('broadcastModal').style.display = 'flex';
    }

    async function sendBroadcast() {
      const message = document.getElementById('broadcastMessage').value.trim();
      if (!message) {
        alert('ูุฑุฌู ูุชุงุจุฉ ุฑุณุงูุฉ');
        return;
      }

      if (!confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุจุฏุก ุงูุฅุฑุณุงูุ ูุง ูููู ุงูุชุฑุงุฌุน.')) return;

      const q = document.getElementById('searchRegClientInput').value.trim();
      let targets = [];

      try {
        if (q) {
          targets = await api('GET', `/api/ai/registered-clients/search/query?q=${encodeURIComponent(q)}`);
        } else {
          targets = await api('GET', '/api/ai/registered-clients'); // Get all (key-value map)
          targets = Object.values(targets);
        }

        if (targets.length === 0) {
          alert('ูุง ููุฌุฏ ุนููุงุก ูุณุชูุฏููู!');
          return;
        }

        const res = await api('POST', '/api/ai/notify/broadcast', { clients: targets, message });

        document.getElementById('broadcastModal').style.display = 'none';
        showAlert(`ุชูุช ุฌุฏููุฉ ุงูุฅุฑุณุงู ูู ${res.queued} ุนููู ๐`);

      } catch (err) {
        showAlert('ูุดู ุงูุฅุฑุณุงู: ' + err.message, 'error');
      }
    }
  </script>

  <!-- Notification Modal -->
  <div id="notifyModal" class="modal"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center;">
    <div class="ai-card" style="width: 90%; max-width: 500px; margin: 0;">
      <h3 style="margin-top: 0;">ุฅุฑุณุงู ุฅุดุนุงุฑ <span id="notifyModalClientName" style="color: #3b82f6;"></span></h3>

      <div class="form-group">
        <label>ููุน ุงูุฅุดุนุงุฑ</label>
        <select id="notifyType" onchange="toggleNotifyType(this.value)">
          <option value="custom">ุฑุณุงูุฉ ูุฎุตุตุฉ</option>
          <option value="salary">ุฅุดุนุงุฑ ุงูุฑุงุชุจ</option>
        </select>
      </div>

      <div id="notifyCustomSection">
        <div class="form-group">
          <label>ุงูุฑุณุงูุฉ</label>
          <textarea id="notifyMessage" rows="5" placeholder="ุงูุชุจ ุฑุณุงูุชู ููุง..."></textarea>
        </div>
      </div>

      <div id="notifySalarySection" style="display: none;">
        <p style="color: #ccc; background: rgba(255,255,255,0.05); padding: 10px; border-radius: 4px;">
          ุณูุชู ุฅุฑุณุงู ุฅุดุนุงุฑ ูุชุถูู ุชูุงุตูู ุงูุฑุงุชุจ ูููุชุฑุฉ ุงูุญุงููุฉ (ุฅู ูุฌุฏ).
        </p>
      </div>

      <div style="display: flex; gap: 8px; justify-content: flex-end; margin-top: 20px;">
        <button class="btn btn-secondary" onclick="closeNotifyModal()">ุฅูุบุงุก</button>
        <button class="btn btn-primary" onclick="sendNotification()">ุฅุฑุณุงู ๐</button>
      </div>
    </div>
  </div>

  <!-- Broadcast Modal -->
  <div id="broadcastModal" class="modal"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center;">
    <div class="ai-card" style="width: 90%; max-width: 600px; margin: 0;">
      <h3 style="margin-top: 0;">๐ข ุฅุฑุณุงู ุฌูุงุนู (Broadcast)</h3>

      <div class="alert alert-warning" style="font-size: 0.9em; margin-bottom: 15px;">
        โ๏ธ ุณูุชู ุฅุฑุณุงู ุงูุฑุณุงุฆู ุจููุงุตู ุฒูููุฉ ุนุดูุงุฆูุฉ (5-15 ุซุงููุฉ) ูุชุฌูุจ ุงูุญุธุฑ.
      </div>

      <div class="form-group">
        <label>ุงูููุชุฑุฉ ุงูุญุงููุฉ:</label>
        <div id="broadcastFilterInfo"
          style="padding: 10px; background: rgba(255,255,255,0.05); border-radius: 4px; font-family: monospace;">
          ูู ุงูุนููุงุก
        </div>
        <p style="font-size: 0.8em; color: #a0a0b0; margin-top: 5px;">* ุณูุชู ุงูุฅุฑุณุงู ูุฌููุน ุงูุนููุงุก ุงูุธุงูุฑูู ูู ุงูุฌุฏูู
          ุญุงููุงู (ุจูุงุกู ุนูู ุงูุจุญุซ).</p>
      </div>

      <div class="form-group">
        <label>ุงูุฑุณุงูุฉ</label>
        <textarea id="broadcastMessage" rows="6" placeholder="ุงูุชุจ ุฑุณุงูุชู ููุง..."></textarea>
      </div>

      <div style="display: flex; gap: 8px; justify-content: flex-end; margin-top: 20px;">
        <button class="btn btn-secondary"
          onclick="document.getElementById('broadcastModal').style.display='none'">ุฅูุบุงุก</button>
        <button class="btn btn-primary" onclick="sendBroadcast()">ุจุฏุก ุงูุฅุฑุณุงู ๐</button>
      </div>
    </div>
  </div>


  <!-- Lookups Management Modal -->
  <div id="lookupModal" class="modal"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center;">
    <div class="ai-card" style="width: 90%; max-width: 500px; margin: 0;">
      <h3 id="lookupModalTitle" style="margin-top: 0;">ุฅุฏุงุฑุฉ ุงูููุงุฆู</h3>
      <div id="lookupList"
        style="max-height: 300px; overflow-y: auto; margin-bottom: 20px; border: 1px solid #333; padding: 10px;">
        <!-- Items will be here -->
      </div>
      <div style="display: flex; gap: 8px;">
        <input type="text" id="newLookupItem" placeholder="ุนูุตุฑ ุฌุฏูุฏ" style="flex: 1;">
        <button class="btn btn-primary" onclick="addLookupItem()">ุฅุถุงูุฉ</button>
      </div>
      <div style="margin-top: 20px; text-align: right;">
        <button class="btn btn-secondary"
          onclick="document.getElementById('lookupModal').style.display='none'">ุฅุบูุงู</button>
      </div>
    </div>
  </div>

  <script>
    // Global Lookups State
    let globalLookups = { agencies: [], countries: [] };
    let currentLookupType = ''; // agency, country, city
    let currentLookupParent = ''; // for city (country name)

    async function loadLookups() {
      try {
        globalLookups = await api('GET', '/api/ai/lookups');
        renderLookupSelects();
      } catch (err) {
        console.error('Failed to load lookups', err);
      }
    }

    function renderLookupSelects() {
      // Agency
      const agencySelect = document.getElementById('regAgency');
      const currentAgency = agencySelect.value;
      agencySelect.innerHTML = '<option value="">ุงุฎุชุฑ ุงูููุงูุฉ...</option>' +
        globalLookups.agencies.map(a => `<option value="${a}">${a}</option>`).join('');
      agencySelect.value = currentAgency;

      // Country
      const countrySelect = document.getElementById('regCountry');
      const currentCountry = countrySelect.value;
      countrySelect.innerHTML = '<option value="">ุงุฎุชุฑ ุงูุฏููุฉ...</option>' +
        globalLookups.countries.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
      countrySelect.value = currentCountry;

      renderCityOptions();
    }

    function renderCityOptions() {
      const countryName = document.getElementById('regCountry').value;
      const citySelect = document.getElementById('regCity');
      const currentCity = citySelect.value; // Store if possible

      citySelect.innerHTML = '<option value="">ุงุฎุชุฑ ุงููุฏููุฉ...</option>';

      if (!countryName) return;

      const country = globalLookups.countries.find(c => c.name === countryName);
      if (country && country.cities) {
        citySelect.innerHTML += country.cities.map(c => `<option value="${c}">${c}</option>`).join('');
      }

      // Restore if valid
      if (currentCity) citySelect.value = currentCity;
    }

    // Management UI
    function promptManageLookups(type) {
      currentLookupType = type;
      document.getElementById('lookupModal').style.display = 'flex';

      if (type === 'city') {
        const country = document.getElementById('regCountry').value;
        if (!country) {
          alert('ูุฑุฌู ุงุฎุชูุงุฑ ุงูุฏููุฉ ุฃููุงู ูุฅุฏุงุฑุฉ ูุฏููุง.');
          document.getElementById('lookupModal').style.display = 'none';
          return;
        }
        currentLookupParent = country;
        document.getElementById('lookupModalTitle').textContent = `ุฅุฏุงุฑุฉ ูุฏู: ${country}`;
      } else if (type === 'country') {
        document.getElementById('lookupModalTitle').textContent = 'ุฅุฏุงุฑุฉ ุงูุฏูู';
      } else {
        document.getElementById('lookupModalTitle').textContent = 'ุฅุฏุงุฑุฉ ุงูููุงูุงุช';
      }

      renderLookupList();
    }

    function renderLookupList() {
      const list = document.getElementById('lookupList');
      let items = [];

      if (currentLookupType === 'agency') {
        items = globalLookups.agencies;
      } else if (currentLookupType === 'country') {
        items = globalLookups.countries.map(c => c.name);
      } else if (currentLookupType === 'city') {
        const c = globalLookups.countries.find(x => x.name === currentLookupParent);
        items = c ? c.cities : [];
      }

      list.innerHTML = items.map(item => `
            <div style="display: flex; justify-content: space-between; padding: 5px; border-bottom: 1px solid #444;">
                <span>${item}</span>
                <button onclick="removeLookupItem('${item}')" style="background: none; border: none; cursor: pointer;">๐๏ธ</button>
            </div>
        `).join('');
    }

    async function addLookupItem() {
      const val = document.getElementById('newLookupItem').value.trim();
      if (!val) return;

      try {
        if (currentLookupType === 'agency') {
          await api('POST', '/api/ai/lookups/agency', { name: val });
        } else if (currentLookupType === 'country') {
          await api('POST', '/api/ai/lookups/country', { name: val });
        } else if (currentLookupType === 'city') {
          await api('POST', '/api/ai/lookups/city', { country: currentLookupParent, city: val });
        }

        document.getElementById('newLookupItem').value = '';
        await loadLookups(); // Reload all
        renderLookupList(); // Re-render list
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    async function removeLookupItem(val) {
      if (!confirm('ุญุฐูุ')) return;
      try {
        if (currentLookupType === 'agency') {
          await api('DELETE', `/api/ai/lookups/agency/${encodeURIComponent(val)}`);
        } else if (currentLookupType === 'country') {
          await api('DELETE', `/api/ai/lookups/country/${encodeURIComponent(val)}`);
        } else if (currentLookupType === 'city') {
          await api('DELETE', `/api/ai/lookups/city/${encodeURIComponent(currentLookupParent)}/${encodeURIComponent(val)}`);
        }

        await loadLookups(); // Reload all
        renderLookupList(); // Re-render list
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    // Existing notification logic
    let currentNotifyClientKey = null;
    let currentNotifyPhone = null;

    function promptNotify(key, name, phone) {
      if (!phone) {
        showAlert('ูุง ููุฌุฏ ุฑูู ูุงุชู ูุณุฌู ููุฐุง ุงูุนููู', 'error');
        return;
      }
      currentNotifyClientKey = key;
      currentNotifyPhone = phone;
      document.getElementById('notifyModalClientName').textContent = ` - ${name}`;
      document.getElementById('notifyModal').style.display = 'flex';
      document.getElementById('notifyType').value = 'custom';
      toggleNotifyType('custom');
    }

    function closeNotifyModal() {
      document.getElementById('notifyModal').style.display = 'none';
      currentNotifyClientKey = null;
      currentNotifyPhone = null;
      document.getElementById('notifyMessage').value = '';
    }

    function toggleNotifyType(type) {
      document.getElementById('notifyCustomSection').style.display = type === 'custom' ? 'block' : 'none';
      document.getElementById('notifySalarySection').style.display = type === 'salary' ? 'block' : 'none';
    }

    async function sendNotification() {
      const type = document.getElementById('notifyType').value;
      try {
        if (type === 'custom') {
          const message = document.getElementById('notifyMessage').value.trim();
          if (!message) {
            showAlert('ูุฑุฌู ูุชุงุจุฉ ูุต ุงูุฑุณุงูุฉ', 'error');
            return;
          }
          await api('POST', '/api/ai/notify/custom', { phone: currentNotifyPhone, message });
          showAlert('ุชู ุฅุฑุณุงู ุงูุฑุณุงูุฉ ุจูุฌุงุญ ๐');
        } else {
          const res = await api('POST', '/api/ai/notify/salary', { clientKey: currentNotifyClientKey });
          showAlert(res.message ? 'ุชู ุฅุฑุณุงู ุงูุฅุดุนุงุฑ ููุณุฎุฉ ููู ูู โ' : 'ุชู ุงูุฅุฑุณุงู');
        }
        closeNotifyModal();
      } catch (err) {
        showAlert('ูุดู ุงูุฅุฑุณุงู: ' + err.message, 'error');
      }
    }

    // Edit Logic
    let editingRegClientKey = null;

    window.promptEditRegClient = async (key) => {
      try {
        const clients = await api('GET', '/api/ai/registered-clients');
        const client = clients[key];
        if (!client) return;

        editingRegClientKey = key;

        // Populate IDs
        const ids = client.ids || [];
        const container = document.getElementById('regIdsContainer');
        container.innerHTML = ''; // Clear existing

        if (ids.length > 0) {
          ids.forEach((id, index) => {
            if (index === 0) {
              // First one always exists (or recreate it)
              container.innerHTML = `
                       <div class="input-group" style="margin-bottom: 5px; display: flex; gap: 5px;">
                          <input type="text" name="regClientId" value="${id}" placeholder="ูุซุงู: 7099026" style="flex: 1;">
                       </div>
                   `;
            } else {
              addIdField(id);
            }
          });
        } else {
          // Default empty
          container.innerHTML = `
               <div class="input-group" style="margin-bottom: 5px; display: flex; gap: 5px;">
                  <input type="text" name="regClientId" placeholder="ูุซุงู: 7099026" style="flex: 1;">
               </div>
            `;
        }

        document.getElementById('regFullName').value = client.fullName || '';
        document.getElementById('regWhatsapp').value = client.whatsappPhone || '';
        document.getElementById('regPhone').value = client.phone || '';
        document.getElementById('regAgency').value = client.agencyName || '';
        document.getElementById('regCountry').value = client.country || '';
        document.getElementById('regCity').value = client.city || '';
        document.getElementById('regAddress').value = client.address || '';

        // Delete Logic
        window.promptDeleteRegClient = async (key) => {
          if (!confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐุง ุงูุนูููุ ูุง ูููู ุงูุชุฑุงุฌุน.')) return;
          try {
            await api('DELETE', `/api/ai/registered-clients/${key}`);
            showAlert('ุชู ุญุฐู ุงูุนููู ุจูุฌุงุญ ๐๏ธ');
            loadRegisteredClients();
          } catch (err) {
            showAlert('ูุดู ุงูุญุฐู: ' + err.message, 'error');
          }
        };

        // Populate custom fields
        renderCustomFieldsInForm().then(() => {
          // Fill custom fields values
          if (client.customFields) {
            Object.entries(client.customFields).forEach(([k, v]) => {
              // Try to find main field
              const fieldId = `customField_${k}`;
              const el = document.getElementById(fieldId);
              if (el) {
                el.value = v;
                // Trigger change for dropdowns to show subfields
                if (el.tagName === 'SELECT') {
                  // We need to look up the field key to pass to handler
                  // Assuming 'k' is the key
                  if (window.handleDropdownSubField) {
                    try { window.handleDropdownSubField(el, k); } catch (e) { }
                  }
                }
              }

              // Try subfield
              if (k.includes('__sub')) {
                const originalKey = k.split('__sub')[0];
                const subId = `customField_${originalKey}_sub`;
                const subEl = document.getElementById(subId);
                if (subEl) subEl.value = v;
              }
            });
          }
        });

        // Change button state
        const btn = document.getElementById('addRegClientBtn');
        btn.innerHTML = '๐พ ุญูุธ ุงูุชุนุฏููุงุช';
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-success');

        // Scroll to form
        document.querySelector('#registered .ai-card').scrollIntoView({ behavior: 'smooth' });

      } catch (err) {
        showAlert('ุฎุทุฃ: ' + err.message, 'error');
      }
    };

    // Search Logic
    document.getElementById('searchRegClientInput').addEventListener('input', async (e) => {
      const q = e.target.value.trim();
      if (q.length < 1) {
        loadRegisteredClients();
        return;
      }

      try {
        const results = await api('GET', `/api/ai/registered-clients/search/query?q=${encodeURIComponent(q)}`);
        renderClientsList(results);
      } catch (err) {
        console.error(err);
      }
    });

    function renderClientsList(clientsArray) {
      const tbody = document.getElementById('regClientsBody');
      const countEl = document.getElementById('regClientCount');
      countEl.textContent = `ุงููุชุงุฆุฌ: ${clientsArray.length}`;

      // Reset select all checkbox
      document.getElementById('selectAllClients').checked = false;
      updateDeleteButton();

      if (!clientsArray.length) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #666;">ูุง ููุฌุฏ ูุชุงุฆุฌ</td></tr>';
        return;
      }

      tbody.innerHTML = clientsArray.map(c => `
          <tr data-key="${c.key}">
            <td><input type="checkbox" class="client-checkbox" data-key="${c.key}" onchange="updateDeleteButton()"></td>
            <td style="font-family: monospace; font-size: 0.85rem;">
              ${(c.ids || []).join('<br>')}
              <button class="btn btn-secondary" style="padding: 2px 8px; font-size: 0.7rem; margin-top: 4px;" onclick="promptAddId('${c.key}')">+ ID</button>
            </td>
            <td>${c.fullName || '-'}</td>
            <td style="font-family: monospace; font-size: 0.85rem; direction: ltr;">${c.whatsappPhone || '-'}</td>
            <td style="font-family: monospace; font-size: 0.85rem; direction: ltr;">${c.phone || '-'}</td>
            <td>${c.city || '-'}</td>
            <td>${c.agencyName || '-'}</td>
            <td>
              <div style="display: flex; gap: 4px; flex-wrap: wrap;">
                <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 0.8rem; background: #3b82f6;" onclick="promptEditRegClient('${c.key}')">โ๏ธ</button>
                <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 0.8rem; background: #10b981;" onclick="promptNotify('${c.key}', '${c.fullName}', '${c.whatsappPhone || c.phone}')">๐</button>
                <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 0.8rem; background: #f59e0b;" onclick="resetClientPin('${c.key}', '${c.fullName}')" title="ุชุฌุฏูุฏ PIN">๐</button>
                <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 0.8rem; background: #8b5cf6;" onclick="generatePortalLink('${c.key}', '${c.fullName}')" title="ุฑุงุจุท ุงูุจูุงุจุฉ">๐</button>
                <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 0.8rem; background: #ec4899;" onclick="openReceiptsModal('${c.key}', '${c.fullName}')" title="ุงูุฅูุตุงูุงุช">๐งพ</button>
                <button class="btn btn-danger" style="padding: 4px 8px; font-size: 0.8rem;" onclick="promptDeleteRegClient('${c.key}')">๐๏ธ</button>
              </div>
            </td>
          </tr>
        `).join('');
    }

    // Toggle select all checkboxes
    window.toggleSelectAll = (checkbox) => {
      const checkboxes = document.querySelectorAll('.client-checkbox');
      checkboxes.forEach(cb => cb.checked = checkbox.checked);
      updateDeleteButton();
    };

    // Update delete button visibility and count
    window.updateDeleteButton = () => {
      const checkboxes = document.querySelectorAll('.client-checkbox:checked');
      const count = checkboxes.length;
      const btn = document.getElementById('deleteSelectedBtn');
      const countEl = document.getElementById('selectedCount');
      
      if (count > 0) {
        btn.style.display = 'inline-block';
        countEl.textContent = count;
      } else {
        btn.style.display = 'none';
      }
    };

    // Delete selected clients
    window.deleteSelectedClients = async () => {
      const checkboxes = document.querySelectorAll('.client-checkbox:checked');
      const keys = Array.from(checkboxes).map(cb => cb.dataset.key);
      
      if (keys.length === 0) {
        showAlert('ูู ูุชู ุชุญุฏูุฏ ุฃู ุนููู', 'error');
        return;
      }
      
      if (!confirm(`ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ${keys.length} ุนูููุ\n\nโ๏ธ ูุง ูููู ุงูุชุฑุงุฌุน ุนู ูุฐุง ุงูุฅุฌุฑุงุก!`)) return;
      
      try {
        const result = await api('POST', '/api/ai/registered-clients/bulk-delete', { keys });
        showAlert(`โ ุชู ุญุฐู ${result.deleted} ุนููู${result.failed > 0 ? `\nโ ูุดู ุญุฐู ${result.failed}` : ''}`);
        loadRegisteredClients();
      } catch (err) {
        showAlert('โ ูุดู ุงูุญุฐู: ' + err.message, 'error');
      }
    };

    // Google Sheet Functions
    window.showGoogleSheetModal = () => {
      document.getElementById('googleSheetModal').style.display = 'flex';
    };

    window.hideGoogleSheetModal = () => {
      document.getElementById('googleSheetModal').style.display = 'none';
    };

    window.importFromGoogleSheet = async () => {
      const url = document.getElementById('googleSheetUrl').value.trim();
      const sheetName = document.getElementById('googleSheetName').value.trim();
      
      if (!url) {
        showAlert('ุงูุฑุฌุงุก ุฅุฏุฎุงู ุฑุงุจุท Google Sheet', 'error');
        return;
      }
      
      const btn = document.getElementById('importGoogleSheetBtn');
      const originalText = btn.innerHTML;
      btn.innerHTML = 'โณ ุฌุงุฑู ุงูุงุณุชูุฑุงุฏ...';
      btn.disabled = true;
      
      try {
        const result = await api('POST', '/api/ai/registered-clients/import-google-sheet', { 
          url, 
          sheetName 
        });
        
        hideGoogleSheetModal();
        showAlert(`โ ุชู ุงุณุชูุฑุงุฏ ${result.imported} ุนููู ุจูุฌุงุญ${result.skipped > 0 ? `\nโญ๏ธ ุชู ุชุฎุทู ${result.skipped} (ููุฌูุฏูู ูุณุจูุงู)` : ''}${result.failed > 0 ? `\nโ ูุดู ${result.failed}` : ''}`);
        loadRegisteredClients();
        
        // Clear inputs
        document.getElementById('googleSheetUrl').value = '';
        document.getElementById('googleSheetName').value = '';
        
      } catch (err) {
        showAlert('โ ูุดู ุงูุงุณุชูุฑุงุฏ: ' + err.message, 'error');
      } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
      }
    };

    // Close modal on outside click
    document.getElementById('googleSheetModal')?.addEventListener('click', (e) => {
      if (e.target.id === 'googleSheetModal') {
        hideGoogleSheetModal();
      }
    });

    // Sidebar Navigation
    const pageTitles = {
      'settings': 'โ๏ธ ุฅุนุฏุงุฏุงุช AI',
      'fields': '๐ ุงูุญููู ุงููุฎุตุตุฉ',
      'registered': '๐ฅ ุงูุนููุงุก ุงููุณุฌููู',
      'linked': '๐ ุงูุนููุงุก ุงููุฑุจูุทูู',
      'salary': '๐ฐ ุงูุฑูุงุชุจ',
      'usage': '๐ ุงูุงุณุชููุงู'
    };

    document.querySelectorAll('.nav-item[data-tab]').forEach(item => {
      item.addEventListener('click', () => {
        const tab = item.dataset.tab;
        
        // Update nav items
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        item.classList.add('active');
        
        // Update tab content
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.getElementById(tab).classList.add('active');
        
        // Update page title
        document.getElementById('pageTitle').textContent = pageTitles[tab] || tab;
        
        // Close sidebar on mobile
        if (window.innerWidth <= 1024) {
          document.getElementById('sidebar').classList.remove('open');
        }
      });
    });

    // Mobile sidebar toggle
    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('open');
    }

    // Close sidebar when clicking outside on mobile
    document.addEventListener('click', (e) => {
      const sidebar = document.getElementById('sidebar');
      const menuBtn = document.querySelector('.mobile-menu-btn');
      if (window.innerWidth <= 1024 && 
          !sidebar.contains(e.target) && 
          !menuBtn.contains(e.target) &&
          sidebar.classList.contains('open')) {
        sidebar.classList.remove('open');
      }
    });

    // =====================================================
    // RECEIPTS MANAGEMENT
    // =====================================================
    let currentReceiptsClientKey = null;
    let currentReceiptsClientName = null;

    window.openReceiptsModal = async (clientKey, clientName) => {
      currentReceiptsClientKey = clientKey;
      currentReceiptsClientName = clientName;
      
      document.getElementById('receiptsModalTitle').textContent = `๐งพ ุฅูุตุงูุงุช: ${clientName}`;
      document.getElementById('receiptsModal').style.display = 'flex';
      document.getElementById('receiptFile').value = '';
      document.getElementById('receiptDescription').value = '';
      
      await loadClientReceipts();
    };

    window.closeReceiptsModal = () => {
      document.getElementById('receiptsModal').style.display = 'none';
      currentReceiptsClientKey = null;
      currentReceiptsClientName = null;
    };

    async function loadClientReceipts() {
      const container = document.getElementById('receiptsList');
      container.innerHTML = '<div style="text-align: center; padding: 20px; color: #888;">ุฌุงุฑู ุงูุชุญููู...</div>';
      
      try {
        const receipts = await api('GET', `/api/ai/clients/${currentReceiptsClientKey}/receipts`);
        
        if (!receipts || receipts.length === 0) {
          container.innerHTML = '<div style="text-align: center; padding: 20px; color: #888;">ูุง ุชูุฌุฏ ุฅูุตุงูุงุช ุจุนุฏ</div>';
          return;
        }
        
        container.innerHTML = receipts.map(r => {
          const isImage = r.mimeType && r.mimeType.startsWith('image/');
          const date = new Date(r.uploadedAt).toLocaleDateString('ar', { year: 'numeric', month: 'short', day: 'numeric' });
          const sizeKB = Math.round(r.size / 1024);
          
          return `
            <div class="receipt-item" style="display: flex; align-items: center; gap: 12px; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 8px; margin-bottom: 8px;">
              <div style="flex-shrink: 0; width: 50px; height: 50px; background: rgba(255,255,255,0.1); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 24px;">
                ${isImage ? '๐ผ๏ธ' : '๐'}
              </div>
              <div style="flex: 1; min-width: 0;">
                <div style="font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${r.originalName}</div>
                <div style="font-size: 0.75rem; color: #888;">${date} โข ${sizeKB} KB</div>
                ${r.description ? `<div style="font-size: 0.8rem; color: #aaa; margin-top: 4px;">${r.description}</div>` : ''}
              </div>
              <div style="display: flex; gap: 8px;">
                <a href="/api/receipts/file/${r.filename}" target="_blank" class="btn btn-secondary" style="padding: 6px 12px; font-size: 0.8rem;">๐๏ธ</a>
                <a href="/api/receipts/file/${r.filename}" download="${r.originalName}" class="btn btn-secondary" style="padding: 6px 12px; font-size: 0.8rem;">โฌ๏ธ</a>
                <button class="btn btn-danger" style="padding: 6px 12px; font-size: 0.8rem;" onclick="deleteReceipt('${r.id}')">๐๏ธ</button>
              </div>
            </div>
          `;
        }).join('');
      } catch (err) {
        container.innerHTML = `<div style="text-align: center; padding: 20px; color: #ef4444;">ุฎุทุฃ: ${err.message}</div>`;
      }
    }

    window.uploadReceipt = async () => {
      const fileInput = document.getElementById('receiptFile');
      const description = document.getElementById('receiptDescription').value.trim();
      
      if (!fileInput.files || fileInput.files.length === 0) {
        showAlert('ุงูุฑุฌุงุก ุงุฎุชูุงุฑ ููู', 'error');
        return;
      }
      
      const file = fileInput.files[0];
      const formData = new FormData();
      formData.append('file', file);
      formData.append('description', description);
      
      try {
        document.getElementById('uploadReceiptBtn').disabled = true;
        document.getElementById('uploadReceiptBtn').textContent = 'ุฌุงุฑู ุงูุฑูุน...';
        
        const response = await fetch(`/api/ai/clients/${currentReceiptsClientKey}/receipts`, {
          method: 'POST',
          body: formData
        });
        
        const result = await response.json();
        
        if (!response.ok) {
          throw new Error(result.error || 'ูุดู ุงูุฑูุน');
        }
        
        showAlert('โ ุชู ุฑูุน ุงูุฅูุตุงู ุจูุฌุงุญ ูุฅุฑุณุงู ุฅุดุนุงุฑ ููุนููู');
        fileInput.value = '';
        document.getElementById('receiptDescription').value = '';
        await loadClientReceipts();
      } catch (err) {
        showAlert('โ ' + err.message, 'error');
      } finally {
        document.getElementById('uploadReceiptBtn').disabled = false;
        document.getElementById('uploadReceiptBtn').textContent = '๐ค ุฑูุน';
      }
    };

    window.deleteReceipt = async (receiptId) => {
      if (!confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐุง ุงูุฅูุตุงูุ')) return;
      
      try {
        await api('DELETE', `/api/ai/receipts/${receiptId}`);
        showAlert('ุชู ุญุฐู ุงูุฅูุตุงู');
        await loadClientReceipts();
      } catch (err) {
        showAlert('โ ' + err.message, 'error');
      }
    };

  </script>
        </div>
      </div>
    </main>
  </div>
</body>

</html>
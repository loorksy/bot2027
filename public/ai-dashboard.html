<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>لوحة التحكم - AI Agent</title>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #09090b;
      --surface: #18181b;
      --surface-2: #27272a;
      --border: #27272a;
      --primary: #10b981;
      --primary-dim: rgba(16, 185, 129, 0.1);
      --text: #e4e4e7;
      --text-muted: #a1a1aa;
      --text-dim: #71717a;
      --success: #059669;
      --success-bg: rgba(5, 150, 105, 0.15);
      --danger: #ef4444;
      --danger-bg: rgba(239, 68, 68, 0.1);
      --warning: #f59e0b;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'IBM Plex Sans Arabic', sans-serif;
      background: var(--bg);
      color: var(--text);
      font-size: 13px;
      line-height: 1.5;
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
    }

    /* === LAYOUT === */
    .app-layout {
      display: flex;
      min-height: 100vh;
    }

    /* === SIDEBAR (Desktop) === */
    .sidebar {
      width: 240px;
      background: var(--surface);
      border-left: 1px solid var(--border);
      position: fixed;
      right: 0;
      top: 0;
      bottom: 0;
      z-index: 100;
      display: flex;
      flex-direction: column;
      transition: transform 0.3s ease;
    }

    @media (max-width: 768px) {
      .sidebar { display: none; }
    }

    .sidebar-header {
      padding: 16px;
      border-bottom: 1px solid var(--border);
    }

    .sidebar-logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-icon {
      width: 36px;
      height: 36px;
      background: var(--primary-dim);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--primary);
    }

    .logo-text {
      font-size: 14px;
      font-weight: 600;
      color: var(--text);
    }

    .logo-subtitle {
      font-size: 10px;
      color: var(--text-dim);
    }

    .sidebar-nav {
      flex: 1;
      padding: 12px 8px;
      overflow-y: auto;
    }

    .nav-section {
      margin-bottom: 16px;
    }

    .nav-section-title {
      font-size: 10px;
      font-weight: 600;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: 0 12px;
      margin-bottom: 6px;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 8px;
      cursor: pointer;
      color: var(--text-muted);
      transition: all 0.2s;
      margin-bottom: 2px;
    }

    .nav-item:hover {
      background: var(--surface-2);
      color: var(--text);
    }

    .nav-item.active {
      background: var(--primary-dim);
      color: var(--primary);
    }

    .nav-item svg {
      width: 18px;
      height: 18px;
      flex-shrink: 0;
    }

    .nav-item-text {
      font-size: 12px;
      font-weight: 500;
    }

    .nav-badge {
      margin-right: auto;
      background: var(--danger);
      color: white;
      font-size: 10px;
      font-weight: 600;
      padding: 2px 6px;
      border-radius: 10px;
      min-width: 18px;
      text-align: center;
    }

    /* === MAIN CONTENT === */
    .main-content {
      flex: 1;
      margin-right: 240px;
      padding: 20px;
      padding-bottom: 80px;
      min-height: 100vh;
    }

    @media (max-width: 768px) {
      .main-content {
        margin-right: 0;
        padding: 16px;
        padding-bottom: 80px;
      }
    }

    /* === BOTTOM NAV (Mobile) === */
    .bottom-nav {
      display: none;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(24, 24, 27, 0.95);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-top: 1px solid var(--border);
      padding: 8px 0;
      padding-bottom: max(8px, env(safe-area-inset-bottom));
      z-index: 100;
    }

    @media (max-width: 768px) {
      .bottom-nav { display: flex; justify-content: space-around; }
    }

    .bottom-nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      padding: 6px 12px;
      border: none;
      background: none;
      color: var(--text-dim);
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.2s;
      position: relative;
    }

    .bottom-nav-item svg {
      width: 20px;
      height: 20px;
    }

    .bottom-nav-item span {
      font-size: 10px;
      font-weight: 500;
    }

    .bottom-nav-item.active {
      color: var(--primary);
    }

    .bottom-nav-item .mobile-badge {
      position: absolute;
      top: 2px;
      right: 8px;
      background: var(--danger);
      color: white;
      font-size: 9px;
      font-weight: 600;
      padding: 1px 4px;
      border-radius: 8px;
      min-width: 14px;
    }

    /* === TAB CONTENT === */
    .tab-content {
      display: none;
      animation: fadeIn 0.2s ease;
    }

    .tab-content.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* === PAGE HEADER === */
    .page-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 12px;
    }

    .page-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .page-title svg {
      width: 20px;
      height: 20px;
      color: var(--primary);
    }

    .page-subtitle {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    /* === CARDS === */
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border);
    }

    .card-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .card-title svg {
      width: 16px;
      height: 16px;
      color: var(--primary);
    }

    /* === FORM ELEMENTS === */
    .form-group {
      margin-bottom: 14px;
    }

    .form-label {
      display: block;
      font-size: 11px;
      font-weight: 500;
      color: var(--text-muted);
      margin-bottom: 6px;
    }

    .form-input, .form-select, .form-textarea {
      width: 100%;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px 12px;
      color: var(--text);
      font-family: inherit;
      font-size: 12px;
      outline: none;
      transition: all 0.2s;
    }

    .form-input:focus, .form-select:focus, .form-textarea:focus {
      border-color: var(--primary);
    }

    .form-textarea {
      min-height: 80px;
      resize: vertical;
    }

    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
    }

    .form-switch {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .switch {
      position: relative;
      width: 40px;
      height: 22px;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .switch-slider {
      position: absolute;
      cursor: pointer;
      inset: 0;
      background: var(--surface-2);
      border-radius: 22px;
      transition: 0.3s;
    }

    .switch-slider::before {
      content: '';
      position: absolute;
      height: 16px;
      width: 16px;
      right: 3px;
      bottom: 3px;
      background: var(--text-muted);
      border-radius: 50%;
      transition: 0.3s;
    }

    .switch input:checked + .switch-slider {
      background: var(--primary);
    }

    .switch input:checked + .switch-slider::before {
      transform: translateX(-18px);
      background: white;
    }

    /* === BUTTONS === */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 10px 16px;
      border: none;
      border-radius: 8px;
      font-family: inherit;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn svg {
      width: 14px;
      height: 14px;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: #0d9668;
      transform: translateY(-1px);
    }

    .btn-secondary {
      background: var(--surface-2);
      color: var(--text);
    }

    .btn-secondary:hover {
      background: var(--border);
    }

    .btn-danger {
      background: var(--danger-bg);
      color: var(--danger);
    }

    .btn-danger:hover {
      background: var(--danger);
      color: white;
    }

    .btn-sm {
      padding: 6px 12px;
      font-size: 11px;
    }

    .btn-icon {
      padding: 8px;
      border-radius: 8px;
    }

    /* === TABLE === */
    .table-container {
      overflow-x: auto;
      border-radius: 8px;
      border: 1px solid var(--border);
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    .data-table th,
    .data-table td {
      padding: 12px;
      text-align: right;
      border-bottom: 1px solid var(--border);
    }

    .data-table th {
      background: var(--bg);
      font-weight: 600;
      color: var(--text-muted);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .data-table tbody tr {
      transition: background 0.2s;
    }

    .data-table tbody tr:hover {
      background: var(--surface-2);
    }

    .data-table tbody tr:last-child td {
      border-bottom: none;
    }

    /* Mobile cards for table */
    @media (max-width: 768px) {
      .table-container { display: none; }
      .mobile-cards { display: block; }
    }

    @media (min-width: 769px) {
      .mobile-cards { display: none; }
    }

    .mobile-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 14px;
      margin-bottom: 10px;
    }

    .mobile-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .mobile-card-title {
      font-weight: 600;
      color: var(--text);
    }

    .mobile-card-row {
      display: flex;
      justify-content: space-between;
      padding: 6px 0;
      border-bottom: 1px solid var(--border);
      font-size: 11px;
    }

    .mobile-card-row:last-child {
      border-bottom: none;
    }

    .mobile-card-label {
      color: var(--text-muted);
    }

    .mobile-card-value {
      color: var(--text);
      font-weight: 500;
    }

    .mobile-card-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--border);
    }

    /* === BADGES === */
    .badge {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 10px;
      font-weight: 600;
    }

    .badge-success {
      background: var(--success-bg);
      color: var(--success);
    }

    .badge-warning {
      background: rgba(245, 158, 11, 0.15);
      color: var(--warning);
    }

    .badge-danger {
      background: var(--danger-bg);
      color: var(--danger);
    }

    .badge-info {
      background: var(--primary-dim);
      color: var(--primary);
    }

    /* === STATS GRID === */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 14px;
      text-align: center;
    }

    .stat-value {
      font-size: 22px;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 4px;
    }

    .stat-label {
      font-size: 10px;
      color: var(--text-muted);
    }

    /* === FILE UPLOAD === */
    .file-upload-area {
      border: 2px dashed var(--border);
      border-radius: 12px;
      padding: 30px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }

    .file-upload-area:hover,
    .file-upload-area.dragover {
      border-color: var(--primary);
      background: var(--primary-dim);
    }

    .file-upload-icon {
      width: 40px;
      height: 40px;
      margin: 0 auto 12px;
      color: var(--text-muted);
    }

    .file-upload-text {
      font-size: 12px;
      color: var(--text-muted);
    }

    .file-upload-hint {
      font-size: 10px;
      color: var(--text-dim);
      margin-top: 6px;
    }

    /* === CHAT === */
    .chat-list {
      max-height: 400px;
      overflow-y: auto;
    }

    .chat-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      border-bottom: 1px solid var(--border);
    }

    .chat-item:hover {
      background: var(--surface-2);
    }

    .chat-item.unread {
      background: var(--primary-dim);
    }

    .chat-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: var(--surface-2);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--primary);
      flex-shrink: 0;
    }

    .chat-info {
      flex: 1;
      min-width: 0;
    }

    .chat-name {
      font-weight: 600;
      font-size: 12px;
      color: var(--text);
    }

    .chat-preview {
      font-size: 11px;
      color: var(--text-muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .chat-time {
      font-size: 10px;
      color: var(--text-dim);
    }

    .chat-messages-container {
      height: 300px;
      overflow-y: auto;
      padding: 12px;
      background: var(--bg);
      border-radius: 8px;
      margin-bottom: 12px;
    }

    .chat-bubble {
      max-width: 80%;
      padding: 10px 14px;
      border-radius: 12px;
      margin-bottom: 8px;
      font-size: 12px;
    }

    .chat-bubble.admin {
      background: var(--primary);
      color: white;
      margin-left: auto;
      border-bottom-left-radius: 4px;
    }

    .chat-bubble.client {
      background: var(--surface-2);
      color: var(--text);
      border-bottom-right-radius: 4px;
    }

    .chat-bubble-time {
      font-size: 9px;
      opacity: 0.7;
      margin-top: 4px;
    }

    /* === ALERT === */
    .alert-container {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      max-width: 90%;
    }

    .alert {
      background: var(--surface);
      border: 1px solid var(--border);
      padding: 12px 20px;
      border-radius: 10px;
      font-size: 12px;
      animation: slideDown 0.3s ease;
    }

    .alert-success {
      border-color: var(--success);
      background: var(--success-bg);
    }

    .alert-error {
      border-color: var(--danger);
      background: var(--danger-bg);
    }

    @keyframes slideDown {
      from { transform: translate(-50%, -100%); opacity: 0; }
      to { transform: translate(-50%, 0); opacity: 1; }
    }

    /* === MODAL === */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 200;
      padding: 20px;
    }

    .modal.active {
      display: flex;
    }

    @media (max-width: 768px) {
      .modal {
        align-items: flex-end;
        padding: 0;
      }
    }

    .modal-content {
      background: var(--surface);
      width: 100%;
      max-width: 500px;
      max-height: 90vh;
      border-radius: 16px;
      overflow: hidden;
      animation: modalIn 0.3s ease;
    }

    @media (max-width: 768px) {
      .modal-content {
        max-width: 100%;
        border-radius: 20px 20px 0 0;
        max-height: 85vh;
      }
    }

    @keyframes modalIn {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
    }

    .modal-title {
      font-size: 14px;
      font-weight: 600;
    }

    .modal-close {
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      padding: 4px;
    }

    .modal-body {
      padding: 20px;
      overflow-y: auto;
      max-height: calc(90vh - 120px);
    }

    .modal-footer {
      padding: 16px 20px;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }

    /* === EMPTY STATE === */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-muted);
    }

    .empty-state svg {
      width: 48px;
      height: 48px;
      color: var(--text-dim);
      margin-bottom: 12px;
    }

    .empty-state p {
      font-size: 12px;
    }

    /* === SEARCH === */
    .search-box {
      position: relative;
      margin-bottom: 16px;
    }

    .search-box input {
      width: 100%;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px 12px 10px 36px;
      color: var(--text);
      font-size: 12px;
    }

    .search-box svg {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      width: 16px;
      height: 16px;
      color: var(--text-dim);
    }

    /* === PERIOD CARD === */
    .period-card {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 14px;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .period-card.current {
      border-color: var(--primary);
      background: var(--primary-dim);
    }

    .period-info h4 {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .period-meta {
      font-size: 10px;
      color: var(--text-muted);
    }

    /* === TABS INSIDE CARDS === */
    .inner-tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 16px;
      border-bottom: 1px solid var(--border);
      padding-bottom: 12px;
    }

    .inner-tab {
      padding: 8px 14px;
      border: none;
      background: none;
      color: var(--text-muted);
      font-size: 11px;
      font-weight: 500;
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.2s;
    }

    .inner-tab:hover {
      background: var(--surface-2);
    }

    .inner-tab.active {
      background: var(--primary-dim);
      color: var(--primary);
    }

    /* === DROPDOWN OPTIONS === */
    .dropdown-option {
      display: flex;
      gap: 8px;
      align-items: center;
      padding: 8px;
      background: var(--bg);
      border-radius: 6px;
      margin-bottom: 6px;
    }

    .dropdown-option input {
      flex: 1;
    }

    /* === KNOWLEDGE BASE === */
    .knowledge-item {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 8px;
    }

    .knowledge-item.inactive {
      opacity: 0.5;
    }

    .knowledge-question {
      font-weight: 600;
      font-size: 12px;
      margin-bottom: 6px;
    }

    .knowledge-answer {
      font-size: 11px;
      color: var(--text-muted);
    }

    /* === TICKETS === */
    .ticket-item {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 14px;
      margin-bottom: 10px;
    }

    .ticket-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .ticket-subject {
      font-weight: 600;
      font-size: 13px;
    }

    .ticket-message {
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 10px;
      padding: 10px;
      background: var(--surface);
      border-radius: 6px;
    }

    /* === HIDDEN CLASS === */
    .hidden {
      display: none !important;
    }

    /* === SCROLLBAR === */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }

    ::-webkit-scrollbar-track {
      background: var(--bg);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--surface-2);
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--text-dim);
    }

    /* === MENU DRAWER (Mobile) === */
    .menu-drawer {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.8);
      z-index: 150;
      display: none;
    }

    .menu-drawer.active {
      display: block;
    }

    .menu-drawer-content {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--surface);
      border-radius: 20px 20px 0 0;
      padding: 20px;
      max-height: 70vh;
      overflow-y: auto;
      animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
      from { transform: translateY(100%); }
      to { transform: translateY(0); }
    }

    .menu-drawer-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px;
      border-radius: 10px;
      color: var(--text);
      cursor: pointer;
      transition: all 0.2s;
    }

    .menu-drawer-item:hover,
    .menu-drawer-item.active {
      background: var(--primary-dim);
      color: var(--primary);
    }

    .menu-drawer-item svg {
      width: 20px;
      height: 20px;
    }
  </style>
</head>
<body>
  <div id="alertContainer" class="alert-container"></div>

  <div class="app-layout">
    <!-- Sidebar (Desktop) -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-logo">
          <div class="logo-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 8V4H8"/><rect width="16" height="12" x="4" y="8" rx="2"/><path d="M2 14h2"/><path d="M20 14h2"/><path d="M15 13v2"/><path d="M9 13v2"/>
            </svg>
          </div>
          <div>
            <div class="logo-text">AI Agent</div>
            <div class="logo-subtitle">لوحة التحكم</div>
          </div>
        </div>
      </div>

      <nav class="sidebar-nav">
        <div class="nav-section">
          <div class="nav-section-title">الإعدادات</div>
          <div class="nav-item active" data-tab="settings">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
            <span class="nav-item-text">إعدادات AI</span>
          </div>
          <div class="nav-item" data-tab="fields">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M3 5V19A9 3 0 0 0 21 19V5"/><path d="M3 12A9 3 0 0 0 21 12"/></svg>
            <span class="nav-item-text">الحقول المخصصة</span>
          </div>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">إدارة العملاء</div>
          <div class="nav-item" data-tab="registered">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
            <span class="nav-item-text">العملاء المسجلين</span>
          </div>
          <div class="nav-item" data-tab="linked">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
            <span class="nav-item-text">العملاء المربوطين</span>
          </div>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">المالية</div>
          <div class="nav-item" data-tab="salary">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect width="20" height="14" x="2" y="5" rx="2"/><line x1="2" x2="22" y1="10" y2="10"/></svg>
            <span class="nav-item-text">الرواتب</span>
          </div>
          <div class="nav-item" data-tab="notifications">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></svg>
            <span class="nav-item-text">الإشعارات</span>
          </div>
          <div class="nav-item" data-tab="chats">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M7.9 20A9 9 0 1 0 4 16.1L2 22Z"/></svg>
            <span class="nav-item-text">الدردشات</span>
            <span id="chatsBadge" class="nav-badge hidden">0</span>
          </div>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">الدعم</div>
          <div class="nav-item" data-tab="tickets">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 9a3 3 0 0 1 0 6v2a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-2a3 3 0 0 1 0-6V7a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2Z"/><path d="M13 5v2"/><path d="M13 17v2"/><path d="M13 11v2"/></svg>
            <span class="nav-item-text">التذاكر</span>
            <span id="ticketsBadge" class="nav-badge hidden">0</span>
          </div>
          <div class="nav-item" data-tab="knowledge">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"/></svg>
            <span class="nav-item-text">قاعدة المعرفة</span>
          </div>
          <div class="nav-item" data-tab="usage">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" x2="12" y1="20" y2="10"/><line x1="18" x2="18" y1="20" y2="4"/><line x1="6" x2="6" y1="20" y2="16"/></svg>
            <span class="nav-item-text">الاستهلاك</span>
          </div>
        </div>
      </nav>

      <div style="padding: 12px; border-top: 1px solid var(--border);">
        <a href="/" style="display: flex; align-items: center; gap: 8px; color: var(--text-muted); text-decoration: none; font-size: 11px; padding: 10px; border-radius: 8px; transition: all 0.2s;" onmouseover="this.style.background='var(--surface-2)'" onmouseout="this.style.background='transparent'">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
          العودة للرئيسية
        </a>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Settings Tab -->
      <div id="settings" class="tab-content active" data-testid="settings-tab">
        <div class="page-header">
          <div>
            <div class="page-title">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
              إعدادات AI
            </div>
            <div class="page-subtitle">تحكم في إعدادات الذكاء الاصطناعي والبوت</div>
          </div>
          <button class="btn btn-primary" id="saveSettingsBtn" data-testid="save-settings-btn">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
            حفظ الإعدادات
          </button>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 8V4H8"/><rect width="16" height="12" x="4" y="8" rx="2"/></svg>
              الذكاء الاصطناعي
            </div>
            <div class="form-switch">
              <label class="switch">
                <input type="checkbox" id="aiEnabled">
                <span class="switch-slider"></span>
              </label>
              <span style="font-size: 11px; color: var(--text-muted);">تفعيل AI Agent</span>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label">مزود الذكاء الاصطناعي</label>
              <select class="form-select" id="aiProvider">
                <option value="openai">OpenAI</option>
                <option value="openrouter">OpenRouter</option>
              </select>
            </div>
          </div>

          <div id="openaiSettings">
            <div class="form-group">
              <label class="form-label">OpenAI API Key</label>
              <input type="password" class="form-input" id="openaiKey" placeholder="sk-..." data-testid="openai-key">
            </div>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">موديل المحادثة (Chat)</label>
                <select class="form-select" id="modelChat">
                  <option value="gpt-4o-mini">GPT-4o Mini (أرخص)</option>
                  <option value="gpt-4o">GPT-4o</option>
                  <option value="gpt-4-turbo">GPT-4 Turbo</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">موديل تحويل الصوت لنص (STT)</label>
                <select class="form-select" id="modelStt">
                  <option value="whisper-1">Whisper-1</option>
                </select>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">موديل تحويل النص لصوت (TTS)</label>
                <select class="form-select" id="modelTts">
                  <option value="tts-1">TTS-1 (سريع)</option>
                  <option value="tts-1-hd">TTS-1-HD (جودة عالية)</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">صوت TTS</label>
                <select class="form-select" id="voiceTts">
                  <option value="alloy">Alloy</option>
                  <option value="echo">Echo</option>
                  <option value="fable">Fable</option>
                  <option value="onyx">Onyx</option>
                  <option value="nova">Nova</option>
                  <option value="shimmer">Shimmer</option>
                </select>
              </div>
            </div>
          </div>

          <div id="openrouterSettings" class="hidden">
            <div class="form-group">
              <label class="form-label">OpenRouter API Key</label>
              <input type="password" class="form-input" id="openrouterKey" placeholder="sk-or-..." data-testid="openrouter-key">
            </div>
            <div class="form-group">
              <label class="form-label">موديل OpenRouter</label>
              <select class="form-select" id="openrouterModel">
                <option value="openai/gpt-4o-mini">OpenAI GPT-4o Mini</option>
              </select>
              <button class="btn btn-sm btn-secondary" style="margin-top: 8px;" onclick="loadOpenRouterModels()">
                تحميل الموديلات المتاحة
              </button>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" x2="9.01" y1="9" y2="9"/><line x1="15" x2="15.01" y1="9" y2="9"/></svg>
              شخصية البوت
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label">اسم البوت</label>
              <input type="text" class="form-input" id="botName" value="مساعد أبو سلطان" data-testid="bot-name">
            </div>
            <div class="form-group">
              <label class="form-label">اسم المالك</label>
              <input type="text" class="form-input" id="ownerName" value="أبو سلطان" data-testid="owner-name">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label">اللهجة</label>
              <select class="form-select" id="dialect">
                <option value="سورية">سورية</option>
                <option value="لبنانية">لبنانية</option>
                <option value="مصرية">مصرية</option>
                <option value="خليجية">خليجية</option>
                <option value="فصحى">فصحى</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">جنس العميل الافتراضي</label>
              <select class="form-select" id="clientGender">
                <option value="مؤنث">مؤنث</option>
                <option value="مذكر">مذكر</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label">مستوى الودية</label>
              <select class="form-select" id="friendliness">
                <option value="عالي">عالي (صديقة)</option>
                <option value="متوسط">متوسط (مهنية)</option>
                <option value="منخفض">منخفض (رسمية)</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">عملة الراتب</label>
              <input type="text" class="form-input" id="salaryCurrency" value="ر.س" data-testid="salary-currency">
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">رسالة التواصل مع الإدارة</label>
            <input type="text" class="form-input" id="adminContact" value="تواصلي مع الإدارة">
          </div>

          <div class="form-switch" style="margin-top: 12px;">
            <label class="switch">
              <input type="checkbox" id="enableVoiceReplies">
              <span class="switch-slider"></span>
            </label>
            <span style="font-size: 11px; color: var(--text-muted);">تفعيل الردود الصوتية</span>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
              إعدادات الجلسة
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label">مدة الجلسة الموثوقة (دقائق)</label>
              <input type="number" class="form-input" id="trustedSessionMinutes" value="15">
            </div>
            <div class="form-group">
              <label class="form-label">نسبة الوكالة الافتراضية (%)</label>
              <input type="number" class="form-input" id="agencyPercent" value="0" step="0.1">
            </div>
          </div>
        </div>
      </div>

      <!-- Custom Fields Tab -->
      <div id="fields" class="tab-content" data-testid="fields-tab">
        <div class="page-header">
          <div>
            <div class="page-title">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M3 5V19A9 3 0 0 0 21 19V5"/><path d="M3 12A9 3 0 0 0 21 12"/></svg>
              الحقول المخصصة
            </div>
            <div class="page-subtitle">أضف حقول إضافية لبيانات العملاء</div>
          </div>
          <button class="btn btn-secondary" id="refreshFieldsBtn">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/></svg>
            تحديث
          </button>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">إضافة حقل جديد</div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label">اسم الحقل</label>
              <input type="text" class="form-input" id="fieldName" placeholder="مثال: رقم الحساب">
            </div>
            <div class="form-group">
              <label class="form-label">نوع الحقل</label>
              <select class="form-select" id="fieldType">
                <option value="text">نص</option>
                <option value="number">رقم</option>
                <option value="dropdown">قائمة منسدلة</option>
              </select>
            </div>
          </div>

          <div id="dropdownOptionsContainer" class="hidden">
            <label class="form-label">خيارات القائمة</label>
            <div id="dropdownOptions"></div>
            <button type="button" class="btn btn-sm btn-secondary" style="margin-top: 8px;" onclick="addDropdownOptionInputWithSubField()">+ إضافة خيار</button>
          </div>

          <div style="display: flex; gap: 10px; margin-top: 16px;">
            <button class="btn btn-primary" id="addFieldBtn">
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
              إضافة الحقل
            </button>
            <button class="btn btn-secondary hidden" id="cancelEditFieldBtn" onclick="cancelEdit()">إلغاء التعديل</button>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">الحقول الحالية</div>
          </div>
          <div id="fieldsList"></div>
        </div>
      </div>

      <!-- Registered Clients Tab -->
      <div id="registered" class="tab-content" data-testid="registered-tab">
        <div class="page-header">
          <div>
            <div class="page-title">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
              العملاء المسجلين
            </div>
            <div class="page-subtitle">إدارة بيانات العملاء</div>
          </div>
          <div style="display: flex; gap: 8px; flex-wrap: wrap;">
            <button class="btn btn-secondary" id="refreshRegClientsBtn">
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/></svg>
              تحديث
            </button>
            <button class="btn btn-secondary" onclick="openLookupsModal()">
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M3 5V19A9 3 0 0 0 21 19V5"/></svg>
              الوكالات
            </button>
            <button class="btn btn-secondary" onclick="promptBroadcast()">
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m22 2-7 20-4-9-9-4Z"/></svg>
              رسالة جماعية
            </button>
            <button class="btn btn-primary" id="addRegClientBtn">
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" x2="19" y1="8" y2="14"/><line x1="22" x2="16" y1="11" y2="11"/></svg>
              إضافة عميل
            </button>
          </div>
        </div>

        <div class="search-box">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
          <input type="text" id="searchRegClientInput" placeholder="بحث بالاسم أو ID أو الهاتف..." data-testid="search-clients">
        </div>

        <div class="stats-grid" id="clientsStats"></div>

        <div class="table-container">
          <table class="data-table" id="registeredClientsTable">
            <thead>
              <tr>
                <th>الاسم</th>
                <th>IDs</th>
                <th>الهاتف</th>
                <th>الوكالة</th>
                <th>إجراءات</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="mobile-cards" id="registeredClientsMobile"></div>
      </div>

      <!-- Linked Clients Tab -->
      <div id="linked" class="tab-content" data-testid="linked-tab">
        <div class="page-header">
          <div>
            <div class="page-title">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
              العملاء المربوطين
            </div>
            <div class="page-subtitle">العملاء المتصلين عبر واتساب</div>
          </div>
          <button class="btn btn-secondary" id="refreshLinkedClientsBtn">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/></svg>
            تحديث
          </button>
        </div>

        <div class="table-container">
          <table class="data-table" id="linkedClientsTable">
            <thead>
              <tr>
                <th>رقم واتساب</th>
                <th>الاسم</th>
                <th>الحالة</th>
                <th>آخر تواصل</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="mobile-cards" id="linkedClientsMobile"></div>
      </div>

      <!-- Salary Tab -->
      <div id="salary" class="tab-content" data-testid="salary-tab">
        <div class="page-header">
          <div>
            <div class="page-title">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect width="20" height="14" x="2" y="5" rx="2"/><line x1="2" x2="22" y1="10" y2="10"/></svg>
              إدارة الرواتب
            </div>
            <div class="page-subtitle">رفع وإدارة ملفات الرواتب</div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">رفع ملف رواتب جديد</div>
          </div>

          <div class="file-upload-area" id="fileUploadArea">
            <input type="file" id="salaryFile" accept=".csv,.xlsx,.xls" style="display: none;">
            <svg class="file-upload-icon" xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/>
            </svg>
            <div class="file-upload-text">اضغط أو اسحب الملف هنا</div>
            <div class="file-upload-hint">CSV, Excel (حد أقصى 10MB)</div>
          </div>

          <div id="uploadPreview" class="hidden" style="margin-top: 16px;">
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">اسم الفترة</label>
                <input type="text" class="form-input" id="periodName" placeholder="مثال: يناير 2026">
              </div>
              <div class="form-group">
                <label class="form-label">نسبة الخصم (%)</label>
                <input type="number" class="form-input" id="uploadAgencyPercent" value="0" step="0.1">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">عمود ID</label>
                <select class="form-select" id="idColumn"></select>
              </div>
              <div class="form-group">
                <label class="form-label">عمود الراتب</label>
                <select class="form-select" id="salaryColumn"></select>
              </div>
            </div>
            <div id="previewTable" style="margin: 16px 0; max-height: 200px; overflow: auto;"></div>
            <div style="display: flex; gap: 10px;">
              <button class="btn btn-primary" id="uploadBtn">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="16 16 12 12 8 16"/><line x1="12" x2="12" y1="12" y2="21"/><path d="M20.39 18.39A5 5 0 0 0 18 9h-1.26A8 8 0 1 0 3 16.3"/></svg>
                رفع الملف
              </button>
              <button class="btn btn-secondary" id="cancelUploadBtn">إلغاء</button>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">فترات الرواتب</div>
          </div>
          <div id="periodsList"></div>
        </div>
      </div>

      <!-- Notifications Tab -->
      <div id="notifications" class="tab-content" data-testid="notifications-tab">
        <div class="page-header">
          <div>
            <div class="page-title">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></svg>
              الإشعارات
            </div>
            <div class="page-subtitle">إرسال إشعارات للعملاء</div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">إرسال إشعار جديد</div>
          </div>
          <form id="notificationForm">
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">العنوان</label>
                <input type="text" class="form-input" id="notifTitle" placeholder="عنوان الإشعار" required>
              </div>
              <div class="form-group">
                <label class="form-label">النوع</label>
                <select class="form-select" id="notifType">
                  <option value="info">معلومات</option>
                  <option value="success">نجاح</option>
                  <option value="warning">تحذير</option>
                  <option value="celebration">احتفال</option>
                </select>
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">الرسالة</label>
              <textarea class="form-textarea" id="notifMessage" placeholder="نص الإشعار..." required></textarea>
            </div>
            <div class="form-group">
              <label class="form-label">الفئة المستهدفة</label>
              <select class="form-select" id="notifTarget">
                <option value="all">جميع العملاء</option>
              </select>
            </div>
            <button type="submit" class="btn btn-primary">
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m22 2-7 20-4-9-9-4Z"/></svg>
              إرسال الإشعار
            </button>
          </form>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">الإشعارات المرسلة</div>
          </div>
          <div id="notificationsList"></div>
        </div>
      </div>

      <!-- Chats Tab -->
      <div id="chats" class="tab-content" data-testid="chats-tab">
        <div class="page-header">
          <div>
            <div class="page-title">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M7.9 20A9 9 0 1 0 4 16.1L2 22Z"/></svg>
              الدردشات الحية
            </div>
            <div class="page-subtitle">تواصل مباشر مع العملاء</div>
          </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 16px;">
          <div class="card" style="margin-bottom: 0;">
            <div class="card-header">
              <div class="card-title">المحادثات</div>
            </div>
            <div class="chat-list" id="chatsList"></div>
          </div>

          <div class="card" style="margin-bottom: 0;">
            <div class="card-header">
              <div class="card-title" id="currentChatTitle">اختر محادثة</div>
            </div>
            <div class="chat-messages-container" id="chatMessagesContainer"></div>
            <div style="display: flex; gap: 8px;">
              <input type="text" class="form-input" id="adminChatInput" placeholder="اكتب رسالتك..." style="flex: 1;">
              <button class="btn btn-primary" onclick="sendAdminChatMessage()">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m22 2-7 20-4-9-9-4Z"/></svg>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Tickets Tab -->
      <div id="tickets" class="tab-content" data-testid="tickets-tab">
        <div class="page-header">
          <div>
            <div class="page-title">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 9a3 3 0 0 1 0 6v2a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-2a3 3 0 0 1 0-6V7a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2Z"/></svg>
              تذاكر الدعم
            </div>
            <div class="page-subtitle">طلبات ومشاكل العملاء</div>
          </div>
        </div>

        <div class="stats-grid" id="ticketsStats"></div>
        <div id="ticketsList"></div>
      </div>

      <!-- Knowledge Tab -->
      <div id="knowledge" class="tab-content" data-testid="knowledge-tab">
        <div class="page-header">
          <div>
            <div class="page-title">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"/></svg>
              قاعدة المعرفة
            </div>
            <div class="page-subtitle">أسئلة شائعة وإجابات جاهزة</div>
          </div>
          <button class="btn btn-danger btn-sm" onclick="resetKnowledge()">
            إعادة تعيين
          </button>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">إضافة سؤال جديد</div>
          </div>
          <form id="knowledgeForm">
            <div class="form-group">
              <label class="form-label">السؤال</label>
              <input type="text" class="form-input" id="kbQuestion" placeholder="مثال: كيف أعرف راتبي؟" required>
            </div>
            <div class="form-group">
              <label class="form-label">الإجابة</label>
              <textarea class="form-textarea" id="kbAnswer" placeholder="الإجابة..." required></textarea>
            </div>
            <div class="form-group">
              <label class="form-label">كلمات مفتاحية (مفصولة بفاصلة)</label>
              <input type="text" class="form-input" id="kbKeywords" placeholder="راتب, معاش, فلوس">
            </div>
            <button type="submit" class="btn btn-primary">
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
              إضافة
            </button>
          </form>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">الأسئلة الحالية</div>
          </div>
          <div id="knowledgeList"></div>
        </div>
      </div>

      <!-- Usage Tab -->
      <div id="usage" class="tab-content" data-testid="usage-tab">
        <div class="page-header">
          <div>
            <div class="page-title">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" x2="12" y1="20" y2="10"/><line x1="18" x2="18" y1="20" y2="4"/><line x1="6" x2="6" y1="20" y2="16"/></svg>
              الاستهلاك
            </div>
            <div class="page-subtitle">إحصائيات استخدام AI</div>
          </div>
          <div style="display: flex; gap: 8px;">
            <button class="btn btn-secondary" id="refreshUsageBtn">
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/></svg>
              تحديث
            </button>
            <button class="btn btn-danger btn-sm" id="resetUsageBtn">إعادة تعيين</button>
          </div>
        </div>

        <div class="stats-grid" id="usageStats"></div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">سجل الاستخدام</div>
          </div>
          <div class="table-container">
            <table class="data-table" id="usageTable">
              <thead>
                <tr>
                  <th>التاريخ</th>
                  <th>النوع</th>
                  <th>التوكنات</th>
                  <th>التكلفة</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Bottom Navigation (Mobile) -->
  <nav class="bottom-nav">
    <button class="bottom-nav-item active" data-tab="settings">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
      <span>إعدادات</span>
    </button>
    <button class="bottom-nav-item" data-tab="registered">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
      <span>العملاء</span>
    </button>
    <button class="bottom-nav-item" data-tab="chats">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M7.9 20A9 9 0 1 0 4 16.1L2 22Z"/></svg>
      <span>الدردشات</span>
      <span id="mobileChatsBadge" class="mobile-badge hidden">0</span>
    </button>
    <button class="bottom-nav-item" onclick="openMenuDrawer()">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg>
      <span>المزيد</span>
    </button>
  </nav>

  <!-- Menu Drawer (Mobile) -->
  <div class="menu-drawer" id="menuDrawer" onclick="closeMenuDrawer()">
    <div class="menu-drawer-content" onclick="event.stopPropagation()">
      <div class="menu-drawer-item" data-tab="salary">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect width="20" height="14" x="2" y="5" rx="2"/><line x1="2" x2="22" y1="10" y2="10"/></svg>
        الرواتب
      </div>
      <div class="menu-drawer-item" data-tab="notifications">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></svg>
        الإشعارات
      </div>
      <div class="menu-drawer-item" data-tab="tickets">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 9a3 3 0 0 1 0 6v2a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-2a3 3 0 0 1 0-6V7a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2Z"/></svg>
        التذاكر
      </div>
      <div class="menu-drawer-item" data-tab="knowledge">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"/></svg>
        قاعدة المعرفة
      </div>
      <div class="menu-drawer-item" data-tab="fields">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M3 5V19A9 3 0 0 0 21 19V5"/></svg>
        الحقول المخصصة
      </div>
      <div class="menu-drawer-item" data-tab="linked">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
        العملاء المربوطين
      </div>
      <div class="menu-drawer-item" data-tab="usage">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" x2="12" y1="20" y2="10"/><line x1="18" x2="18" y1="20" y2="4"/><line x1="6" x2="6" y1="20" y2="16"/></svg>
        الاستهلاك
      </div>
    </div>
  </div>

  <!-- Client Modal -->
  <div class="modal" id="clientModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title" id="clientModalTitle">إضافة عميل</div>
        <button class="modal-close" onclick="closeClientModal()">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
        </button>
      </div>
      <div class="modal-body">
        <form id="clientForm">
          <input type="hidden" id="editingClientKey">
          <div class="form-group">
            <label class="form-label">الاسم الكامل *</label>
            <input type="text" class="form-input" id="regFullName" required data-testid="client-name">
          </div>
          <div class="form-group">
            <label class="form-label">أرقام ID (مفصولة بفاصلة) *</label>
            <input type="text" class="form-input" id="regIds" placeholder="123456, 789012" required data-testid="client-ids">
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">الهاتف</label>
              <input type="tel" class="form-input" id="regPhone" data-testid="client-phone">
            </div>
            <div class="form-group">
              <label class="form-label">واتساب</label>
              <input type="tel" class="form-input" id="regWhatsapp" data-testid="client-whatsapp">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">الدولة</label>
              <select class="form-select" id="regCountry"></select>
            </div>
            <div class="form-group">
              <label class="form-label">المدينة</label>
              <select class="form-select" id="regCity"></select>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">العنوان</label>
            <input type="text" class="form-input" id="regAddress">
          </div>
          <div class="form-group">
            <label class="form-label">الوكالة</label>
            <select class="form-select" id="regAgency"></select>
          </div>
          <div id="customFieldsContainer"></div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeClientModal()">إلغاء</button>
        <button class="btn btn-secondary" id="clearRegFormBtn">مسح</button>
        <button class="btn btn-primary" id="saveClientBtn">حفظ</button>
      </div>
    </div>
  </div>

  <!-- Notify Modal -->
  <div class="modal" id="notifyModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">إرسال إشعار</div>
        <button class="modal-close" onclick="closeNotifyModal()">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
        </button>
      </div>
      <div class="modal-body">
        <p id="notifyClientInfo" style="font-size: 12px; color: var(--text-muted); margin-bottom: 16px;"></p>
        <div class="inner-tabs">
          <button class="inner-tab active" onclick="toggleNotifyType('salary')">إشعار الراتب</button>
          <button class="inner-tab" onclick="toggleNotifyType('custom')">رسالة مخصصة</button>
        </div>
        <div id="notifyCustomContainer" class="hidden">
          <div class="form-group">
            <label class="form-label">الرسالة</label>
            <textarea class="form-textarea" id="notifyCustomMessage" placeholder="اكتب رسالتك هنا..."></textarea>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeNotifyModal()">إلغاء</button>
        <button class="btn btn-primary" onclick="sendNotification()">إرسال</button>
      </div>
    </div>
  </div>

  <!-- Receipts Modal -->
  <div class="modal" id="receiptsModal">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <div class="modal-title" id="receiptsModalTitle">إيصالات العميل</div>
        <button class="modal-close" onclick="closeReceiptsModal()">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
        </button>
      </div>
      <div class="modal-body">
        <!-- Upload Area -->
        <div class="file-upload-area" id="receiptDropZone" style="margin-bottom: 16px;">
          <input type="file" id="receiptFile" style="display: none;">
          <svg class="file-upload-icon" xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/>
          </svg>
          <div class="file-upload-text">اسحب الملف هنا أو اضغط للاختيار</div>
          <div class="file-upload-hint">جميع أنواع الملفات مدعومة</div>
        </div>

        <div id="selectedFileInfo" class="hidden" style="background: var(--success-bg); padding: 12px; border-radius: 8px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center;">
          <span id="selectedFileName" style="color: var(--success);"></span>
          <button class="btn btn-sm btn-danger" onclick="clearSelectedFile()">إلغاء</button>
        </div>

        <div style="display: flex; gap: 8px; margin-bottom: 16px;">
          <input type="text" class="form-input" id="receiptDescription" placeholder="ملاحظة (اختياري)" style="flex: 1;">
          <button class="btn btn-primary" onclick="uploadReceipt()">رفع</button>
        </div>

        <p style="font-size: 10px; color: var(--text-dim); margin-bottom: 16px;">✅ سيتم إشعار العميل تلقائياً على واتساب</p>

        <div class="card-title" style="margin-bottom: 12px;">الإيصالات المرفوعة</div>
        <div id="receiptsList"></div>
      </div>
    </div>
  </div>

  <!-- Broadcast Modal -->
  <div class="modal" id="broadcastModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">إرسال رسالة جماعية</div>
        <button class="modal-close" onclick="closeBroadcastModal()">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">الفئة المستهدفة</label>
          <select class="form-select" id="broadcastTarget">
            <option value="all">جميع العملاء</option>
            <option value="agency">وكالة معينة</option>
          </select>
        </div>
        <div class="form-group hidden" id="broadcastAgencyGroup">
          <label class="form-label">اختر الوكالة</label>
          <select class="form-select" id="broadcastAgency"></select>
        </div>
        <div class="form-group">
          <label class="form-label">الرسالة</label>
          <textarea class="form-textarea" id="broadcastMessage" placeholder="اكتب رسالتك هنا..." rows="5"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeBroadcastModal()">إلغاء</button>
        <button class="btn btn-primary" onclick="sendBroadcast()">إرسال للجميع</button>
      </div>
    </div>
  </div>

  <!-- Lookups Modal -->
  <div class="modal" id="lookupsModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">إدارة القوائم</div>
        <button class="modal-close" onclick="closeLookupsModal()">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="inner-tabs">
          <button class="inner-tab active" onclick="switchLookupTab('agencies')">الوكالات</button>
          <button class="inner-tab" onclick="switchLookupTab('countries')">الدول</button>
        </div>
        <div id="lookupContent">
          <div id="agenciesLookup">
            <div style="display: flex; gap: 8px; margin-bottom: 12px;">
              <input type="text" class="form-input" id="newAgencyName" placeholder="اسم الوكالة">
              <button class="btn btn-primary btn-sm" onclick="addAgency()">إضافة</button>
            </div>
            <div id="agenciesList"></div>
          </div>
          <div id="countriesLookup" class="hidden">
            <div style="display: flex; gap: 8px; margin-bottom: 12px;">
              <input type="text" class="form-input" id="newCountryName" placeholder="اسم الدولة">
              <button class="btn btn-primary btn-sm" onclick="addCountry()">إضافة</button>
            </div>
            <div id="countriesList"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // =====================================================
    // NAVIGATION
    // =====================================================
    function switchTab(tabId) {
      document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
      document.querySelectorAll('.bottom-nav-item').forEach(n => n.classList.remove('active'));
      document.querySelectorAll('.menu-drawer-item').forEach(n => n.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      
      document.querySelectorAll(`[data-tab="${tabId}"]`).forEach(el => el.classList.add('active'));
      document.getElementById(tabId)?.classList.add('active');
      
      closeMenuDrawer();
    }

    document.querySelectorAll('.nav-item, .bottom-nav-item, .menu-drawer-item').forEach(item => {
      item.addEventListener('click', () => {
        const tab = item.dataset.tab;
        if (tab) switchTab(tab);
      });
    });

    function openMenuDrawer() {
      document.getElementById('menuDrawer').classList.add('active');
    }

    function closeMenuDrawer() {
      document.getElementById('menuDrawer').classList.remove('active');
    }

    // =====================================================
    // UTILITIES
    // =====================================================
    function showAlert(message, type = 'success') {
      const container = document.getElementById('alertContainer');
      container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
      setTimeout(() => container.innerHTML = '', 4000);
    }

    function getCookie(name) {
      const match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
      return match ? match[2] : null;
    }

    async function api(method, url, data = null) {
      const options = { method, credentials: 'include' };
      if (data && !(data instanceof FormData)) {
        options.headers = { 'Content-Type': 'application/json' };
        options.body = JSON.stringify(data);
      } else if (data) {
        options.body = data;
      }
      const res = await fetch(url, options);
      const json = await res.json();
      if (!res.ok) throw new Error(json.error || 'Unknown error');
      return json;
    }

    // =====================================================
    // SETTINGS
    // =====================================================
    async function loadSettings() {
      try {
        const settings = await api('GET', '/api/ai/settings');
        document.getElementById('aiEnabled').checked = settings.enabled;
        document.getElementById('openaiKey').value = settings.openaiKey || '';
        document.getElementById('modelChat').value = settings.modelChat || 'gpt-4o-mini';
        document.getElementById('modelStt').value = settings.modelStt || 'whisper-1';
        document.getElementById('modelTts').value = settings.modelTts || 'tts-1';
        document.getElementById('voiceTts').value = settings.voiceTts || 'alloy';
        document.getElementById('trustedSessionMinutes').value = settings.trustedSessionMinutes || 15;
        document.getElementById('agencyPercent').value = settings.agencyPercent || 0;
        document.getElementById('botName').value = settings.botName || 'مساعد أبو سلطان';
        document.getElementById('ownerName').value = settings.ownerName || 'أبو سلطان';
        document.getElementById('dialect').value = settings.dialect || 'سورية';
        document.getElementById('clientGender').value = settings.clientGender || 'مؤنث';
        document.getElementById('friendliness').value = settings.friendliness || 'عالي';
        document.getElementById('salaryCurrency').value = settings.salaryCurrency || 'ر.س';
        document.getElementById('adminContact').value = settings.adminContact || 'تواصلي مع الإدارة';
        document.getElementById('enableVoiceReplies').checked = settings.enableVoiceReplies || false;
        
        // AI Provider
        const provider = settings.aiProvider || 'openai';
        document.getElementById('aiProvider').value = provider;
        toggleAIProvider(provider);
        
        if (settings.openrouterKey) {
          document.getElementById('openrouterKey').value = settings.openrouterKey;
        }
        if (settings.openrouterModel) {
          document.getElementById('openrouterModel').value = settings.openrouterModel;
        }
      } catch (err) {
        showAlert('فشل تحميل الإعدادات: ' + err.message, 'error');
      }
    }

    function toggleAIProvider(provider) {
      document.getElementById('openaiSettings').classList.toggle('hidden', provider !== 'openai');
      document.getElementById('openrouterSettings').classList.toggle('hidden', provider !== 'openrouter');
    }

    document.getElementById('aiProvider').addEventListener('change', (e) => {
      toggleAIProvider(e.target.value);
    });

    document.getElementById('saveSettingsBtn').addEventListener('click', async () => {
      try {
        const provider = document.getElementById('aiProvider').value;
        const data = {
          enabled: document.getElementById('aiEnabled').checked,
          aiProvider: provider,
          modelChat: document.getElementById('modelChat').value,
          modelStt: document.getElementById('modelStt').value,
          modelTts: document.getElementById('modelTts').value,
          voiceTts: document.getElementById('voiceTts').value,
          trustedSessionMinutes: parseInt(document.getElementById('trustedSessionMinutes').value) || 15,
          agencyPercent: parseFloat(document.getElementById('agencyPercent').value) || 0,
          botName: document.getElementById('botName').value,
          ownerName: document.getElementById('ownerName').value,
          dialect: document.getElementById('dialect').value,
          clientGender: document.getElementById('clientGender').value,
          friendliness: document.getElementById('friendliness').value,
          salaryCurrency: document.getElementById('salaryCurrency').value,
          adminContact: document.getElementById('adminContact').value,
          enableVoiceReplies: document.getElementById('enableVoiceReplies').checked
        };

        const openaiKey = document.getElementById('openaiKey').value;
        if (openaiKey && !openaiKey.includes('•')) {
          data.openaiKey = openaiKey;
        }

        const openrouterKey = document.getElementById('openrouterKey').value;
        if (openrouterKey && !openrouterKey.includes('•')) {
          data.openrouterKey = openrouterKey;
        }
        
        data.openrouterModel = document.getElementById('openrouterModel').value;

        await api('POST', '/api/ai/settings', data);
        showAlert('تم حفظ الإعدادات بنجاح ✅');
      } catch (err) {
        showAlert('فشل حفظ الإعدادات: ' + err.message, 'error');
      }
    });

    // =====================================================
    // SALARY UPLOAD
    // =====================================================
    const fileUploadArea = document.getElementById('fileUploadArea');
    const salaryFileInput = document.getElementById('salaryFile');
    let uploadedFileData = null;

    fileUploadArea.addEventListener('click', () => salaryFileInput.click());
    fileUploadArea.addEventListener('dragover', e => { e.preventDefault(); fileUploadArea.classList.add('dragover'); });
    fileUploadArea.addEventListener('dragleave', () => fileUploadArea.classList.remove('dragover'));
    fileUploadArea.addEventListener('drop', e => {
      e.preventDefault();
      fileUploadArea.classList.remove('dragover');
      if (e.dataTransfer.files.length) {
        salaryFileInput.files = e.dataTransfer.files;
        handleFileSelect(e.dataTransfer.files[0]);
      }
    });

    salaryFileInput.addEventListener('change', e => {
      if (e.target.files.length) handleFileSelect(e.target.files[0]);
    });

    async function handleFileSelect(file) {
      try {
        const formData = new FormData();
        formData.append('file', file);

        const preview = await api('POST', '/api/ai/salary/upload/preview', formData);
        uploadedFileData = { file, preview };

        const idCol = document.getElementById('idColumn');
        const salaryCol = document.getElementById('salaryColumn');
        idCol.innerHTML = '';
        salaryCol.innerHTML = '';

        preview.columns.forEach(col => {
          idCol.innerHTML += `<option value="${col}">${col}</option>`;
          salaryCol.innerHTML += `<option value="${col}">${col}</option>`;
        });

        // Show preview table
        let tableHtml = '<table class="data-table"><thead><tr>';
        preview.columns.forEach(col => tableHtml += `<th>${col}</th>`);
        tableHtml += '</tr></thead><tbody>';
        preview.preview.slice(0, 5).forEach(row => {
          tableHtml += '<tr>';
          preview.columns.forEach(col => tableHtml += `<td>${row[col] || ''}</td>`);
          tableHtml += '</tr>';
        });
        tableHtml += '</tbody></table>';
        document.getElementById('previewTable').innerHTML = tableHtml;

        document.getElementById('uploadPreview').classList.remove('hidden');
        fileUploadArea.classList.add('hidden');
      } catch (err) {
        showAlert('فشل معاينة الملف: ' + err.message, 'error');
      }
    }

    document.getElementById('cancelUploadBtn').addEventListener('click', () => {
      uploadedFileData = null;
      document.getElementById('uploadPreview').classList.add('hidden');
      fileUploadArea.classList.remove('hidden');
      salaryFileInput.value = '';
    });

    document.getElementById('uploadBtn').addEventListener('click', async () => {
      if (!uploadedFileData) return;

      try {
        const formData = new FormData();
        formData.append('file', uploadedFileData.file);
        formData.append('name', document.getElementById('periodName').value);
        formData.append('idColumn', document.getElementById('idColumn').value);
        formData.append('salaryColumn', document.getElementById('salaryColumn').value);
        formData.append('agencyPercent', document.getElementById('uploadAgencyPercent').value);

        const result = await api('POST', '/api/ai/salary/upload', formData);
        showAlert(`تم رفع الملف بنجاح! (${result.period.recordCount} سجل)${result.notifiedClients ? ` - تم إشعار ${result.notifiedClients} عميل` : ''}`);
        
        uploadedFileData = null;
        document.getElementById('uploadPreview').classList.add('hidden');
        fileUploadArea.classList.remove('hidden');
        salaryFileInput.value = '';
        loadPeriods();
      } catch (err) {
        showAlert('فشل رفع الملف: ' + err.message, 'error');
      }
    });

    async function loadPeriods() {
      try {
        const periods = await api('GET', '/api/ai/salary/periods');
        const container = document.getElementById('periodsList');
        
        if (!periods.length) {
          container.innerHTML = '<div class="empty-state"><p>لا توجد فترات رواتب</p></div>';
          return;
        }

        container.innerHTML = periods.map(p => `
          <div class="period-card ${p.isCurrent ? 'current' : ''}">
            <div class="period-info">
              <h4>${p.name} ${p.isCurrent ? '<span class="badge badge-success">الحالية</span>' : ''}</h4>
              <div class="period-meta">${p.recordCount} سجل • خصم ${p.agencyPercent}%</div>
            </div>
            <div style="display: flex; gap: 6px;">
              ${!p.isCurrent ? `<button class="btn btn-sm btn-secondary" onclick="setCurrentPeriod('${p.id}')">تعيين كحالية</button>` : ''}
              <button class="btn btn-sm btn-danger" onclick="deletePeriod('${p.id}')">حذف</button>
            </div>
          </div>
        `).join('');
      } catch (err) {
        showAlert('فشل تحميل الفترات: ' + err.message, 'error');
      }
    }

    window.setCurrentPeriod = async function(id) {
      try {
        await api('POST', `/api/ai/salary/period/${id}/current`);
        showAlert('تم تعيين الفترة الحالية');
        loadPeriods();
      } catch (err) {
        showAlert(err.message, 'error');
      }
    };

    window.deletePeriod = async function(id) {
      if (!confirm('هل أنت متأكد من حذف هذه الفترة؟')) return;
      try {
        await api('DELETE', `/api/ai/salary/period/${id}`);
        showAlert('تم حذف الفترة');
        loadPeriods();
      } catch (err) {
        showAlert(err.message, 'error');
      }
    };

    // =====================================================
    // REGISTERED CLIENTS
    // =====================================================
    let allClientsData = [];

    async function loadRegisteredClients() {
      try {
        const clients = await api('GET', '/api/ai/registered-clients');
        allClientsData = Object.entries(clients).map(([key, c]) => ({ key, ...c }));
        renderClientsTable(allClientsData);
        
        // Stats
        document.getElementById('clientsStats').innerHTML = `
          <div class="stat-card">
            <div class="stat-value">${allClientsData.length}</div>
            <div class="stat-label">إجمالي العملاء</div>
          </div>
        `;
      } catch (err) {
        showAlert('فشل تحميل العملاء: ' + err.message, 'error');
      }
    }

    function renderClientsTable(clients) {
      // Desktop table
      const tbody = document.querySelector('#registeredClientsTable tbody');
      tbody.innerHTML = clients.map(c => `
        <tr>
          <td>${c.fullName || '-'}</td>
          <td>${(c.ids || []).join(', ')}</td>
          <td>${c.phone || '-'}</td>
          <td>${c.agencyName || '-'}</td>
          <td>
            <div style="display: flex; gap: 4px; flex-wrap: wrap;">
              <button class="btn btn-sm btn-secondary" onclick="editClient('${c.key}')">تعديل</button>
              <button class="btn btn-sm btn-secondary" onclick="openReceiptsModal('${c.key}', '${c.fullName}')">إيصالات</button>
              <button class="btn btn-sm btn-secondary" onclick="promptNotify('${c.key}', '${c.fullName}', '${c.phone}')">إشعار</button>
              <button class="btn btn-sm btn-danger" onclick="deleteClient('${c.key}')">حذف</button>
            </div>
          </td>
        </tr>
      `).join('');

      // Mobile cards
      document.getElementById('registeredClientsMobile').innerHTML = clients.map(c => `
        <div class="mobile-card">
          <div class="mobile-card-header">
            <div class="mobile-card-title">${c.fullName || '-'}</div>
            <span class="badge badge-info">${c.agencyName || '-'}</span>
          </div>
          <div class="mobile-card-row">
            <span class="mobile-card-label">IDs</span>
            <span class="mobile-card-value">${(c.ids || []).join(', ')}</span>
          </div>
          <div class="mobile-card-row">
            <span class="mobile-card-label">الهاتف</span>
            <span class="mobile-card-value">${c.phone || '-'}</span>
          </div>
          <div class="mobile-card-actions">
            <button class="btn btn-sm btn-secondary" onclick="editClient('${c.key}')" style="flex: 1;">تعديل</button>
            <button class="btn btn-sm btn-secondary" onclick="openReceiptsModal('${c.key}', '${c.fullName}')" style="flex: 1;">إيصالات</button>
            <button class="btn btn-sm btn-secondary" onclick="promptNotify('${c.key}', '${c.fullName}', '${c.phone}')" style="flex: 1;">إشعار</button>
            <button class="btn btn-sm btn-danger" onclick="deleteClient('${c.key}')">حذف</button>
          </div>
        </div>
      `).join('');
    }

    document.getElementById('searchRegClientInput').addEventListener('input', (e) => {
      const q = e.target.value.toLowerCase();
      const filtered = allClientsData.filter(c => 
        (c.fullName || '').toLowerCase().includes(q) ||
        (c.ids || []).some(id => id.toString().includes(q)) ||
        (c.phone || '').includes(q)
      );
      renderClientsTable(filtered);
    });

    document.getElementById('refreshRegClientsBtn').addEventListener('click', loadRegisteredClients);

    // Client Modal
    let editingClientKey = null;

    document.getElementById('addRegClientBtn').addEventListener('click', () => {
      editingClientKey = null;
      document.getElementById('clientModalTitle').textContent = 'إضافة عميل جديد';
      clearClientForm();
      document.getElementById('clientModal').classList.add('active');
      renderCustomFieldsInForm();
    });

    function closeClientModal() {
      document.getElementById('clientModal').classList.remove('active');
    }

    function clearClientForm() {
      document.getElementById('editingClientKey').value = '';
      document.getElementById('regFullName').value = '';
      document.getElementById('regIds').value = '';
      document.getElementById('regPhone').value = '';
      document.getElementById('regWhatsapp').value = '';
      document.getElementById('regAddress').value = '';
    }

    document.getElementById('clearRegFormBtn').addEventListener('click', clearClientForm);

    window.editClient = async function(key) {
      const client = allClientsData.find(c => c.key === key);
      if (!client) return;
      
      editingClientKey = key;
      document.getElementById('clientModalTitle').textContent = 'تعديل بيانات العميل';
      document.getElementById('editingClientKey').value = key;
      document.getElementById('regFullName').value = client.fullName || '';
      document.getElementById('regIds').value = (client.ids || []).join(', ');
      document.getElementById('regPhone').value = client.phone || '';
      document.getElementById('regWhatsapp').value = client.whatsappPhone || '';
      document.getElementById('regCountry').value = client.country || '';
      document.getElementById('regCity').value = client.city || '';
      document.getElementById('regAddress').value = client.address || '';
      document.getElementById('regAgency').value = client.agencyName || '';
      
      await renderCustomFieldsInForm();
      
      // Fill custom fields
      const customFields = client.customFields || {};
      Object.entries(customFields).forEach(([key, value]) => {
        const input = document.getElementById(`custom_${key}`);
        if (input) input.value = value || '';
      });
      
      document.getElementById('clientModal').classList.add('active');
    };

    document.getElementById('saveClientBtn').addEventListener('click', async () => {
      try {
        const ids = document.getElementById('regIds').value.split(',').map(id => id.trim()).filter(Boolean);
        if (!ids.length) {
          showAlert('يرجى إدخال رقم ID واحد على الأقل', 'error');
          return;
        }

        const data = {
          fullName: document.getElementById('regFullName').value,
          ids,
          phone: document.getElementById('regPhone').value,
          whatsappPhone: document.getElementById('regWhatsapp').value,
          country: document.getElementById('regCountry').value,
          city: document.getElementById('regCity').value,
          address: document.getElementById('regAddress').value,
          agencyName: document.getElementById('regAgency').value,
          customFields: {}
        };

        // Get custom fields
        document.querySelectorAll('[id^="custom_"]').forEach(input => {
          const key = input.id.replace('custom_', '');
          data.customFields[key] = input.value;
        });

        if (editingClientKey) {
          await api('PUT', `/api/ai/registered-clients/${editingClientKey}`, data);
          showAlert('تم تحديث بيانات العميل');
        } else {
          await api('POST', '/api/ai/registered-clients', data);
          showAlert('تم إضافة العميل بنجاح');
        }

        closeClientModal();
        loadRegisteredClients();
      } catch (err) {
        showAlert(err.message, 'error');
      }
    });

    window.deleteClient = async function(key) {
      if (!confirm('هل أنت متأكد من حذف هذا العميل؟')) return;
      try {
        await api('DELETE', `/api/ai/registered-clients/${key}`);
        showAlert('تم حذف العميل');
        loadRegisteredClients();
      } catch (err) {
        showAlert(err.message, 'error');
      }
    };

    // =====================================================
    // LINKED CLIENTS
    // =====================================================
    async function loadLinkedClients() {
      try {
        const clients = await api('GET', '/api/ai/clients');
        const tbody = document.querySelector('#linkedClientsTable tbody');
        const mobile = document.getElementById('linkedClientsMobile');
        
        if (!clients.length) {
          tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: var(--text-muted);">لا يوجد عملاء مربوطين</td></tr>';
          mobile.innerHTML = '<div class="empty-state"><p>لا يوجد عملاء مربوطين</p></div>';
          return;
        }

        tbody.innerHTML = clients.map(c => `
          <tr>
            <td>${c.phone || '-'}</td>
            <td>${c.name || '-'}</td>
            <td><span class="badge badge-success">متصل</span></td>
            <td>${c.lastSeen ? new Date(c.lastSeen).toLocaleString('ar') : '-'}</td>
          </tr>
        `).join('');

        mobile.innerHTML = clients.map(c => `
          <div class="mobile-card">
            <div class="mobile-card-header">
              <div class="mobile-card-title">${c.name || c.phone}</div>
              <span class="badge badge-success">متصل</span>
            </div>
            <div class="mobile-card-row">
              <span class="mobile-card-label">واتساب</span>
              <span class="mobile-card-value">${c.phone || '-'}</span>
            </div>
          </div>
        `).join('');
      } catch (err) {
        showAlert('فشل تحميل العملاء المربوطين: ' + err.message, 'error');
      }
    }

    document.getElementById('refreshLinkedClientsBtn').addEventListener('click', loadLinkedClients);

    // =====================================================
    // CHATS
    // =====================================================
    let currentChatClientKey = null;
    let chatRefreshInterval = null;

    async function loadChats() {
      try {
        const chats = await api('GET', '/api/ai/chats');
        const container = document.getElementById('chatsList');
        
        let unreadTotal = 0;
        const chatEntries = Object.entries(chats);
        
        if (!chatEntries.length) {
          container.innerHTML = '<div class="empty-state"><p>لا توجد محادثات</p></div>';
          updateChatBadge(0);
          return;
        }

        container.innerHTML = chatEntries.map(([clientKey, chat]) => {
          const lastMsg = chat.messages?.[chat.messages.length - 1];
          const isUnread = chat.unread;
          if (isUnread) unreadTotal++;
          
          return `
            <div class="chat-item ${isUnread ? 'unread' : ''}" onclick="openChat('${clientKey}', '${chat.clientName || 'عميل'}')">
              <div class="chat-avatar">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
              </div>
              <div class="chat-info">
                <div class="chat-name">${chat.clientName || 'عميل'}</div>
                <div class="chat-preview">${lastMsg?.message || ''}</div>
              </div>
              ${isUnread ? '<div class="badge badge-danger" style="width: 8px; height: 8px; padding: 0; border-radius: 50%;"></div>' : ''}
            </div>
          `;
        }).join('');

        updateChatBadge(unreadTotal);
      } catch (err) {
        console.error('Failed to load chats:', err);
      }
    }

    function updateChatBadge(count) {
      const desktopBadge = document.getElementById('chatsBadge');
      const mobileBadge = document.getElementById('mobileChatsBadge');
      
      if (count > 0) {
        desktopBadge.textContent = count;
        desktopBadge.classList.remove('hidden');
        mobileBadge.textContent = count;
        mobileBadge.classList.remove('hidden');
      } else {
        desktopBadge.classList.add('hidden');
        mobileBadge.classList.add('hidden');
      }
    }

    window.openChat = async function(clientKey, clientName) {
      currentChatClientKey = clientKey;
      document.getElementById('currentChatTitle').textContent = clientName;
      await loadChatMessages(clientKey);
      
      // Mark as read
      try {
        await api('POST', `/api/ai/chats/${clientKey}/read`);
        loadChats();
      } catch {}
    };

    async function loadChatMessages(clientKey) {
      try {
        const result = await api('GET', `/api/ai/chats/${clientKey}/messages`);
        const container = document.getElementById('chatMessagesContainer');
        
        if (!result.messages?.length) {
          container.innerHTML = '<div class="empty-state"><p>لا توجد رسائل</p></div>';
          return;
        }

        container.innerHTML = result.messages.map(m => {
          const time = new Date(m.timestamp).toLocaleTimeString('ar', { hour: '2-digit', minute: '2-digit' });
          return `
            <div class="chat-bubble ${m.sender}">
              ${m.message}
              <div class="chat-bubble-time">${time}</div>
            </div>
          `;
        }).join('');

        container.scrollTop = container.scrollHeight;
      } catch (err) {
        console.error('Failed to load messages:', err);
      }
    }

    window.sendAdminChatMessage = async function() {
      const input = document.getElementById('adminChatInput');
      const message = input.value.trim();
      if (!message || !currentChatClientKey) return;

      try {
        input.disabled = true;
        await api('POST', `/api/ai/chats/${currentChatClientKey}/messages`, { message });
        input.value = '';
        await loadChatMessages(currentChatClientKey);
      } catch (err) {
        showAlert('فشل إرسال الرسالة', 'error');
      } finally {
        input.disabled = false;
        input.focus();
      }
    };

    document.getElementById('adminChatInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendAdminChatMessage();
    });

    // =====================================================
    // NOTIFICATIONS
    // =====================================================
    async function loadNotifications() {
      try {
        const notifications = await api('GET', '/api/ai/notifications');
        const container = document.getElementById('notificationsList');
        
        if (!notifications.length) {
          container.innerHTML = '<div class="empty-state"><p>لا توجد إشعارات</p></div>';
          return;
        }

        container.innerHTML = notifications.slice(0, 20).map(n => `
          <div class="ticket-item">
            <div class="ticket-header">
              <span class="ticket-subject">${n.title}</span>
              <span class="badge badge-${n.type === 'success' ? 'success' : n.type === 'warning' ? 'warning' : 'info'}">${n.type}</span>
            </div>
            <div class="ticket-message">${n.message}</div>
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <span style="font-size: 10px; color: var(--text-dim);">${new Date(n.createdAt).toLocaleString('ar')}</span>
              <button class="btn btn-sm btn-danger" onclick="deleteNotification('${n.id}')">حذف</button>
            </div>
          </div>
        `).join('');
      } catch (err) {
        showAlert('فشل تحميل الإشعارات', 'error');
      }
    }

    window.deleteNotification = async function(id) {
      try {
        await api('DELETE', `/api/ai/notifications/${id}`);
        loadNotifications();
      } catch (err) {
        showAlert(err.message, 'error');
      }
    };

    document.getElementById('notificationForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      try {
        await api('POST', '/api/ai/notifications', {
          title: document.getElementById('notifTitle').value,
          message: document.getElementById('notifMessage').value,
          type: document.getElementById('notifType').value,
          targetClients: [document.getElementById('notifTarget').value]
        });
        showAlert('تم إرسال الإشعار');
        e.target.reset();
        loadNotifications();
      } catch (err) {
        showAlert(err.message, 'error');
      }
    });

    async function loadNotificationTargets() {
      try {
        const clients = await api('GET', '/api/ai/registered-clients');
        const select = document.getElementById('notifTarget');
        select.innerHTML = '<option value="all">جميع العملاء</option>';
        Object.entries(clients).forEach(([key, c]) => {
          select.innerHTML += `<option value="${key}">${c.fullName}</option>`;
        });
      } catch {}
    }

    // =====================================================
    // TICKETS
    // =====================================================
    async function loadTickets() {
      try {
        const result = await api('GET', '/api/ai/tickets');
        const tickets = result.tickets || [];
        const container = document.getElementById('ticketsList');
        
        const openCount = tickets.filter(t => t.status === 'open').length;
        document.getElementById('ticketsStats').innerHTML = `
          <div class="stat-card">
            <div class="stat-value">${tickets.length}</div>
            <div class="stat-label">إجمالي التذاكر</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" style="color: var(--warning);">${openCount}</div>
            <div class="stat-label">مفتوحة</div>
          </div>
        `;
        
        // Update badge
        const badge = document.getElementById('ticketsBadge');
        if (openCount > 0) {
          badge.textContent = openCount;
          badge.classList.remove('hidden');
        } else {
          badge.classList.add('hidden');
        }

        if (!tickets.length) {
          container.innerHTML = '<div class="empty-state"><p>لا توجد تذاكر</p></div>';
          return;
        }

        container.innerHTML = tickets.map(t => `
          <div class="ticket-item">
            <div class="ticket-header">
              <span class="ticket-subject">${t.subject}</span>
              <span class="badge badge-${t.status === 'open' ? 'warning' : t.status === 'resolved' ? 'success' : 'info'}">${t.status === 'open' ? 'مفتوحة' : t.status === 'resolved' ? 'محلولة' : 'مغلقة'}</span>
            </div>
            <div class="ticket-message">${t.message}</div>
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 8px;">
              <span style="font-size: 10px; color: var(--text-dim);">${new Date(t.createdAt).toLocaleString('ar')}</span>
              <div style="display: flex; gap: 4px;">
                ${t.status === 'open' ? `<button class="btn btn-sm btn-primary" onclick="updateTicketStatus('${t.id}', 'resolved')">حل</button>` : ''}
                <button class="btn btn-sm btn-danger" onclick="deleteTicket('${t.id}')">حذف</button>
              </div>
            </div>
          </div>
        `).join('');
      } catch (err) {
        showAlert('فشل تحميل التذاكر', 'error');
      }
    }

    window.updateTicketStatus = async function(id, status) {
      try {
        await api('PUT', `/api/ai/tickets/${id}`, { status });
        loadTickets();
      } catch (err) {
        showAlert(err.message, 'error');
      }
    };

    window.deleteTicket = async function(id) {
      if (!confirm('حذف هذه التذكرة؟')) return;
      try {
        await api('DELETE', `/api/ai/tickets/${id}`);
        loadTickets();
      } catch (err) {
        showAlert(err.message, 'error');
      }
    };

    // =====================================================
    // KNOWLEDGE BASE
    // =====================================================
    async function loadKnowledge() {
      try {
        const items = await api('GET', '/api/ai/knowledge');
        const container = document.getElementById('knowledgeList');
        
        if (!items.length) {
          container.innerHTML = '<div class="empty-state"><p>لا توجد أسئلة في قاعدة المعرفة</p></div>';
          return;
        }

        container.innerHTML = items.map(item => `
          <div class="knowledge-item ${!item.active ? 'inactive' : ''}">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
              <div class="knowledge-question">${item.question}</div>
              <div style="display: flex; gap: 4px;">
                <button class="btn btn-sm btn-secondary" onclick="toggleKnowledge('${item.id}', ${!item.active})">${item.active ? 'تعطيل' : 'تفعيل'}</button>
                <button class="btn btn-sm btn-danger" onclick="deleteKnowledge('${item.id}')">حذف</button>
              </div>
            </div>
            <div class="knowledge-answer">${item.answer}</div>
          </div>
        `).join('');
      } catch (err) {
        showAlert('فشل تحميل قاعدة المعرفة', 'error');
      }
    }

    window.toggleKnowledge = async function(id, active) {
      try {
        await api('PUT', `/api/ai/knowledge/${id}`, { active });
        loadKnowledge();
      } catch (err) {
        showAlert(err.message, 'error');
      }
    };

    window.deleteKnowledge = async function(id) {
      if (!confirm('حذف هذا السؤال؟')) return;
      try {
        await api('DELETE', `/api/ai/knowledge/${id}`);
        loadKnowledge();
      } catch (err) {
        showAlert(err.message, 'error');
      }
    };

    window.resetKnowledge = async function() {
      if (!confirm('إعادة تعيين قاعدة المعرفة للأسئلة الافتراضية؟')) return;
      try {
        await api('POST', '/api/ai/knowledge/reset');
        showAlert('تم إعادة التعيين');
        loadKnowledge();
      } catch (err) {
        showAlert(err.message, 'error');
      }
    };

    document.getElementById('knowledgeForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      try {
        await api('POST', '/api/ai/knowledge', {
          question: document.getElementById('kbQuestion').value,
          answer: document.getElementById('kbAnswer').value,
          keywords: document.getElementById('kbKeywords').value.split(',').map(k => k.trim()).filter(Boolean)
        });
        showAlert('تم إضافة السؤال');
        e.target.reset();
        loadKnowledge();
      } catch (err) {
        showAlert(err.message, 'error');
      }
    });

    // =====================================================
    // USAGE
    // =====================================================
    async function loadUsage() {
      try {
        const usage = await api('GET', '/api/ai/usage');
        
        document.getElementById('usageStats').innerHTML = `
          <div class="stat-card">
            <div class="stat-value">${(usage.totalTokens || 0).toLocaleString()}</div>
            <div class="stat-label">إجمالي التوكنات</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">$${(usage.totalCost || 0).toFixed(4)}</div>
            <div class="stat-label">التكلفة الإجمالية</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${usage.requestCount || 0}</div>
            <div class="stat-label">عدد الطلبات</div>
          </div>
        `;

        const tbody = document.querySelector('#usageTable tbody');
        if (!usage.logs?.length) {
          tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: var(--text-muted);">لا يوجد سجل</td></tr>';
          return;
        }

        tbody.innerHTML = usage.logs.slice(0, 50).map(log => `
          <tr>
            <td>${new Date(log.timestamp).toLocaleString('ar')}</td>
            <td>${log.type || 'chat'}</td>
            <td>${log.tokens || 0}</td>
            <td>$${(log.cost || 0).toFixed(6)}</td>
          </tr>
        `).join('');
      } catch (err) {
        showAlert('فشل تحميل الاستهلاك', 'error');
      }
    }

    document.getElementById('refreshUsageBtn').addEventListener('click', loadUsage);
    document.getElementById('resetUsageBtn').addEventListener('click', async () => {
      if (!confirm('إعادة تعيين سجل الاستهلاك؟')) return;
      try {
        await api('POST', '/api/ai/usage/reset');
        showAlert('تم إعادة التعيين');
        loadUsage();
      } catch (err) {
        showAlert(err.message, 'error');
      }
    });

    // =====================================================
    // CUSTOM FIELDS
    // =====================================================
    let editingFieldId = null;

    async function loadCustomFields() {
      try {
        const fields = await api('GET', '/api/ai/custom-fields');
        const container = document.getElementById('fieldsList');
        
        if (!fields.length) {
          container.innerHTML = '<div class="empty-state"><p>لا توجد حقول مخصصة</p></div>';
          return;
        }

        container.innerHTML = fields.map(f => `
          <div class="period-card">
            <div class="period-info">
              <h4>${f.name}</h4>
              <div class="period-meta">${f.type === 'dropdown' ? 'قائمة منسدلة' : f.type === 'number' ? 'رقم' : 'نص'}</div>
            </div>
            <div style="display: flex; gap: 6px;">
              <button class="btn btn-sm btn-secondary" onclick="editField('${f.id}')">تعديل</button>
              <button class="btn btn-sm btn-danger" onclick="deleteField('${f.id}')">حذف</button>
            </div>
          </div>
        `).join('');
      } catch (err) {
        showAlert('فشل تحميل الحقول', 'error');
      }
    }

    document.getElementById('refreshFieldsBtn').addEventListener('click', loadCustomFields);

    document.getElementById('fieldType').addEventListener('change', function() {
      document.getElementById('dropdownOptionsContainer').classList.toggle('hidden', this.value !== 'dropdown');
    });

    window.addDropdownOptionInputWithSubField = function(value = '', subType = '', subLabel = '') {
      const container = document.getElementById('dropdownOptions');
      const div = document.createElement('div');
      div.className = 'dropdown-option';
      div.innerHTML = `
        <input type="text" class="form-input" placeholder="قيمة الخيار" value="${value}" style="flex: 1;">
        <select class="form-select" style="width: 100px;">
          <option value="">بدون حقل فرعي</option>
          <option value="text" ${subType === 'text' ? 'selected' : ''}>نص</option>
          <option value="number" ${subType === 'number' ? 'selected' : ''}>رقم</option>
        </select>
        <input type="text" class="form-input" placeholder="اسم الحقل الفرعي" value="${subLabel}" style="width: 120px;">
        <button type="button" class="btn btn-sm btn-danger" onclick="this.parentElement.remove()">×</button>
      `;
      container.appendChild(div);
    };

    function cancelEdit() {
      editingFieldId = null;
      document.getElementById('fieldName').value = '';
      document.getElementById('fieldType').value = 'text';
      document.getElementById('dropdownOptions').innerHTML = '';
      document.getElementById('dropdownOptionsContainer').classList.add('hidden');
      document.getElementById('cancelEditFieldBtn').classList.add('hidden');
    }

    window.editField = async function(id) {
      try {
        const fields = await api('GET', '/api/ai/custom-fields');
        const field = fields.find(f => f.id === id);
        if (!field) return;

        editingFieldId = id;
        document.getElementById('fieldName').value = field.name;
        document.getElementById('fieldType').value = field.type;
        document.getElementById('cancelEditFieldBtn').classList.remove('hidden');

        if (field.type === 'dropdown') {
          document.getElementById('dropdownOptionsContainer').classList.remove('hidden');
          document.getElementById('dropdownOptions').innerHTML = '';
          (field.options || []).forEach(opt => {
            if (typeof opt === 'object') {
              addDropdownOptionInputWithSubField(opt.value, opt.subType, opt.subLabel);
            } else {
              addDropdownOptionInputWithSubField(opt);
            }
          });
        }
      } catch (err) {
        showAlert(err.message, 'error');
      }
    };

    window.deleteField = async function(id) {
      if (!confirm('حذف هذا الحقل؟')) return;
      try {
        await api('DELETE', `/api/ai/custom-fields/${id}`);
        showAlert('تم حذف الحقل');
        loadCustomFields();
      } catch (err) {
        showAlert(err.message, 'error');
      }
    };

    document.getElementById('addFieldBtn').addEventListener('click', async () => {
      try {
        const name = document.getElementById('fieldName').value.trim();
        const type = document.getElementById('fieldType').value;

        if (!name) {
          showAlert('يرجى إدخال اسم الحقل', 'error');
          return;
        }

        let options = [];
        if (type === 'dropdown') {
          document.querySelectorAll('#dropdownOptions .dropdown-option').forEach(row => {
            const inputs = row.querySelectorAll('input');
            const select = row.querySelector('select');
            const value = inputs[0].value.trim();
            const subType = select.value;
            const subLabel = inputs[1].value.trim();
            
            if (value) {
              if (subType) {
                options.push({ value, subType, subLabel });
              } else {
                options.push(value);
              }
            }
          });
        }

        const data = { name, type, options };

        if (editingFieldId) {
          await api('PUT', `/api/ai/custom-fields/${editingFieldId}`, data);
          showAlert('تم تحديث الحقل');
        } else {
          await api('POST', '/api/ai/custom-fields', data);
          showAlert('تم إضافة الحقل');
        }

        cancelEdit();
        loadCustomFields();
      } catch (err) {
        showAlert(err.message, 'error');
      }
    });

    async function renderCustomFieldsInForm() {
      try {
        const fields = await api('GET', '/api/ai/custom-fields');
        const container = document.getElementById('customFieldsContainer');
        
        container.innerHTML = fields.map(f => {
          if (f.type === 'dropdown') {
            return `
              <div class="form-group">
                <label class="form-label">${f.name}</label>
                <select class="form-select" id="custom_${f.id}" onchange="handleDropdownSubField(this, '${f.id}')">
                  <option value="">اختر...</option>
                  ${(f.options || []).map(opt => {
                    const val = typeof opt === 'object' ? opt.value : opt;
                    return `<option value="${val}" data-sub-type="${opt.subType || ''}" data-sub-label="${opt.subLabel || ''}">${val}</option>`;
                  }).join('')}
                </select>
                <div id="subField_${f.id}"></div>
              </div>
            `;
          } else {
            return `
              <div class="form-group">
                <label class="form-label">${f.name}</label>
                <input type="${f.type === 'number' ? 'number' : 'text'}" class="form-input" id="custom_${f.id}">
              </div>
            `;
          }
        }).join('');
      } catch {}
    }

    window.handleDropdownSubField = function(selectEl, fieldKey) {
      const selected = selectEl.options[selectEl.selectedIndex];
      const subType = selected.dataset.subType;
      const subLabel = selected.dataset.subLabel;
      const container = document.getElementById(`subField_${fieldKey}`);
      
      if (subType) {
        container.innerHTML = `
          <div class="form-group" style="margin-top: 8px;">
            <label class="form-label">${subLabel || 'تفاصيل إضافية'}</label>
            <input type="${subType === 'number' ? 'number' : 'text'}" class="form-input" id="custom_${fieldKey}__sub">
          </div>
        `;
      } else {
        container.innerHTML = '';
      }
    };

    // =====================================================
    // LOOKUPS
    // =====================================================
    let globalLookups = { agencies: [], countries: [] };

    async function loadLookups() {
      try {
        globalLookups = await api('GET', '/api/ai/lookups');
        renderLookupSelects();
      } catch {}
    }

    function renderLookupSelects() {
      const agencySelect = document.getElementById('regAgency');
      const countrySelect = document.getElementById('regCountry');
      
      agencySelect.innerHTML = '<option value="">اختر الوكالة</option>';
      (globalLookups.agencies || []).forEach(a => {
        agencySelect.innerHTML += `<option value="${a}">${a}</option>`;
      });

      countrySelect.innerHTML = '<option value="">اختر الدولة</option>';
      (globalLookups.countries || []).forEach(c => {
        const name = typeof c === 'object' ? c.name : c;
        countrySelect.innerHTML += `<option value="${name}">${name}</option>`;
      });
    }

    document.getElementById('regCountry')?.addEventListener('change', function() {
      const citySelect = document.getElementById('regCity');
      const country = globalLookups.countries?.find(c => (typeof c === 'object' ? c.name : c) === this.value);
      
      citySelect.innerHTML = '<option value="">اختر المدينة</option>';
      if (country && country.cities) {
        country.cities.forEach(city => {
          citySelect.innerHTML += `<option value="${city}">${city}</option>`;
        });
      }
    });

    // =====================================================
    // NOTIFY CLIENT
    // =====================================================
    let currentNotifyClientKey = null;
    let currentNotifyPhone = null;
    let notifyType = 'salary';

    window.promptNotify = function(key, name, phone) {
      currentNotifyClientKey = key;
      currentNotifyPhone = phone;
      document.getElementById('notifyClientInfo').textContent = `إرسال إشعار لـ: ${name}`;
      document.getElementById('notifyModal').classList.add('active');
    };

    function closeNotifyModal() {
      document.getElementById('notifyModal').classList.remove('active');
      currentNotifyClientKey = null;
    }

    window.toggleNotifyType = function(type) {
      notifyType = type;
      document.querySelectorAll('.inner-tab').forEach(t => t.classList.remove('active'));
      event.target.classList.add('active');
      document.getElementById('notifyCustomContainer').classList.toggle('hidden', type !== 'custom');
    };

    window.sendNotification = async function() {
      try {
        if (notifyType === 'salary') {
          await api('POST', '/api/ai/notify/salary', { clientKey: currentNotifyClientKey });
          showAlert('تم إرسال إشعار الراتب');
        } else {
          const message = document.getElementById('notifyCustomMessage').value;
          if (!message) {
            showAlert('يرجى كتابة الرسالة', 'error');
            return;
          }
          await api('POST', '/api/ai/notify/custom', { phone: currentNotifyPhone, message });
          showAlert('تم إرسال الرسالة');
        }
        closeNotifyModal();
      } catch (err) {
        showAlert(err.message, 'error');
      }
    };

    // =====================================================
    // OPENROUTER MODELS
    // =====================================================
    window.loadOpenRouterModels = async function() {
      try {
        showAlert('جاري تحميل الموديلات...');
        const res = await fetch('https://openrouter.ai/api/v1/models');
        const data = await res.json();
        
        const select = document.getElementById('openrouterModel');
        select.innerHTML = '';
        
        data.data.sort((a, b) => a.id.localeCompare(b.id)).forEach(model => {
          select.innerHTML += `<option value="${model.id}">${model.id}</option>`;
        });
        
        showAlert(`تم تحميل ${data.data.length} موديل`);
      } catch (err) {
        showAlert('فشل تحميل الموديلات', 'error');
      }
    };

    // =====================================================
    // RECEIPTS
    // =====================================================
    let currentReceiptsClientKey = null;
    let selectedReceiptFile = null;

    window.openReceiptsModal = async function(clientKey, clientName) {
      currentReceiptsClientKey = clientKey;
      document.getElementById('receiptsModalTitle').textContent = `إيصالات: ${clientName}`;
      document.getElementById('receiptsModal').classList.add('active');
      clearSelectedFile();
      await loadClientReceipts();
    };

    function closeReceiptsModal() {
      document.getElementById('receiptsModal').classList.remove('active');
      currentReceiptsClientKey = null;
      selectedReceiptFile = null;
    }

    // Receipt file handling
    const receiptDropZone = document.getElementById('receiptDropZone');
    const receiptFileInput = document.getElementById('receiptFile');

    if (receiptDropZone) {
      receiptDropZone.addEventListener('click', () => receiptFileInput.click());
      receiptDropZone.addEventListener('dragover', e => { e.preventDefault(); receiptDropZone.classList.add('dragover'); });
      receiptDropZone.addEventListener('dragleave', () => receiptDropZone.classList.remove('dragover'));
      receiptDropZone.addEventListener('drop', e => {
        e.preventDefault();
        receiptDropZone.classList.remove('dragover');
        if (e.dataTransfer.files.length) handleReceiptFile(e.dataTransfer.files[0]);
      });
    }

    if (receiptFileInput) {
      receiptFileInput.addEventListener('change', e => {
        if (e.target.files.length) handleReceiptFile(e.target.files[0]);
      });
    }

    function handleReceiptFile(file) {
      selectedReceiptFile = file;
      document.getElementById('selectedFileName').textContent = file.name;
      document.getElementById('selectedFileInfo').classList.remove('hidden');
    }

    window.clearSelectedFile = function() {
      selectedReceiptFile = null;
      document.getElementById('selectedFileInfo').classList.add('hidden');
      if (receiptFileInput) receiptFileInput.value = '';
    };

    window.uploadReceipt = async function() {
      if (!selectedReceiptFile || !currentReceiptsClientKey) {
        showAlert('يرجى اختيار ملف', 'error');
        return;
      }

      try {
        const formData = new FormData();
        formData.append('file', selectedReceiptFile);
        formData.append('description', document.getElementById('receiptDescription').value || '');

        await api('POST', `/api/ai/clients/${currentReceiptsClientKey}/receipts`, formData);
        showAlert('تم رفع الإيصال بنجاح');
        clearSelectedFile();
        document.getElementById('receiptDescription').value = '';
        await loadClientReceipts();
      } catch (err) {
        showAlert('فشل رفع الإيصال: ' + err.message, 'error');
      }
    };

    async function loadClientReceipts() {
      if (!currentReceiptsClientKey) return;
      
      try {
        const receipts = await api('GET', `/api/ai/clients/${currentReceiptsClientKey}/receipts`);
        const container = document.getElementById('receiptsList');
        
        if (!receipts.length) {
          container.innerHTML = '<div class="empty-state"><p>لا توجد إيصالات</p></div>';
          return;
        }

        container.innerHTML = receipts.map(r => {
          const date = new Date(r.uploadedAt).toLocaleDateString('ar');
          return `
            <div class="receipt-item" style="background: var(--bg); padding: 12px; border-radius: 8px; margin-bottom: 8px; display: flex; align-items: center; justify-content: space-between;">
              <div>
                <div style="font-weight: 500; font-size: 12px;">${r.originalName}</div>
                <div style="font-size: 10px; color: var(--text-muted);">${date} ${r.description ? '• ' + r.description : ''}</div>
              </div>
              <div style="display: flex; gap: 4px;">
                <a href="/api/receipts/file/${r.filename}" target="_blank" class="btn btn-sm btn-secondary">عرض</a>
                <button class="btn btn-sm btn-danger" onclick="deleteReceipt('${r.id}')">حذف</button>
              </div>
            </div>
          `;
        }).join('');
      } catch (err) {
        document.getElementById('receiptsList').innerHTML = '<div class="empty-state"><p>لا توجد إيصالات</p></div>';
      }
    }

    window.deleteReceipt = async function(id) {
      if (!confirm('حذف هذا الإيصال؟')) return;
      try {
        await api('DELETE', `/api/receipts/${id}`);
        showAlert('تم حذف الإيصال');
        await loadClientReceipts();
      } catch (err) {
        showAlert(err.message, 'error');
      }
    };

    // =====================================================
    // BROADCAST
    // =====================================================
    window.promptBroadcast = function() {
      document.getElementById('broadcastModal').classList.add('active');
      loadBroadcastAgencies();
    };

    function closeBroadcastModal() {
      document.getElementById('broadcastModal').classList.remove('active');
    }

    function loadBroadcastAgencies() {
      const select = document.getElementById('broadcastAgency');
      select.innerHTML = '';
      (globalLookups.agencies || []).forEach(a => {
        select.innerHTML += `<option value="${a}">${a}</option>`;
      });
    }

    document.getElementById('broadcastTarget')?.addEventListener('change', function() {
      document.getElementById('broadcastAgencyGroup').classList.toggle('hidden', this.value !== 'agency');
    });

    window.sendBroadcast = async function() {
      const message = document.getElementById('broadcastMessage').value.trim();
      if (!message) {
        showAlert('يرجى كتابة الرسالة', 'error');
        return;
      }

      const target = document.getElementById('broadcastTarget').value;
      const agency = target === 'agency' ? document.getElementById('broadcastAgency').value : null;

      try {
        await api('POST', '/api/ai/broadcast', { message, target, agency });
        showAlert('تم إرسال الرسالة الجماعية');
        closeBroadcastModal();
        document.getElementById('broadcastMessage').value = '';
      } catch (err) {
        showAlert('فشل الإرسال: ' + err.message, 'error');
      }
    };

    // =====================================================
    // LOOKUPS MANAGEMENT
    // =====================================================
    window.openLookupsModal = function() {
      document.getElementById('lookupsModal').classList.add('active');
      renderLookupLists();
    };

    function closeLookupsModal() {
      document.getElementById('lookupsModal').classList.remove('active');
    }

    window.switchLookupTab = function(tab) {
      document.querySelectorAll('#lookupsModal .inner-tab').forEach(t => t.classList.remove('active'));
      event.target.classList.add('active');
      document.getElementById('agenciesLookup').classList.toggle('hidden', tab !== 'agencies');
      document.getElementById('countriesLookup').classList.toggle('hidden', tab !== 'countries');
    };

    function renderLookupLists() {
      // Agencies
      const agenciesList = document.getElementById('agenciesList');
      agenciesList.innerHTML = (globalLookups.agencies || []).map(a => `
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: var(--bg); border-radius: 6px; margin-bottom: 6px;">
          <span style="font-size: 12px;">${a}</span>
          <button class="btn btn-sm btn-danger" onclick="deleteAgency('${a}')">حذف</button>
        </div>
      `).join('') || '<p style="color: var(--text-muted); text-align: center;">لا توجد وكالات</p>';

      // Countries
      const countriesList = document.getElementById('countriesList');
      const countries = globalLookups.countries || [];
      countriesList.innerHTML = countries.map(c => {
        const name = typeof c === 'object' ? c.name : c;
        return `
          <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: var(--bg); border-radius: 6px; margin-bottom: 6px;">
            <span style="font-size: 12px;">${name}</span>
            <button class="btn btn-sm btn-danger" onclick="deleteCountry('${name}')">حذف</button>
          </div>
        `;
      }).join('') || '<p style="color: var(--text-muted); text-align: center;">لا توجد دول</p>';
    }

    window.addAgency = async function() {
      const name = document.getElementById('newAgencyName').value.trim();
      if (!name) return;

      try {
        globalLookups.agencies = globalLookups.agencies || [];
        if (!globalLookups.agencies.includes(name)) {
          globalLookups.agencies.push(name);
          await api('POST', '/api/ai/lookups', globalLookups);
          showAlert('تم إضافة الوكالة');
          document.getElementById('newAgencyName').value = '';
          renderLookupLists();
          renderLookupSelects();
        }
      } catch (err) {
        showAlert(err.message, 'error');
      }
    };

    window.deleteAgency = async function(name) {
      if (!confirm(`حذف الوكالة "${name}"؟`)) return;
      try {
        globalLookups.agencies = (globalLookups.agencies || []).filter(a => a !== name);
        await api('POST', '/api/ai/lookups', globalLookups);
        showAlert('تم حذف الوكالة');
        renderLookupLists();
        renderLookupSelects();
      } catch (err) {
        showAlert(err.message, 'error');
      }
    };

    window.addCountry = async function() {
      const name = document.getElementById('newCountryName').value.trim();
      if (!name) return;

      try {
        globalLookups.countries = globalLookups.countries || [];
        const exists = globalLookups.countries.some(c => (typeof c === 'object' ? c.name : c) === name);
        if (!exists) {
          globalLookups.countries.push({ name, cities: [] });
          await api('POST', '/api/ai/lookups', globalLookups);
          showAlert('تم إضافة الدولة');
          document.getElementById('newCountryName').value = '';
          renderLookupLists();
          renderLookupSelects();
        }
      } catch (err) {
        showAlert(err.message, 'error');
      }
    };

    window.deleteCountry = async function(name) {
      if (!confirm(`حذف الدولة "${name}"؟`)) return;
      try {
        globalLookups.countries = (globalLookups.countries || []).filter(c => (typeof c === 'object' ? c.name : c) !== name);
        await api('POST', '/api/ai/lookups', globalLookups);
        showAlert('تم حذف الدولة');
        renderLookupLists();
        renderLookupSelects();
      } catch (err) {
        showAlert(err.message, 'error');
      }
    };

    // =====================================================
    // INITIALIZATION
    // =====================================================
    document.addEventListener('DOMContentLoaded', () => {
      loadSettings();
      loadPeriods();
      loadRegisteredClients();
      loadLinkedClients();
      loadChats();
      loadNotifications();
      loadNotificationTargets();
      loadTickets();
      loadKnowledge();
      loadUsage();
      loadCustomFields();
      loadLookups();

      // Auto-refresh chats
      setInterval(loadChats, 10000);
    });
  </script>
</body>
</html>

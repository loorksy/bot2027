<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Agent Dashboard - Ø£Ø¨Ùˆ Ø³Ù„Ø·Ø§Ù†</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    .ai-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    .ai-card {
      background: #1a1a2e;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 20px;
      border: 1px solid #2d2d44;
    }

    .ai-card h2 {
      margin: 0 0 20px 0;
      color: #00d4ff;
      font-size: 1.3rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .ai-card h2::before {
      content: '';
      width: 4px;
      height: 24px;
      background: linear-gradient(180deg, #00d4ff, #7c3aed);
      border-radius: 2px;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      margin-bottom: 6px;
      color: #a0a0b0;
      font-size: 0.9rem;
    }

    .form-group input,
    .form-group select {
      width: 100%;
      padding: 12px;
      border: 1px solid #3d3d5c;
      border-radius: 8px;
      background: #0f0f1a;
      color: #fff;
      font-size: 1rem;
    }

    .form-group input:focus,
    .form-group select:focus {
      border-color: #00d4ff;
      outline: none;
    }

    .form-group input[type="password"] {
      font-family: monospace;
      letter-spacing: 2px;
    }

    .toggle-container {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .toggle {
      position: relative;
      width: 56px;
      height: 30px;
    }

    .toggle input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      cursor: pointer;
      inset: 0;
      background: #3d3d5c;
      border-radius: 15px;
      transition: 0.3s;
    }

    .toggle-slider:before {
      content: '';
      position: absolute;
      height: 22px;
      width: 22px;
      right: 4px;
      bottom: 4px;
      background: #fff;
      border-radius: 50%;
      transition: 0.3s;
    }

    .toggle input:checked+.toggle-slider {
      background: linear-gradient(90deg, #00d4ff, #7c3aed);
    }

    .toggle input:checked+.toggle-slider:before {
      transform: translateX(-26px);
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      transition: all 0.2s;
    }

    .btn-primary {
      background: linear-gradient(90deg, #00d4ff, #7c3aed);
      color: #fff;
    }

    .btn-primary:hover {
      opacity: 0.9;
      transform: translateY(-1px);
    }

    .btn-secondary {
      background: #3d3d5c;
      color: #fff;
    }

    .btn-danger {
      background: #dc2626;
      color: #fff;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 16px;
    }

    .stat-card {
      background: #0f0f1a;
      padding: 16px;
      border-radius: 8px;
      text-align: center;
    }

    .stat-value {
      font-size: 1.8rem;
      font-weight: 700;
      color: #00d4ff;
    }

    .stat-label {
      font-size: 0.85rem;
      color: #a0a0b0;
      margin-top: 4px;
    }

    .file-upload {
      border: 2px dashed #3d3d5c;
      border-radius: 12px;
      padding: 32px;
      text-align: center;
      cursor: pointer;
      transition: 0.3s;
    }

    .file-upload:hover {
      border-color: #00d4ff;
      background: rgba(0, 212, 255, 0.05);
    }

    .file-upload.dragover {
      border-color: #00d4ff;
      background: rgba(0, 212, 255, 0.1);
    }

    .file-upload input[type="file"] {
      display: none;
    }

    .file-upload-icon {
      font-size: 48px;
      color: #3d3d5c;
      margin-bottom: 10px;
    }

    .periods-list {
      margin-top: 20px;
    }

    .period-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px;
      background: #0f0f1a;
      border-radius: 8px;
      margin-bottom: 10px;
    }

    .period-info h4 {
      margin: 0 0 4px 0;
      color: #fff;
    }

    .period-info span {
      font-size: 0.85rem;
      color: #a0a0b0;
    }

    .period-badge {
      background: #22c55e;
      color: #fff;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 0.8rem;
    }

    .usage-log {
      max-height: 300px;
      overflow-y: auto;
    }

    .log-entry {
      display: flex;
      gap: 16px;
      padding: 12px;
      background: #0f0f1a;
      border-radius: 6px;
      margin-bottom: 8px;
      font-size: 0.9rem;
    }

    .log-type {
      font-weight: 600;
      width: 60px;
    }

    .log-type.CHAT {
      color: #00d4ff;
    }

    .log-type.STT {
      color: #22c55e;
    }

    .log-type.TTS {
      color: #f59e0b;
    }

    .log-details {
      flex: 1;
      color: #a0a0b0;
    }

    .log-cost {
      color: #7c3aed;
      font-weight: 600;
    }

    .tab-container {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
      flex-wrap: wrap;
    }

    .tab {
      padding: 12px 24px;
      background: #1a1a2e;
      border: 1px solid #2d2d44;
      border-radius: 8px;
      cursor: pointer;
      color: #a0a0b0;
      transition: 0.2s;
    }

    .tab:hover {
      border-color: #00d4ff;
    }

    .tab.active {
      background: linear-gradient(90deg, #00d4ff, #7c3aed);
      color: #fff;
      border-color: transparent;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .row {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
    }

    .row .form-group {
      flex: 1;
      min-width: 200px;
    }

    .alert {
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 16px;
    }

    .alert-success {
      background: rgba(34, 197, 94, 0.2);
      border: 1px solid #22c55e;
      color: #22c55e;
    }

    .alert-error {
      background: rgba(220, 38, 38, 0.2);
      border: 1px solid #dc2626;
      color: #dc2626;
    }

    .back-link {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      color: #a0a0b0;
      text-decoration: none;
      margin-bottom: 20px;
    }

    .back-link:hover {
      color: #00d4ff;
    }

    .clients-table {
      width: 100%;
      border-collapse: collapse;
    }

    .clients-table th,
    .clients-table td {
      padding: 12px;
      text-align: right;
      border-bottom: 1px solid #2d2d44;
    }

    .clients-table th {
      color: #a0a0b0;
      font-weight: 500;
    }

    .clients-table tr:hover {
      background: rgba(0, 212, 255, 0.05);
    }

    .status-badge {
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 0.8rem;
    }

    .status-complete {
      background: #22c55e;
      color: #fff;
    }

    .status-incomplete {
      background: #f59e0b;
      color: #fff;
    }
  </style>
</head>

<body>
  <div class="ai-container">
    <a href="/" class="back-link">â† Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>

    <h1 style="color: #00d4ff; margin-bottom: 24px;">ğŸ¤– AI Agent - Ù…Ø³Ø§Ø¹Ø¯ Ø£Ø¨Ùˆ Ø³Ù„Ø·Ø§Ù†</h1>

    <div id="alertContainer"></div>

    <!-- Tabs -->
    <div class="tab-container">
      <div class="tab active" data-tab="settings">âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</div>

      <div class="tab" data-tab="fields">ğŸ“ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø®ØµØµØ©</div>
      <div class="tab" data-tab="registered">ğŸ“‹ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</div>
      <div class="tab" data-tab="salary">ğŸ’° Ø§Ù„Ø±ÙˆØ§ØªØ¨</div>
      <div class="tab" data-tab="usage">ğŸ“Š Ø§Ù„Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ</div>
      <div class="tab" data-tab="linked">ğŸ”— Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù…Ø±Ø¨ÙˆØ·ÙŠÙ†</div>
    </div>

    <!-- Settings Tab -->
    <div id="settings" class="tab-content active">
      <div class="ai-card">
        <h2>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª OpenAI</h2>

        <div class="form-group">
          <div class="toggle-container">
            <label class="toggle">
              <input type="checkbox" id="aiEnabled">
              <span class="toggle-slider"></span>
            </label>
            <span style="color: #fff;">ØªÙØ¹ÙŠÙ„ AI Agent</span>
          </div>
        </div>

        <div class="form-group">
          <label>OpenAI API Key</label>
          <input type="password" id="openaiKey" placeholder="sk-...">
        </div>

        <div class="row">
          <div class="form-group">
            <label>Ù…ÙˆØ¯ÙŠÙ„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© (Chat)</label>
            <select id="modelChat">
              <option value="gpt-4o-mini">GPT-4o Mini (Ø£Ø±Ø®Øµ)</option>
              <option value="gpt-4o">GPT-4o (Ù…ØªÙˆØ§Ø²Ù†)</option>
              <option value="gpt-4-turbo">GPT-4 Turbo</option>
              <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
            </select>
          </div>
          <div class="form-group">
            <label>Ù…ÙˆØ¯ÙŠÙ„ ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØµÙˆØª Ù„Ù†Øµ (STT)</label>
            <select id="modelStt">
              <option value="whisper-1">Whisper-1</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div class="form-group">
            <label>Ù…ÙˆØ¯ÙŠÙ„ ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù†Øµ Ù„ØµÙˆØª (TTS)</label>
            <select id="modelTts">
              <option value="tts-1">TTS-1 (Ø³Ø±ÙŠØ¹)</option>
              <option value="tts-1-hd">TTS-1 HD (Ø¬ÙˆØ¯Ø© Ø¹Ø§Ù„ÙŠØ©)</option>
            </select>
          </div>
          <div class="form-group">
            <label>ØµÙˆØª TTS</label>
            <select id="voiceTts">
              <option value="alloy">Alloy</option>
              <option value="echo">Echo</option>
              <option value="fable">Fable</option>
              <option value="onyx">Onyx</option>
              <option value="nova">Nova</option>
              <option value="shimmer">Shimmer</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div class="form-group">
            <label>Ù…Ø¯Ø© Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ù…ÙˆØ«ÙˆÙ‚Ø© (Ø¯Ù‚Ø§Ø¦Ù‚)</label>
            <input type="number" id="trustedSessionMinutes" min="1" max="1440" value="15">
          </div>
          <div class="form-group">
            <label>Ù†Ø³Ø¨Ø© Ø§Ù„ÙˆÙƒØ§Ù„Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© (%)</label>
            <input type="number" id="agencyPercent" min="0" max="100" step="0.1" value="0">
          </div>
        </div>
      </div>

      <!-- New Personality Settings Card -->
      <div class="ai-card">
        <h2>ğŸ­ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø´Ø®ØµÙŠØ© Ø§Ù„Ø¨ÙˆØª</h2>

        <div class="row">
          <div class="form-group">
            <label>Ø§Ø³Ù… Ø§Ù„Ø¨ÙˆØª</label>
            <input type="text" id="botName" placeholder="Ù…Ø³Ø§Ø¹Ø¯ Ø£Ø¨Ùˆ Ø³Ù„Ø·Ø§Ù†">
          </div>
          <div class="form-group">
            <label>Ø§Ø³Ù… ØµØ§Ø­Ø¨ Ø§Ù„Ø¹Ù…Ù„</label>
            <input type="text" id="ownerName" placeholder="Ø£Ø¨Ùˆ Ø³Ù„Ø·Ø§Ù†">
          </div>
        </div>

        <div class="row">
          <div class="form-group">
            <label>Ø§Ù„Ù„Ù‡Ø¬Ø©</label>
            <select id="dialect">
              <option value="Ø³ÙˆØ±ÙŠØ©">ğŸ‡¸ğŸ‡¾ Ø³ÙˆØ±ÙŠØ©</option>
              <option value="Ø®Ù„ÙŠØ¬ÙŠØ©">ğŸ‡¸ğŸ‡¦ Ø®Ù„ÙŠØ¬ÙŠØ©</option>
              <option value="Ù…ØµØ±ÙŠØ©">ğŸ‡ªğŸ‡¬ Ù…ØµØ±ÙŠØ©</option>
              <option value="ÙØµØ­Ù‰">ğŸ“– ÙØµØ­Ù‰</option>
            </select>
          </div>
          <div class="form-group">
            <label>ØµÙŠØºØ© Ø§Ù„Ù…Ø®Ø§Ø·Ø¨Ø©</label>
            <select id="clientGender">
              <option value="Ù…Ø¤Ù†Ø«">ğŸ‘© Ù…Ø¤Ù†Ø« (Ø­Ø¨ÙŠØ¨ØªÙŠØŒ Ø§Ø¨Ø¹ØªÙŠÙ„ÙŠ)</option>
              <option value="Ù…Ø°ÙƒØ±">ğŸ‘¨ Ù…Ø°ÙƒØ± (Ø­Ø¨ÙŠØ¨ÙŠØŒ Ø§Ø¨Ø¹ØªÙ„ÙŠ)</option>
              <option value="Ù…Ø­Ø§ÙŠØ¯">âšª Ù…Ø­Ø§ÙŠØ¯</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div class="form-group">
            <label>Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ÙˆØ¯ÙŠØ©</label>
            <select id="friendliness">
              <option value="Ø¹Ø§Ù„ÙŠ">ğŸ˜Š Ø¹Ø§Ù„ÙŠ (Ø¥ÙŠÙ…ÙˆØ¬ÙŠ + ÙƒÙ„Ø§Ù… ÙˆØ¯ÙˆØ¯)</option>
              <option value="Ù…ØªÙˆØ³Ø·">ğŸ™‚ Ù…ØªÙˆØ³Ø· (Ù„Ø·ÙŠÙ)</option>
              <option value="Ø±Ø³Ù…ÙŠ">ğŸ“‹ Ø±Ø³Ù…ÙŠ (Ø¨Ø¯ÙˆÙ† Ø¥ÙŠÙ…ÙˆØ¬ÙŠ)</option>
            </select>
          </div>
          <div class="form-group">
            <label>Ø¹Ù…Ù„Ø© Ø§Ù„Ø±Ø§ØªØ¨</label>
            <input type="text" id="salaryCurrency" placeholder="Ø±.Ø³">
          </div>
        </div>

        <div class="row">
          <div class="form-group">
            <label>Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</label>
            <input type="text" id="adminContact" placeholder="ØªÙˆØ§ØµÙ„ÙŠ Ù…Ø¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©">
          </div>
          <div class="form-group">
            <div class="toggle-container" style="margin-top: 28px;">
              <label class="toggle">
                <input type="checkbox" id="enableVoiceReplies">
                <span class="toggle-slider"></span>
              </label>
              <span style="color: #fff;">Ø§Ù„Ø±Ø¯ ØµÙˆØªÙŠØ§Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØµÙˆØªÙŠØ©</span>
            </div>
          </div>
        </div>
      </div>

        <button class="btn btn-primary" id="saveSettingsBtn">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
      </div>
    </div>



    <!-- Custom Fields Tab -->
    <div id="fields" class="tab-content">
      <div class="ai-card">
        <h2>Ø¥Ø¶Ø§ÙØ© Ø­Ù‚Ù„ Ø¬Ø¯ÙŠØ¯</h2>

        <div class="row">
          <div class="form-group">
            <label>Ø§Ø³Ù… Ø§Ù„Ø­Ù‚Ù„ *</label>
            <input type="text" id="fieldName" placeholder="Ù…Ø«Ø§Ù„: Ø±Ù‚Ù… Ø§Ù„Ø¥Ù‚Ø§Ù…Ø©">
          </div>
          <div class="form-group">
            <label>Ù†ÙˆØ¹ Ø§Ù„Ø­Ù‚Ù„</label>
            <select id="fieldType">
              <option value="text">Ù†Øµ</option>
              <option value="dropdown">Ù‚Ø§Ø¦Ù…Ø© Ù…Ù†Ø³Ø¯Ù„Ø©</option>
              <option value="number">Ø±Ù‚Ù…</option>
              <option value="date">ØªØ§Ø±ÙŠØ®</option>
            </select>
          </div>
          <div class="form-group">
            <label>Ù…Ø·Ù„ÙˆØ¨</label>
            <select id="fieldRequired">
              <option value="false">Ù„Ø§</option>
              <option value="true">Ù†Ø¹Ù…</option>
            </select>
          </div>
        </div>

        <div id="dropdownOptionsSection" style="display: none;">
          <div class="form-group">
            <label>Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø©</label>
            <p style="color: #a0a0b0; font-size: 0.8rem; margin-bottom: 12px;">Ù„ÙƒÙ„ Ø®ÙŠØ§Ø±ØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ø­Ù‚Ù„ ÙØ±Ø¹ÙŠ (Ù…Ø«Ù„:
              Ù…Ø­ÙØ¸Ø© Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ© â† Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø­ÙØ¸Ø©)</p>
            <div id="dropdownOptionsInputs">
              <div class="option-row"
                style="display: flex; gap: 8px; margin-bottom: 12px; align-items: flex-start; flex-wrap: wrap;">
                <input type="text" class="dropdown-option-value" placeholder="Ø§Ø³Ù… Ø§Ù„Ø®ÙŠØ§Ø±"
                  style="flex: 2; min-width: 150px;">
                <select class="dropdown-option-subtype" style="flex: 1; min-width: 100px;">
                  <option value="">Ø¨Ø¯ÙˆÙ† Ø­Ù‚Ù„ ÙØ±Ø¹ÙŠ</option>
                  <option value="text">Ù†Øµ</option>
                  <option value="number">Ø±Ù‚Ù…</option>
                  <option value="date">ØªØ§Ø±ÙŠØ®</option>
                </select>
                <input type="text" class="dropdown-option-sublabel" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„ÙØ±Ø¹ÙŠ"
                  style="flex: 2; min-width: 150px; display: none;">
              </div>
            </div>
            <button type="button" class="btn btn-secondary" style="padding: 6px 12px; font-size: 0.8rem;"
              onclick="addDropdownOptionInputWithSubField()">+ Ø¥Ø¶Ø§ÙØ© Ø®ÙŠØ§Ø±</button>
          </div>
        </div>

        <button class="btn btn-primary" id="addFieldBtn">â• Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ù‚Ù„</button>
        <button class="btn btn-danger" id="cancelEditBtn" style="display: none; margin-right: 8px;"
          onclick="cancelEdit()">Ø¥Ù„ØºØ§Ø¡</button>
      </div>

      <div class="ai-card">
        <h2>Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø®ØµØµØ©</h2>
        <button class="btn btn-secondary" id="refreshFieldsBtn" style="margin-bottom: 16px;">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
        <div id="fieldsList">
          <p style="color: #666; text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ù‚ÙˆÙ„ Ù…Ø®ØµØµØ©</p>
        </div>
      </div>
    </div>

    <!-- Registered Clients Tab -->
    <div id="registered" class="tab-content">
      <div class="ai-card">
        <h2>Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</h2>

        <div class="row">
          <div class="form-group">
            <label>Ø±Ù‚Ù… Ø§Ù„Ù€ ID *</label>
            <div id="regIdsContainer">
              <div class="input-group" style="margin-bottom: 5px; display: flex; gap: 5px;">
                <input type="text" name="regClientId" placeholder="Ù…Ø«Ø§Ù„: 7099026" style="flex: 1;">
              </div>
            </div>
            <button class="btn btn-secondary" style="padding: 2px 8px; font-size: 0.8rem; margin-top: 5px;"
              onclick="addIdField()">â• Ø¥Ø¶Ø§ÙØ© ID Ø¢Ø®Ø±</button>
          </div>
          <div class="form-group">
            <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ *</label>
            <input type="text" id="regFullName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ">
          </div>
        </div>

        <div class="row">
          <div class="form-group">
            <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
            <input type="text" id="regPhone" placeholder="Ù…Ø«Ø§Ù„: 00963935990348">
          </div>
          <div class="form-group">
            <label>Ø§Ù„ÙˆÙƒØ§Ù„Ø© <a href="#" onclick="promptManageLookups('agency'); return false;"
                style="font-size: 0.8rem;">(Ø¥Ø¯Ø§Ø±Ø©)</a></label>
            <select id="regAgency">
              <option value="">Ø§Ø®ØªØ± Ø§Ù„ÙˆÙƒØ§Ù„Ø©...</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div class="form-group">
            <label>Ø§Ù„Ø¯ÙˆÙ„Ø© <a href="#" onclick="promptManageLookups('country'); return false;"
                style="font-size: 0.8rem;">(Ø¥Ø¯Ø§Ø±Ø©)</a></label>
            <select id="regCountry" onchange="renderCityOptions()">
              <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¯ÙˆÙ„Ø©...</option>
            </select>
          </div>
          <div class="form-group">
            <label>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© <a href="#" onclick="promptManageLookups('city'); return false;"
                style="font-size: 0.8rem;">(Ø¥Ø¯Ø§Ø±Ø©)</a></label>
            <select id="regCity">
              <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¯ÙˆÙ„Ø© Ø£ÙˆÙ„Ø§Ù‹...</option>
            </select>
          </div>
          <div class="form-group">
            <label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØªÙØµÙŠÙ„ÙŠ</label>
            <input type="text" id="regAddress" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†">
          </div>
        </div>

        <!-- Custom Fields Container -->
        <div id="customFieldsContainer" class="row"></div>

        <button class="btn btn-primary" id="addRegClientBtn">â• Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù…ÙŠÙ„</button>
        <button class="btn btn-secondary" id="clearRegFormBtn">Ù…Ø³Ø­</button>
      </div>

      <div class="ai-card">
        <h2>Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù…Ø³Ø¬Ù„ÙˆÙ†</h2>
        <div class="row" style="margin-bottom: 16px; align-items: center; gap: 10px;">

          <div class="row" style="margin-bottom: 16px; align-items: center; gap: 10px; flex-wrap: wrap;">
            <button class="btn btn-secondary" id="refreshRegClientsBtn">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
            <button class="btn btn-primary" onclick="promptBroadcast()" style="background: #8b5cf6;">ğŸ“¢ Ø¥Ø±Ø³Ø§Ù„
              Ø¬Ù…Ø§Ø¹ÙŠ</button>
            <button class="btn btn-primary" onclick="sendSalaryToAll()" style="background: #10b981;">ğŸ’° Ø¥Ø±Ø³Ø§Ù„
              Ø§Ù„Ø±ÙˆØ§ØªØ¨</button>

            <span style="border-left: 1px solid #444; height: 24px; margin: 0 4px;"></span>

            <button class="btn btn-secondary" onclick="exportClients()" style="padding: 8px 16px;">ğŸ“¤ ØªØµØ¯ÙŠØ±
              (Excel)</button>
            <button class="btn btn-secondary" onclick="downloadTemplate()" style="padding: 8px 16px;">ğŸ“„ ØªØ­Ù…ÙŠÙ„
              Ø§Ù„Ù‚Ø§Ù„Ø¨</button>
            <button class="btn btn-secondary" onclick="document.getElementById('importClientsFile').click()"
              style="padding: 8px 16px;">ğŸ“¥ Ø§Ø³ØªÙŠØ±Ø§Ø¯</button>
            <input type="file" id="importClientsFile" accept=".csv" style="display: none;"
              onchange="importClients(this)">

            <span id="regClientCount" style="color: #a0a0b0; margin-right: 16px;"></span>
          </div>
        </div>
        <div style="margin-bottom: 16px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
          <input type="text" id="searchRegClientInput" placeholder="ğŸ” Ø¨Ø­Ø« Ø¹Ù† Ø¹Ù…ÙŠÙ„ (Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ù‡Ø§ØªÙØŒ ID)..."
            style="flex: 1; min-width: 200px; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 4px; color: white;">
          <button class="btn btn-primary" style="background: #8b5cf6; padding: 10px 15px; white-space: nowrap;" onclick="sendPortalLinksToAll()">
            ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„ Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ø¨ÙˆØ§Ø¨Ø© Ù„ÙƒÙ„ Ø¹Ù…Ù„Ø§Ø¡ Main
          </button>
          <button class="btn btn-danger" style="padding: 10px 15px; white-space: nowrap; display: none;" id="deleteSelectedBtn" onclick="deleteSelectedClients()">
            ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø¯Ø¯ (<span id="selectedCount">0</span>)
          </button>
        </div>
        <div style="overflow-x: auto;">
          <table class="clients-table">
            <thead>
              <tr>
                <th style="width: 40px;"><input type="checkbox" id="selectAllClients" onchange="toggleSelectAll(this)"></th>
                <th>ID</th>
                <th>Ø§Ù„Ø§Ø³Ù…</th>
                <th>Ø§Ù„Ù‡Ø§ØªÙ</th>
                <th>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</th>
                <th>Ø§Ù„ÙˆÙƒØ§Ù„Ø©</th>
                <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø¶Ø§ÙØ©</th>
                <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
              </tr>
            </thead>
            <tbody id="regClientsBody">
              <tr>
                <td colspan="8" style="text-align: center; color: #666;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù…Ù„Ø§Ø¡ Ù…Ø³Ø¬Ù„ÙˆÙ†</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Salary Tab (Old) -->

  <!-- Salary Tab -->
  <div id="salary" class="tab-content">
    <div class="ai-card">
      <h2>Ø±ÙØ¹ Ù…Ù„Ù Ø§Ù„Ø±ÙˆØ§ØªØ¨</h2>

      <div class="file-upload" id="fileUploadArea">
        <input type="file" id="salaryFile" accept=".csv,.xlsx,.xls">
        <div class="file-upload-icon">ğŸ“„</div>
        <p style="color: #a0a0b0; margin: 0;">Ø§Ø³Ø­Ø¨ Ù…Ù„Ù CSV Ù‡Ù†Ø§ Ø£Ùˆ Ø§Ù†Ù‚Ø± Ù„Ù„Ø§Ø®ØªÙŠØ§Ø±</p>
        <p style="color: #666; font-size: 0.85rem; margin-top: 8px;">Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰: 10MB</p>
      </div>

      <div id="filePreview" style="display: none; margin-top: 20px;">
        <h3 style="color: #fff; margin-bottom: 16px;">Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù…Ù„Ù</h3>

        <div class="row">
          <div class="form-group">
            <label>Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù… (Period)</label>
            <input type="text" id="periodName" placeholder="Ù…Ø«Ø§Ù„: 1-15 ÙŠÙ†Ø§ÙŠØ± 2024">
          </div>
          <div class="form-group">
            <label>Ø¹Ù…ÙˆØ¯ ID</label>
            <select id="idColumn"></select>
          </div>
        </div>

        <div class="row">
          <div class="form-group">
            <label>Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø±Ø§ØªØ¨</label>
            <select id="salaryColumn"></select>
          </div>
          <div class="form-group">
            <label>Ù†Ø³Ø¨Ø© Ø§Ù„ÙˆÙƒØ§Ù„Ø© (%)</label>
            <input type="number" id="uploadAgencyPercent" min="0" max="100" step="0.1" value="0">
          </div>
        </div>

        <div id="previewTable" style="overflow-x: auto; margin: 16px 0;"></div>

        <p style="color: #a0a0b0; font-size: 0.9rem;" id="rowCount"></p>

        <button class="btn btn-primary" id="uploadBtn">ğŸ“¤ Ø±ÙØ¹ ÙˆØªØ£ÙƒÙŠØ¯</button>
        <button class="btn btn-secondary" id="cancelUploadBtn">Ø¥Ù„ØºØ§Ø¡</button>
      </div>
    </div>

    <div class="ai-card">
      <h2>Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…Ø±ÙÙˆØ¹Ø©</h2>
      <div class="periods-list" id="periodsList">
        <p style="color: #666; text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù‚Ø³Ø§Ù… Ù…Ø±ÙÙˆØ¹Ø©</p>
      </div>
    </div>
  </div>

  <!-- Usage Tab -->
  <div id="usage" class="tab-content">
    <div class="ai-card">
      <h2>Ù…Ù„Ø®Øµ Ø§Ù„Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ</h2>
      <div class="stats-grid" id="usageStats">
        <div class="stat-card">
          <div class="stat-value" id="totalChats">0</div>
          <div class="stat-label">Ø±Ø³Ø§Ø¦Ù„ Chat</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="totalStt">0</div>
          <div class="stat-label">ØªØ­ÙˆÙŠÙ„ ØµÙˆØªâ†’Ù†Øµ</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="totalTts">0</div>
          <div class="stat-label">ØªØ­ÙˆÙŠÙ„ Ù†Øµâ†’ØµÙˆØª</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="totalTokens">0</div>
          <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Tokens</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="estimatedCost">$0</div>
          <div class="stat-label">Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ÙŠØ©</div>
        </div>
      </div>

      <div style="margin-top: 16px;">
        <button class="btn btn-secondary" id="refreshUsageBtn">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
        <button class="btn btn-danger" id="resetUsageBtn">ğŸ—‘ï¸ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
      </div>
    </div>

    <div class="ai-card">
      <h2>Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª (Ø¢Ø®Ø± 100)</h2>
      <div class="usage-log" id="usageLog">
        <p style="color: #666; text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª Ù…Ø³Ø¬Ù„Ø©</p>
      </div>
    </div>
  </div>

  <!-- Linked Clients Tab -->
  <div id="linked" class="tab-content">
    <div class="ai-card">
      <h2>Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù…Ø±Ø¨ÙˆØ·ÙŠÙ† Ø¨ÙˆØ§ØªØ³Ø§Ø¨</h2>
      <button class="btn btn-secondary" id="refreshLinkedClientsBtn" style="margin-bottom: 16px;">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
      <div style="overflow-x: auto;">
        <table class="clients-table" id="linkedClientsTable">
          <thead>
            <tr>
              <th>WhatsApp ID</th>
              <th>Ø§Ù„Ø§Ø³Ù…</th>
              <th>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</th>
              <th>Ø§Ù„ÙˆÙƒØ§Ù„Ø©</th>
              <th>ID Ù…Ø±Ø¨ÙˆØ·</th>
              <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
              <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
          </thead>
          <tbody id="linkedClientsBody">
            <tr>
              <td colspan="7" style="text-align: center; color: #666;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù…Ù„Ø§Ø¡ Ù…Ø±Ø¨ÙˆØ·ÙŠÙ†</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
  </div>

  <script>
    // Tab switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(tab.dataset.tab).classList.add('active');
      });
    });

    // Alert helper
    function showAlert(message, type = 'success') {
      const container = document.getElementById('alertContainer');
      container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
      setTimeout(() => container.innerHTML = '', 5000);
    }

    // Cookie helper
    function getCookie(name) {
      const match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
      if (match) return match[2];
      return null;
    }

    // API helper
    async function api(method, url, data = null) {
      const options = { method, credentials: 'include' };
      if (data && !(data instanceof FormData)) {
        options.headers = { 'Content-Type': 'application/json' };
        options.body = JSON.stringify(data);
      } else if (data) {
        options.body = data;
      }
      const res = await fetch(url, options);
      const json = await res.json();
      if (!res.ok) throw new Error(json.error || 'Unknown error');
      return json;
    }

    // Load settings
    async function loadSettings() {
      try {
        const settings = await api('GET', '/api/ai/settings');
        document.getElementById('aiEnabled').checked = settings.enabled;
        document.getElementById('openaiKey').value = settings.openaiKey || '';
        document.getElementById('modelChat').value = settings.modelChat || 'gpt-4o-mini';
        document.getElementById('modelStt').value = settings.modelStt || 'whisper-1';
        document.getElementById('modelTts').value = settings.modelTts || 'tts-1';
        document.getElementById('voiceTts').value = settings.voiceTts || 'alloy';
        document.getElementById('trustedSessionMinutes').value = settings.trustedSessionMinutes || 15;
        document.getElementById('agencyPercent').value = settings.agencyPercent || 0;
        
        // New personality settings
        document.getElementById('botName').value = settings.botName || 'Ù…Ø³Ø§Ø¹Ø¯ Ø£Ø¨Ùˆ Ø³Ù„Ø·Ø§Ù†';
        document.getElementById('ownerName').value = settings.ownerName || 'Ø£Ø¨Ùˆ Ø³Ù„Ø·Ø§Ù†';
        document.getElementById('dialect').value = settings.dialect || 'Ø³ÙˆØ±ÙŠØ©';
        document.getElementById('clientGender').value = settings.clientGender || 'Ù…Ø¤Ù†Ø«';
        document.getElementById('friendliness').value = settings.friendliness || 'Ø¹Ø§Ù„ÙŠ';
        document.getElementById('salaryCurrency').value = settings.salaryCurrency || 'Ø±.Ø³';
        document.getElementById('adminContact').value = settings.adminContact || 'ØªÙˆØ§ØµÙ„ÙŠ Ù…Ø¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©';
        document.getElementById('enableVoiceReplies').checked = settings.enableVoiceReplies || false;
      } catch (err) {
        showAlert('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª: ' + err.message, 'error');
      }
    }

    // Save settings
    document.getElementById('saveSettingsBtn').addEventListener('click', async () => {
      try {
        const data = {
          enabled: document.getElementById('aiEnabled').checked,
          modelChat: document.getElementById('modelChat').value,
          modelStt: document.getElementById('modelStt').value,
          modelTts: document.getElementById('modelTts').value,
          voiceTts: document.getElementById('voiceTts').value,
          trustedSessionMinutes: parseInt(document.getElementById('trustedSessionMinutes').value) || 15,
          agencyPercent: parseFloat(document.getElementById('agencyPercent').value) || 0,
          
          // New personality settings
          botName: document.getElementById('botName').value || 'Ù…Ø³Ø§Ø¹Ø¯ Ø£Ø¨Ùˆ Ø³Ù„Ø·Ø§Ù†',
          ownerName: document.getElementById('ownerName').value || 'Ø£Ø¨Ùˆ Ø³Ù„Ø·Ø§Ù†',
          dialect: document.getElementById('dialect').value || 'Ø³ÙˆØ±ÙŠØ©',
          clientGender: document.getElementById('clientGender').value || 'Ù…Ø¤Ù†Ø«',
          friendliness: document.getElementById('friendliness').value || 'Ø¹Ø§Ù„ÙŠ',
          salaryCurrency: document.getElementById('salaryCurrency').value || 'Ø±.Ø³',
          adminContact: document.getElementById('adminContact').value || 'ØªÙˆØ§ØµÙ„ÙŠ Ù…Ø¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©',
          enableVoiceReplies: document.getElementById('enableVoiceReplies').checked
        };

        const keyInput = document.getElementById('openaiKey').value;
        if (keyInput && !keyInput.includes('â€¢')) {
          data.openaiKey = keyInput;
        }

        await api('POST', '/api/ai/settings', data);
        showAlert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ù†Ø¬Ø§Ø­ âœ…');
      } catch (err) {
        showAlert('ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª: ' + err.message, 'error');
      }
    });

    // File upload
    const fileUploadArea = document.getElementById('fileUploadArea');
    const salaryFileInput = document.getElementById('salaryFile');
    let uploadedFileData = null;

    fileUploadArea.addEventListener('click', () => salaryFileInput.click());
    fileUploadArea.addEventListener('dragover', e => { e.preventDefault(); fileUploadArea.classList.add('dragover'); });
    fileUploadArea.addEventListener('dragleave', () => fileUploadArea.classList.remove('dragover'));
    fileUploadArea.addEventListener('drop', e => {
      e.preventDefault();
      fileUploadArea.classList.remove('dragover');
      if (e.dataTransfer.files.length) {
        salaryFileInput.files = e.dataTransfer.files;
        handleFileSelect(e.dataTransfer.files[0]);
      }
    });

    salaryFileInput.addEventListener('change', e => {
      if (e.target.files.length) handleFileSelect(e.target.files[0]);
    });

    async function handleFileSelect(file) {
      try {
        const formData = new FormData();
        formData.append('file', file);

        const preview = await api('POST', '/api/ai/salary/upload/preview', formData);
        uploadedFileData = { file, preview };

        // Populate column selects
        const idCol = document.getElementById('idColumn');
        const salaryCol = document.getElementById('salaryColumn');
        idCol.innerHTML = '';
        salaryCol.innerHTML = '';

        preview.columns.forEach(col => {
          idCol.innerHTML += `<option value="${col}">${col}</option>`;
          salaryCol.innerHTML += `<option value="${col}">${col}</option>`;
        });

        // Try to auto-detect columns
        const idGuess = preview.columns.find(c => c.toLowerCase().includes('id'));
        const salaryGuess = preview.columns.find(c => c.toLowerCase().includes('salary') || c.toLowerCase().includes('Ø±Ø§ØªØ¨'));
        if (idGuess) idCol.value = idGuess;
        if (salaryGuess) salaryCol.value = salaryGuess;

        // Show preview table
        let tableHtml = '<table class="clients-table"><thead><tr>';
        preview.columns.forEach(col => tableHtml += `<th>${col}</th>`);
        tableHtml += '</tr></thead><tbody>';
        preview.sampleRows.forEach(row => {
          tableHtml += '<tr>';
          preview.columns.forEach(col => tableHtml += `<td>${row[col] || ''}</td>`);
          tableHtml += '</tr>';
        });
        tableHtml += '</tbody></table>';
        document.getElementById('previewTable').innerHTML = tableHtml;
        document.getElementById('rowCount').textContent = `Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØµÙÙˆÙ: ${preview.totalRows}`;

        document.getElementById('filePreview').style.display = 'block';
        fileUploadArea.style.display = 'none';

      } catch (err) {
        showAlert('ÙØ´Ù„ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù: ' + err.message, 'error');
      }
    }

    document.getElementById('cancelUploadBtn').addEventListener('click', () => {
      document.getElementById('filePreview').style.display = 'none';
      fileUploadArea.style.display = 'block';
      uploadedFileData = null;
      salaryFileInput.value = '';
    });

    document.getElementById('uploadBtn').addEventListener('click', async () => {
      if (!uploadedFileData) return;

      const periodName = document.getElementById('periodName').value.trim();
      if (!periodName) {
        showAlert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù…', 'error');
        return;
      }

      try {
        const formData = new FormData();
        formData.append('file', uploadedFileData.file);
        formData.append('name', periodName);
        formData.append('idColumn', document.getElementById('idColumn').value);
        formData.append('salaryColumn', document.getElementById('salaryColumn').value);
        formData.append('agencyPercent', document.getElementById('uploadAgencyPercent').value || 0);

        await api('POST', '/api/ai/salary/upload', formData);
        showAlert('ØªÙ… Ø±ÙØ¹ Ø§Ù„Ù‚Ø³Ù… Ø¨Ù†Ø¬Ø§Ø­');

        document.getElementById('filePreview').style.display = 'none';
        fileUploadArea.style.display = 'block';
        uploadedFileData = null;
        salaryFileInput.value = '';
        document.getElementById('periodName').value = '';

        loadPeriods();

      } catch (err) {
        showAlert('ÙØ´Ù„ Ø§Ù„Ø±ÙØ¹: ' + err.message, 'error');
      }
    });

    // Load periods
    async function loadPeriods() {
      try {
        const periods = await api('GET', '/api/ai/salary/periods');
        const container = document.getElementById('periodsList');

        if (!periods.length) {
          container.innerHTML = '<p style="color: #666; text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù‚Ø³Ø§Ù… Ù…Ø±ÙÙˆØ¹Ø©</p>';
          return;
        }

        container.innerHTML = periods.map(p => `
          <div class="period-item">
            <div class="period-info">
              <h4>${p.name} ${p.isCurrent ? '<span class="period-badge">Ø§Ù„Ø­Ø§Ù„ÙŠ</span>' : ''}</h4>
              <span>${p.recordCount} Ø³Ø¬Ù„ â€¢ Ø±ÙØ¹: ${new Date(p.uploadedAt).toLocaleDateString('ar')} â€¢ Ù†Ø³Ø¨Ø©: ${p.agencyPercent}%</span>
            </div>
            <div>
              ${!p.isCurrent ? `<button class="btn btn-secondary btn-sm" onclick="setCurrentPeriod('${p.id}')">ØªØ¹ÙŠÙŠÙ† ÙƒØ­Ø§Ù„ÙŠ</button>` : ''}
              <button class="btn btn-danger btn-sm" onclick="deletePeriod('${p.id}')">Ø­Ø°Ù</button>
            </div>
          </div>
        `).join('');

      } catch (err) {
        showAlert('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…: ' + err.message, 'error');
      }
    }

    window.setCurrentPeriod = async (id) => {
      try {
        await api('POST', `/api/ai/salary/period/${id}/current`);
        showAlert('ØªÙ… ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù‚Ø³Ù… ÙƒØ­Ø§Ù„ÙŠ');
        loadPeriods();
      } catch (err) {
        showAlert('ÙØ´Ù„: ' + err.message, 'error');
      }
    };

    window.deletePeriod = async (id) => {
      if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù…ØŸ')) return;
      try {
        await api('DELETE', `/api/ai/salary/period/${id}`);
        showAlert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù‚Ø³Ù…');
        loadPeriods();
      } catch (err) {
        showAlert('ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù: ' + err.message, 'error');
      }
    };

    // Load usage
    async function loadUsage() {
      try {
        const summary = await api('GET', '/api/ai/usage');
        document.getElementById('totalChats').textContent = summary.totalChatCalls || 0;
        document.getElementById('totalStt').textContent = summary.totalSttCalls || 0;
        document.getElementById('totalTts').textContent = summary.totalTtsCalls || 0;
        document.getElementById('totalTokens').textContent = (summary.totalInputTokens + summary.totalOutputTokens) || 0;
        document.getElementById('estimatedCost').textContent = '$' + (summary.estimatedCost || 0).toFixed(4);

        const log = await api('GET', '/api/ai/usage/log');
        const logContainer = document.getElementById('usageLog');

        if (!log.length) {
          logContainer.innerHTML = '<p style="color: #666; text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª Ù…Ø³Ø¬Ù„Ø©</p>';
          return;
        }

        logContainer.innerHTML = log.reverse().map(entry => `
          <div class="log-entry">
            <span class="log-type ${entry.type}">${entry.type}</span>
            <span class="log-details">
              ${entry.type === 'CHAT' ? `${entry.inputTokens}+${entry.outputTokens} tokens` : ''}
              ${entry.type === 'STT' ? `${entry.durationSeconds?.toFixed(1)}s` : ''}
              ${entry.type === 'TTS' ? `${entry.characterCount} chars` : ''}
              â€¢ ${entry.model}
            </span>
            <span class="log-cost">$${entry.cost?.toFixed(4) || 0}</span>
            <span style="color: #666; font-size: 0.8rem;">${new Date(entry.time).toLocaleString('ar')}</span>
          </div>
        `).join('');

      } catch (err) {
        showAlert('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ: ' + err.message, 'error');
      }
    }

    document.getElementById('refreshUsageBtn').addEventListener('click', loadUsage);
    document.getElementById('resetUsageBtn').addEventListener('click', async () => {
      if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø§Ø³ØªÙ‡Ù„Ø§ÙƒØŸ')) return;
      try {
        await api('POST', '/api/ai/usage/reset');
        showAlert('ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ');
        loadUsage();
      } catch (err) {
        showAlert('ÙØ´Ù„: ' + err.message, 'error');
      }
    });

    // Load clients
    async function loadClients() {
      try {
        const clients = await api('GET', '/api/ai/clients');
        const tbody = document.getElementById('clientsBody');

        const clientsArray = Object.values(clients);
        if (!clientsArray.length) {
          tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #666;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù…Ù„Ø§Ø¡</td></tr>';
          return;
        }

        tbody.innerHTML = clientsArray.map(c => `
          <tr>
            <td style="font-family: monospace; font-size: 0.85rem;">${c.whatsappId}</td>
            <td>${c.profile?.fullName || '-'}</td>
            <td>${c.profile?.city || '-'}</td>
            <td>${c.profile?.agencyName || '-'}</td>
            <td>${c.profile?.ids?.join(', ') || '-'}</td>
            <td><span class="status-badge status-${c.status}">${c.status === 'complete' ? 'Ù…ÙƒØªÙ…Ù„' : 'ØºÙŠØ± Ù…ÙƒØªÙ…Ù„'}</span></td>
            <td>${c.createdAt ? new Date(c.createdAt).toLocaleDateString('ar') : '-'}</td>
          </tr>
        `).join('');

      } catch (err) {
        showAlert('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡: ' + err.message, 'error');
      }
    }

    document.getElementById('refreshLinkedClientsBtn').addEventListener('click', loadLinkedClients);

    // =====================================================
    // Registered Clients Management
    // =====================================================

    async function loadRegisteredClients() {
      try {
        const clients = await api('GET', '/api/ai/registered-clients');
        const tbody = document.getElementById('regClientsBody');
        const countEl = document.getElementById('regClientCount');

        const clientsArray = Object.values(clients);
        countEl.textContent = `Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${clientsArray.length} Ø¹Ù…ÙŠÙ„`;

        renderClientsList(clientsArray);

      } catch (err) {
        showAlert('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡: ' + err.message, 'error');
      }
    }

    document.getElementById('refreshRegClientsBtn').addEventListener('click', loadRegisteredClients);

    document.getElementById('addRegClientBtn').addEventListener('click', async () => {
      // Gather inputs first to avoid errors
      // const idStr = document.getElementById('regClientId').value; // OLD
      const fullName = document.getElementById('regFullName').value.trim();
      const phone = document.getElementById('regPhone').value.trim();
      const agencyName = document.getElementById('regAgency').value.trim();
      const country = document.getElementById('regCountry').value.trim();
      const city = document.getElementById('regCity').value.trim();
      const address = document.getElementById('regAddress').value.trim();

      if (!fullName) {
        showAlert('Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ Ù…Ø·Ù„ÙˆØ¨', 'error');
        return;
      }

      // Parse IDs from dynamic fields
      const ids = [];
      document.querySelectorAll('input[name="regClientId"]').forEach(input => {
        const val = input.value.trim();
        if (val) ids.push(val);
      });

      if (ids.length === 0) {
        showAlert('ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ ID ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„', 'error');
        return;
      }

      // Collect Custom Fields
      const customFields = {};
      const customFieldInputs = document.querySelectorAll('#customFieldsContainer input, #customFieldsContainer select');

      customFieldInputs.forEach(input => {
        // Skip sub-field inputs here, we handle them with their parent
        if (input.classList.contains('sub-field-input')) return;

        if (input.id.startsWith('customField_')) {
          const key = input.id.replace('customField_', '');
          const value = input.value.trim() || null;

          if (value) {
            customFields[key] = value;

            // Check for sub-field value if this is a dropdown
            if (input.tagName === 'SELECT') {
              const subInput = document.getElementById(`${input.id}_sub`);
              if (subInput && subInput.offsetParent !== null) { // Check if visible
                const subKey = `${key}__sub`;
                customFields[subKey] = subInput.value.trim() || null;
              }
            }
          }
        }
      });

      try {
        if (editingRegClientKey) {
          // Update Mode
          const data = {
            ids, // NOW WE SEND IDS
            fullName, phone, agencyName, country, city, address, customFields
          };
          await api('PUT', `/api/ai/registered-clients/${editingRegClientKey}`, data);
          showAlert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­');
          editingRegClientKey = null;
          document.getElementById('addRegClientBtn').innerHTML = 'â• Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù…ÙŠÙ„';
          document.getElementById('addRegClientBtn').classList.remove('btn-success');
          document.getElementById('addRegClientBtn').classList.add('btn-primary');
          // document.getElementById('regClientId').disabled = false; // It's always enabled now
        } else {
          // Create Mode
          // const idVal = idStr.trim(); // Removed single ID logic
          // if (!idVal) { showAlert('Ø±Ù‚Ù… ID Ù…Ø·Ù„ÙˆØ¨ Ù„Ù„Ø¥Ø¶Ø§ÙØ©', 'error'); return; }

          const data = {
            ids, // Send array directly
            fullName, phone, agencyName, country, city, address, customFields
          };
          await api('POST', '/api/ai/registered-clients', data);
          showAlert('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­');
        }

        clearRegForm();
        loadRegisteredClients();

      } catch (err) {
        showAlert('ÙØ´Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©: ' + err.message, 'error');
      }
    });

    document.getElementById('clearRegFormBtn').addEventListener('click', clearRegForm);

    function clearRegForm() {
      // Reset IDs container to single empty input
      document.getElementById('regIdsContainer').innerHTML = `
           <div class="input-group" style="margin-bottom: 5px; display: flex; gap: 5px;">
              <input type="text" name="regClientId" placeholder="Ù…Ø«Ø§Ù„: 7099026" style="flex: 1;">
           </div>
      `;

      document.getElementById('regFullName').value = '';
      document.getElementById('regPhone').value = '';
      document.getElementById('regAgency').value = '';
      document.getElementById('regCountry').value = '';
      document.getElementById('regCity').value = '';
      document.getElementById('regAddress').value = '';

      document.querySelectorAll('#customFieldsContainer input, #customFieldsContainer select').forEach(i => {
        if (i.tagName === 'SELECT') {
          i.selectedIndex = 0;
        } else {
          i.value = '';
        }
      });

      // Hide all sub fields
      document.querySelectorAll('[id$="_subFieldContainer"]').forEach(el => {
        el.style.display = 'none';
        el.innerHTML = '';
      });

      // Reset Edit Mode
      editingRegClientKey = null;
      const btn = document.getElementById('addRegClientBtn');
      btn.innerHTML = 'â• Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù…ÙŠÙ„';
      btn.classList.remove('btn-success');
      btn.classList.add('btn-primary');
    }

    window.deleteRegClient = async (key) => {
      if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ØŸ')) return;
      try {
        await api('DELETE', `/api/ai/registered-clients/${key}`);
        showAlert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙŠÙ„');
        loadRegisteredClients();
      } catch (err) {
        showAlert('ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù: ' + err.message, 'error');
      }
    };

    window.promptAddId = async (key) => {
      const newId = prompt('Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù€ ID Ø§Ù„Ø¬Ø¯ÙŠØ¯:');
      if (!newId || !newId.trim()) return;

      try {
        await api('POST', '/api/ai/registered-clients/${key}/add-id', { newId: newId.trim() });
        showAlert('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù€ ID Ø¨Ù†Ø¬Ø§Ø­');
        loadRegisteredClients();
      } catch (err) {
        showAlert('ÙØ´Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù€ ID: ' + err.message, 'error');
      }
    };

    // Reset Client PIN
    window.resetClientPin = async (clientKey, clientName) => {
      if (!confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ¬Ø¯ÙŠØ¯ Ø±Ù…Ø² PIN Ù„Ù„Ø¹Ù…ÙŠÙ„ "${clientName}"ØŸ\n\nØ³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨.`)) return;
      
      try {
        const result = await api('POST', `/api/admin/clients/${clientKey}/reset-pin`);
        
        if (result.warning) {
          // WhatsApp failed but PIN was generated
          showAlert(`âš ï¸ ${result.warning}\n\nØ§Ù„Ø±Ù…Ø² Ø§Ù„Ø¬Ø¯ÙŠØ¯: ${result.newPin}`, 'error');
        } else {
          showAlert(`âœ… ØªÙ… ØªØ¬Ø¯ÙŠØ¯ PIN Ù„Ù„Ø¹Ù…ÙŠÙ„ ${result.clientName} ÙˆØ¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© ÙˆØ§ØªØ³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­`);
        }
      } catch (err) {
        showAlert('âŒ ÙØ´Ù„ ØªØ¬Ø¯ÙŠØ¯ PIN: ' + err.message, 'error');
      }
    };

    // Generate Portal Link
    window.generatePortalLink = async (clientKey, clientName) => {
      try {
        const result = await api('POST', `/api/admin/portal/generate/${clientKey}`);
        const fullUrl = window.location.origin + result.url;
        
        // Copy to clipboard
        await navigator.clipboard.writeText(fullUrl);
        
        showAlert(`âœ… Ø±Ø§Ø¨Ø· Ø§Ù„Ø¨ÙˆØ§Ø¨Ø© Ù„Ù„Ø¹Ù…ÙŠÙ„ "${clientName}":\n\n${fullUrl}\n\nğŸ“‹ ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·!`);
      } catch (err) {
        showAlert('âŒ ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø±Ø§Ø¨Ø·: ' + err.message, 'error');
      }
    };

    // Send Portal Links to All Main Agency Clients
    window.sendPortalLinksToAll = async () => {
      if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø±Ø³Ø§Ù„ Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ø¨ÙˆØ§Ø¨Ø© Ù„ÙƒÙ„ Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„ÙˆÙƒØ§Ù„Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (Main)?\n\nØ³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© ÙˆØ§ØªØ³Ø§Ø¨ Ù„ÙƒÙ„ Ø¹Ù…ÙŠÙ„ Ù„Ø¯ÙŠÙ‡ Ø±Ù‚Ù… Ù‡Ø§ØªÙ.')) return;
      
      try {
        showAlert('â³ Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±ÙˆØ§Ø¨Ø·...');
        const result = await api('POST', '/api/admin/portal/send-all');
        
        showAlert(`âœ… ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„!\n\nğŸ“¤ Ø£ÙØ±Ø³Ù„: ${result.results.sent}\nâŒ ÙØ´Ù„: ${result.results.failed}\nâ­ï¸ ØªØ®Ø·ÙŠ: ${result.results.skipped}`);
      } catch (err) {
        showAlert('âŒ ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: ' + err.message, 'error');
      }
    };

    // =====================================================
    // Linked Clients (WhatsApp linked users)
    // =====================================================

    async function loadLinkedClients() {
      try {
        const clients = await api('GET', '/api/ai/clients');
        const tbody = document.getElementById('linkedClientsBody');

        const clientsArray = Object.values(clients);
        if (!clientsArray.length) {
          tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #666;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù…Ù„Ø§Ø¡ Ù…Ø±Ø¨ÙˆØ·ÙŠÙ†</td></tr>';
          return;
        }

        tbody.innerHTML = clientsArray.map(c => `
          <tr>
            <td style="font-family: monospace; font-size: 0.85rem;">${c.whatsappId}</td>
            <td>${c.profile?.fullName || '-'}</td>
            <td>${c.profile?.city || '-'}</td>
            <td>${c.profile?.agencyName || '-'}</td>
            <td>${c.linkedClientId || c.profile?.ids?.join(', ') || '-'}</td>
            <td><span class="status-badge status-${c.status}">${c.status === 'complete' ? 'Ù…Ø±Ø¨ÙˆØ·' : 'Ù‚ÙŠØ¯ Ø§Ù„Ø±Ø¨Ø·'}</span></td>
            <td>${c.createdAt ? new Date(c.createdAt).toLocaleDateString('ar') : '-'}</td>
          </tr>
        `).join('');

      } catch (err) {
        showAlert('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù…Ø±Ø¨ÙˆØ·ÙŠÙ†: ' + err.message, 'error');
      }
    }

    // =====================================================
    // Custom Fields Management
    // =====================================================

    // Toggle dropdown options visibility
    document.getElementById('fieldType').addEventListener('change', function () {
      document.getElementById('dropdownOptionsSection').style.display =
        this.value === 'dropdown' ? 'block' : 'none';
    });

    async function loadCustomFields() {
      try {
        const fields = await api('GET', '/api/ai/custom-fields');
        const container = document.getElementById('fieldsList');

        if (!fields.length) {
          container.innerHTML = '<p style="color: #666; text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ù‚ÙˆÙ„ Ù…Ø®ØµØµØ©</p>';
          return;
        }

        container.innerHTML = fields.map(f => `
          <div class="period-item">
            <div class="period-info">
              <h4>${f.name} <span class="period-badge">${f.type}</span> ${f.required ? '<span style="color: #dc2626;">*</span>' : ''}</h4>
              <span>${f.type === 'dropdown' ? 'Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª: ' + (f.options?.join(', ') || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯') : ''}</span>
            </div>
            <div>
              ${f.type === 'dropdown' ? `<button class="btn btn-secondary" style="padding: 6px 12px; font-size: 0.8rem;" onclick="promptAddOption('${f.id}')">+ Ø®ÙŠØ§Ø±</button>` : ''}
              <button class="btn btn-danger" style="padding: 6px 12px; font-size: 0.8rem;" onclick="deleteField('${f.id}')">Ø­Ø°Ù</button>
            </div>
          </div>
        `).join('');

      } catch (err) {
        showAlert('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„: ' + err.message, 'error');
      }
    }

    // State for editing
    let editingFieldId = null;

    document.getElementById('refreshFieldsBtn').addEventListener('click', loadCustomFields);

    // Cancel edit mode
    function cancelEdit() {
      editingFieldId = null;
      document.getElementById('addFieldBtn').innerHTML = 'â• Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ù‚Ù„';
      document.getElementById('cancelEditBtn').style.display = 'none';
      document.getElementById('fieldName').value = '';
      document.getElementById('fieldType').value = 'text';
      document.getElementById('fieldRequired').value = 'false';
      document.getElementById('fieldType').disabled = false; // Allow changing type only when adding
      document.getElementById('dropdownOptionsSection').style.display = 'none';
      document.getElementById('dropdownOptionsInputs').innerHTML = `
        <div class="option-row" style="display: flex; gap: 8px; margin-bottom: 12px; align-items: flex-start; flex-wrap: wrap;">
          <input type="text" class="dropdown-option-value" placeholder="Ø§Ø³Ù… Ø§Ù„Ø®ÙŠØ§Ø±" style="flex: 2; min-width: 150px;">
          <select class="dropdown-option-subtype" style="flex: 1; min-width: 100px;" onchange="this.nextElementSibling.style.display = this.value ? 'block' : 'none'">
            <option value="">Ø¨Ø¯ÙˆÙ† Ø­Ù‚Ù„ ÙØ±Ø¹ÙŠ</option>
            <option value="text">Ù†Øµ</option>
            <option value="number">Ø±Ù‚Ù…</option>
            <option value="date">ØªØ§Ø±ÙŠØ®</option>
          </select>
          <input type="text" class="dropdown-option-sublabel" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„ÙØ±Ø¹ÙŠ" style="flex: 2; min-width: 150px; display: none;">
        </div>
      `;
      document.querySelector('.ai-card h2').textContent = 'Ø¥Ø¶Ø§ÙØ© Ø­Ù‚Ù„ Ø¬Ø¯ÙŠØ¯';
    }

    // Add dropdown option input field with sub-field support
    window.addDropdownOptionInputWithSubField = function (value = '', subType = '', subLabel = '') {
      const container = document.getElementById('dropdownOptionsInputs');
      const div = document.createElement('div');
      div.className = 'option-row';
      div.style.cssText = 'display: flex; gap: 8px; margin-bottom: 12px; align-items: flex-start; flex-wrap: wrap;';

      const subDisplay = subType ? 'block' : 'none';

      div.innerHTML = `
        <input type="text" class="dropdown-option-value" placeholder="Ø§Ø³Ù… Ø§Ù„Ø®ÙŠØ§Ø±" value="${value}" style="flex: 2; min-width: 150px;">
        <select class="dropdown-option-subtype" style="flex: 1; min-width: 100px;" onchange="this.nextElementSibling.style.display = this.value ? 'block' : 'none'">
          <option value="" ${subType === '' ? 'selected' : ''}>Ø¨Ø¯ÙˆÙ† Ø­Ù‚Ù„ ÙØ±Ø¹ÙŠ</option>
          <option value="text" ${subType === 'text' ? 'selected' : ''}>Ù†Øµ</option>
          <option value="number" ${subType === 'number' ? 'selected' : ''}>Ø±Ù‚Ù…</option>
          <option value="date" ${subType === 'date' ? 'selected' : ''}>ØªØ§Ø±ÙŠØ®</option>
        </select>
        <input type="text" class="dropdown-option-sublabel" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„ÙØ±Ø¹ÙŠ" value="${subLabel}" style="flex: 2; min-width: 150px; display: ${subDisplay};">
        <button type="button" class="btn btn-danger" style="padding: 6px 12px;" onclick="this.parentElement.remove()">âœ•</button>
      `;
      container.appendChild(div);
    };

    // Edit field
    window.editField = function (id) {
      // Lookup by ID since cache uses key
      const f = window.customFieldsCache[id];

      if (!f) return;

      editingFieldId = id;

      // Update UI
      document.querySelector('.ai-card h2').textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ù‚Ù„: ' + f.name;
      document.getElementById('addFieldBtn').innerHTML = 'ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª';
      document.getElementById('cancelEditBtn').style.display = 'inline-block';

      // Set values
      document.getElementById('fieldName').value = f.name;
      document.getElementById('fieldType').value = f.type;
      document.getElementById('fieldRequired').value = f.required.toString();

      // Type cannot be changed during edit to avoid data inconsistency
      document.getElementById('fieldType').disabled = true;

      // Handle dropdown options
      const dropdownSection = document.getElementById('dropdownOptionsSection');
      const dropdownInputs = document.getElementById('dropdownOptionsInputs');

      if (f.type === 'dropdown') {
        dropdownSection.style.display = 'block';
        dropdownInputs.innerHTML = ''; // Clear existing inputs

        f.options.forEach(opt => {
          let val = opt;
          let subType = '';
          let subLabel = '';

          if (typeof opt === 'object') {
            val = opt.value;
            if (opt.subField) {
              subType = opt.subField.type;
              subLabel = opt.subField.label;
            }
          }

          addDropdownOptionInputWithSubField(val, subType, subLabel);
        });
      } else {
        dropdownSection.style.display = 'none';
      }

      // Scroll to form
      document.querySelector('.ai-card').scrollIntoView({ behavior: 'smooth' });
    };

    document.getElementById('addFieldBtn').addEventListener('click', async () => {
      const name = document.getElementById('fieldName').value.trim();
      const type = document.getElementById('fieldType').value;
      const required = document.getElementById('fieldRequired').value === 'true';

      // Get dropdown options from inputs
      let options = [];
      let validationError = null;

      if (type === 'dropdown') {
        const rows = document.querySelectorAll('#dropdownOptionsInputs .option-row');
        rows.forEach(row => {
          const value = row.querySelector('.dropdown-option-value').value.trim();
          const subType = row.querySelector('.dropdown-option-subtype').value;
          const subLabel = row.querySelector('.dropdown-option-sublabel').value.trim();

          if (value) {
            if (subType) {
              if (!subLabel) {
                validationError = `Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„ÙØ±Ø¹ÙŠ Ù„Ù„Ø®ÙŠØ§Ø± "${value}"`;
                return;
              }
              options.push({
                value: value,
                subField: { type: subType, label: subLabel }
              });
            } else {
              options.push(value);
            }
          }
        });
      }

      if (validationError) {
        showAlert(validationError, 'error');
        return;
      }

      if (!name) {
        showAlert('Ø§Ø³Ù… Ø§Ù„Ø­Ù‚Ù„ Ù…Ø·Ù„ÙˆØ¨', 'error');
        return;
      }

      if (type === 'dropdown' && options.length === 0) {
        showAlert('ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØ© Ø®ÙŠØ§Ø± ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø©', 'error');
        return;
      }

      try {
        if (editingFieldId) {
          // Update existing field
          await api('PUT', `/api/ai/custom-fields/${editingFieldId}`, { name, required, options });
          showAlert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ù‚Ù„ Ø¨Ù†Ø¬Ø§Ø­');
          cancelEdit(); // Reset mode
        } else {
          // Create new field
          await api('POST', '/api/ai/custom-fields', { name, type, required, options });
          showAlert('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ù‚Ù„ Ø¨Ù†Ø¬Ø§Ø­');

          // Clear inputs
          document.getElementById('fieldName').value = '';
          document.getElementById('fieldType').value = 'text';
          document.getElementById('dropdownOptionsSection').style.display = 'none';
          document.getElementById('dropdownOptionsInputs').innerHTML = `
            <div class="option-row" style="display: flex; gap: 8px; margin-bottom: 12px; align-items: flex-start; flex-wrap: wrap;">
              <input type="text" class="dropdown-option-value" placeholder="Ø§Ø³Ù… Ø§Ù„Ø®ÙŠØ§Ø±" style="flex: 2; min-width: 150px;">
              <select class="dropdown-option-subtype" style="flex: 1; min-width: 100px;" onchange="this.nextElementSibling.style.display = this.value ? 'block' : 'none'">
                <option value="">Ø¨Ø¯ÙˆÙ† Ø­Ù‚Ù„ ÙØ±Ø¹ÙŠ</option>
                <option value="text">Ù†Øµ</option>
                <option value="number">Ø±Ù‚Ù…</option>
                <option value="date">ØªØ§Ø±ÙŠØ®</option>
              </select>
              <input type="text" class="dropdown-option-sublabel" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„ÙØ±Ø¹ÙŠ" style="flex: 2; min-width: 150px; display: none;">
            </div>
          `;
        }

        loadCustomFields();
        renderCustomFieldsInForm();
      } catch (err) {
        showAlert('ÙØ´Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©: ' + err.message, 'error');
      }
    });

    // Store fields data globally to avoid HTML attribute escaping issues
    window.customFieldsCache = {};
    window.customFieldsCacheByKey = {}; // Also store by key for easier lookup in form rendering

    // Render custom fields in client registration form
    async function renderCustomFieldsInForm() {
      try {
        const fields = await api('GET', '/api/ai/custom-fields');
        const container = document.getElementById('customFieldsContainer');

        // Update cache
        window.customFieldsCache = {}; // Clear previous cache
        window.customFieldsCacheByKey = {}; // New cache for lookup by key
        fields.forEach(f => {
          window.customFieldsCache[f.id] = f; // Cache by ID
          window.customFieldsCacheByKey[f.key] = f; // Cache by key
        });

        if (!fields.length) {
          container.innerHTML = '';
          return;
        }

        container.innerHTML = fields.map(f => {
          let inputHtml = '';
          const fieldId = `customField_${f.key}`;

          if (f.type === 'dropdown') {
            inputHtml = `
              <select id="${fieldId}" onchange="handleDropdownSubField(this, '${f.key}')">
                <option value="">Ø§Ø®ØªØ±...</option>
                ${f.options.map(o => {
              const val = typeof o === 'object' ? o.value : o;
              return `<option value="${val}">${val}</option>`;
            }).join('')}
              </select>
              <div id="${fieldId}_subFieldContainer" style="margin-top: 8px; display: none; padding: 8px; background: rgba(255,255,255,0.05); border-radius: 4px;">
                <!-- Sub field will be injected here -->
              </div>
            `;
          } else if (f.type === 'date') {
            inputHtml = `<input type="date" id="${fieldId}">`;
          } else if (f.type === 'number') {
            inputHtml = `<input type="number" id="${fieldId}">`;
          } else {
            inputHtml = `<input type="text" id="${fieldId}" placeholder="${f.name}">`;
          }

          return `
            <div class="field-group" style="margin-bottom: 12px;">
               <label style="display: block; margin-bottom: 4px; color: #a0a0b0;">${f.name} ${f.required ? '<span style="color: #ef4444">*</span>' : ''}</label>
               ${inputHtml}
            </div>
          `;
        }).join('');

      } catch (err) {
        console.error('Failed to render custom fields', err);
      }
    }

    // Lookups Logic
    async function loadLookups() {
      try {
        const data = await api('GET', '/api/ai/lookups');
        // Store lookups if needed, or just populate (but we don't have lookup dropdowns in add form YET, only input text)
        // Wait, the plan was to replace inputs with dropdowns? "update Dashboard: Selects".
        // The user code seems to rely on simple inputs still or I missed the selects update.
        // Effectively, if the inputs are IDs "agency", "country", "city", we can try to populate them if they are selects.
        // Let's check if elements are selects.

        const agencySelect = document.getElementById('agency');
        if (agencySelect && agencySelect.tagName === 'SELECT') {
          agencySelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„ÙˆÙƒØ§Ù„Ø©...</option>' +
            data.agencies.map(a => `<option value="${a}">${a}</option>`).join('');
        }

        const countrySelect = document.getElementById('country');
        if (countrySelect && countrySelect.tagName === 'SELECT') {
          countrySelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¯ÙˆÙ„Ø©...</option>' +
            Object.keys(data.countries).map(c => `<option value="${c}">${c}</option>`).join('');

          // City logic
          countrySelect.onchange = () => {
            const citySelect = document.getElementById('city');
            if (citySelect) {
              const cities = data.countries[countrySelect.value] || [];
              citySelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©...</option>' +
                cities.map(c => `<option value="${c}">${c}</option>`).join('');
            }
          };
        }

      } catch (err) {
        console.error('Failed to load lookups', err);
      }
    }


    // Load custom fields for management
    async function loadCustomFields() {
      try {
        const fields = await api('GET', '/api/ai/custom-fields');
        const container = document.getElementById('fieldsList');
        container.innerHTML = fields.map(f => `
          <div class="period-item">
            <div class="period-info">
              <h4>${f.name} <span class="period-badge">${f.type}</span> ${f.required ? '<span style="color: #dc2626;">*</span>' : ''}</h4>
              <span>${f.type === 'dropdown' ? 'Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª: ' + (f.options?.map(o => typeof o === 'object' ? o.value : o).join(', ') || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯') : ''}</span>
            </div>
            <div>
              ${f.type === 'dropdown' ? `<button class="btn btn-secondary" style="padding: 6px 12px; font-size: 0.8rem;" onclick="promptAddOption('${f.id}')">+ Ø®ÙŠØ§Ø±</button>` : ''}
              <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 0.8rem; background: #3b82f6;" onclick="editField('${f.id}')">ØªØ¹Ø¯ÙŠÙ„</button>
              <button class="btn btn-danger" style="padding: 6px 12px; font-size: 0.8rem;" onclick="deleteField('${f.id}')">Ø­Ø°Ù</button>
            </div>
          </div>
        `).join('');

      } catch (err) {
        showAlert('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„: ' + err.message, 'error');
      }
    }

    // Handle showing/hiding sub-fields for dropdowns
    window.handleDropdownSubField = function (selectEl, fieldKey) {
      const field = window.customFieldsCacheByKey[fieldKey];
      if (!field) return;

      const selectedValue = selectEl.value;
      const subContainer = document.getElementById(`${selectEl.id}_subFieldContainer`);

      const selectedOption = field.options.find(o => (typeof o === 'object' ? o.value : o) === selectedValue);

      if (selectedOption && typeof selectedOption === 'object' && selectedOption.subField) {
        const sf = selectedOption.subField;
        const subId = `${selectEl.id}_sub`;

        let subInput = '';
        if (sf.type === 'date') subInput = `<input type="date" id="${subId}" class="sub-field-input">`;
        else if (sf.type === 'number') subInput = `<input type="number" id="${subId}" class="sub-field-input" placeholder="${sf.label}">`;
        else subInput = `<input type="text" id="${subId}" class="sub-field-input" placeholder="${sf.label}">`;

        subContainer.innerHTML = `
          <label style="font-size: 0.85em; color: #a0a0b0; display: block; margin-bottom: 4px;">${sf.label}</label>
          ${subInput}
        `;
        subContainer.style.display = 'block';
      } else {
        subContainer.style.display = 'none';
        subContainer.innerHTML = '';
      }
    };

    // Import / Export Logic
    window.exportClients = async () => {
      try {
        const token = getCookie('token');
        const response = await fetch('/api/ai/registered-clients/export', {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) {
          const text = await response.text();
          throw new Error(`${response.status} ${response.statusText}: ${text}`);
        }

        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'clients_export.csv';
        document.body.appendChild(a);
        a.click();
        a.remove();
      } catch (err) {
        showAlert('ÙØ´Ù„ Ø§Ù„ØªØµØ¯ÙŠØ±: ' + err.message, 'error');
      }
    };

    window.downloadTemplate = async () => {
      try {
        const token = getCookie('token');
        const response = await fetch('/api/ai/registered-clients/template', {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) {
          const text = await response.text();
          throw new Error(`${response.status} ${response.statusText}: ${text}`);
        }

        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'clients_template.csv';
        document.body.appendChild(a);
        a.click();
        a.remove();
      } catch (err) {
        showAlert('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ù„Ø¨: ' + err.message, 'error');
      }
    };

    window.importClients = async (input) => {
      if (!input.files || !input.files[0]) return;

      const file = input.files[0];
      const formData = new FormData();
      formData.append('file', file);

      try {
        showAlert('Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù ÙˆÙ…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª... â³');
        const token = getCookie('token');
        const response = await fetch('/api/ai/registered-clients/import', {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}` },
          body: formData
        });

        const result = await response.json();

        if (result.success) {
          let msg = `ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨Ù†Ø¬Ø§Ø­! âœ…\nØ¥Ø¶Ø§ÙØ©: ${result.imported}\nØªØ­Ø¯ÙŠØ«: ${result.updated}`;
          if (result.errors && result.errors.length > 0) {
            msg += `\n\nâš ï¸ Ø£Ø®Ø·Ø§Ø¡ (${result.errors.length}):\n` + result.errors.slice(0, 5).join('\n') + (result.errors.length > 5 ? '\n...' : '');
          }
          showAlert(msg, result.errors.length > 0 ? 'warning' : 'success');
          loadRegisteredClients(); // Refresh list
        } else {
          throw new Error(result.error || 'Unknown error');
        }
      } catch (err) {
        showAlert('ÙØ´Ù„ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯: ' + err.message, 'error');
      } finally {
        input.value = ''; // Reset input
      }
    };

    // Send Salary To All
    window.sendSalaryToAll = async () => {
      if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø±Ø§ØªØ¨ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ø°ÙŠÙ† Ù„Ø¯ÙŠÙ‡Ù… Ø±Ø§ØªØ¨ ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©ØŸ\nÙ‡Ø°Ø§ Ù‚Ø¯ ÙŠØ³ØªØºØ±Ù‚ Ø¨Ø¹Ø¶ Ø§Ù„ÙˆÙ‚Øª.')) return;

      try {
        showAlert('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„... â³', 'info');
        const token = getCookie('token');
        const response = await fetch('/api/ai/notify/salary-all', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        const result = await response.json();
        if (result.success) {
          let msg = `ØªÙ… Ø§Ù„Ø¥Ù†ØªÙ‡Ø§Ø¡! âœ…\nØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: ${result.sent}\nØªØ¬Ø§ÙˆØ² (Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ø§ØªØ¨): ${result.skipped}`;
          if (result.errors > 0) msg += `\nØ£Ø®Ø·Ø§Ø¡: ${result.errors}`;
          showAlert(msg, 'success');
        } else {
          throw new Error(result.error);
        }
      } catch (err) {
        showAlert('ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ: ' + err.message, 'error');
      }
    };

    window.deleteField = async (id) => {
      if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø­Ù‚Ù„ØŸ')) return;
      try {
        await api('DELETE', `/api/ai/custom-fields/${id}`);
        showAlert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø­Ù‚Ù„');
        loadCustomFields();
        renderCustomFieldsInForm();
      } catch (err) {
        showAlert('ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù: ' + err.message, 'error');
      }
    };

    window.promptAddOption = async (id) => {
      const option = prompt('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯:');
      if (!option || !option.trim()) return;

      try {
        await api('POST', `/api/ai/custom-fields/${id}/options`, { option: option.trim() });
        showAlert('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø®ÙŠØ§Ø±');
        loadCustomFields();
        renderCustomFieldsInForm();
      } catch (err) {
        showAlert('ÙØ´Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø®ÙŠØ§Ø±: ' + err.message, 'error');
      }
    };

    // Dynamic ID Fields Logic
    window.addIdField = (value = '') => {
      const container = document.getElementById('regIdsContainer');
      const div = document.createElement('div');
      div.className = 'input-group';
      div.style.cssText = 'margin-bottom: 5px; display: flex; gap: 5px;';

      div.innerHTML = `
           <input type="text" name="regClientId" value="${value}" placeholder="ID Ø¥Ø¶Ø§ÙÙŠ" style="flex: 1;">
           <button class="btn btn-danger" style="padding: 0 8px;" onclick="this.parentElement.remove()">âœ•</button>
        `;
      container.appendChild(div);
    };

    // Initial load
    loadSettings();
    loadPeriods();
    loadUsage();
    loadLookups(); // NEW
    loadRegisteredClients();
    loadLinkedClients();
    loadCustomFields();
    renderCustomFieldsInForm();
    loadSettingsFromBackend(); // NEW: Load initial settings

    // Settings Logic
    async function loadSettingsFromBackend() {
      try {
        const settings = await api('GET', '/api/ai/settings');

      } catch (err) {
        console.error('Failed to load settings', err);
      }
    }

    // Template Variable Insertion


    document.getElementById('saveSettingsBtn').addEventListener('click', async (e) => {
      e.preventDefault();
      const btn = e.target;
      const originalText = btn.innerText;
      btn.innerText = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';
      btn.disabled = true;

      try {
        const data = {
          // AI Settings
          enabled: document.getElementById('aiEnabled')?.checked || false,
          openaiKey: document.getElementById('openaiKey')?.value || '',
          modelChat: document.getElementById('modelChat')?.value || 'gpt-4-turbo',
          modelStt: document.getElementById('modelStt')?.value || 'whisper-1',
          modelTts: document.getElementById('modelTts')?.value || 'tts-1',
          voiceTts: document.getElementById('voiceTts')?.value || 'alloy',
          trustedSessionMinutes: parseInt(document.getElementById('trustedSessionMinutes')?.value) || 15,
          agencyPercent: parseFloat(document.getElementById('agencyPercent')?.value) || 0
        };

        // Send all to unified endpoint
        await api('POST', '/api/ai/settings', data);
        showAlert('ØªÙ… Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ù‚ÙˆØ§Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­ âœ…');

      } catch (err) {
        console.error(err);
        showAlert('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª: ' + err.message, 'error');
      } finally {
        btn.innerText = originalText;
        btn.disabled = false;
      }
    });



    // Broadcast Logic
    let currentBroadcastTargets = [];

    function promptBroadcast() {
      const searchQ = document.getElementById('searchRegClientInput').value.trim();
      const filterText = searchQ ? `Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù†: "${searchQ}"` : 'ÙƒÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ†';

      // Collect current list IDs (or fetch fresh if needed, but UI list is easiest reference)
      // Ideally we fetch from backend search if we want to be robust, but for now lets use the ones we have in memory 
      // Or better yet, pass the current query to the backend to resolve targets.
      // Let's rely on the frontend list logic since we have `renderClientsList` populating `clientsArray`.
      // BUT `clientsArray` is local scope to `loadRegisteredClients`. Let's assume we send ALL or Filtered.

      // Strategy: We will fetch all clients again to be safe.
      // If search is active, we use search endpoint.

      document.getElementById('broadcastFilterInfo').textContent = filterText;
      document.getElementById('broadcastMessage').value = '';
      document.getElementById('broadcastModal').style.display = 'flex';
    }

    async function sendBroadcast() {
      const message = document.getElementById('broadcastMessage').value.trim();
      if (!message) {
        alert('ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø±Ø³Ø§Ù„Ø©');
        return;
      }

      if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¨Ø¯Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹.')) return;

      const q = document.getElementById('searchRegClientInput').value.trim();
      let targets = [];

      try {
        if (q) {
          targets = await api('GET', `/api/ai/registered-clients/search/query?q=${encodeURIComponent(q)}`);
        } else {
          targets = await api('GET', '/api/ai/registered-clients'); // Get all (key-value map)
          targets = Object.values(targets);
        }

        if (targets.length === 0) {
          alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù…Ù„Ø§Ø¡ Ù…Ø³ØªÙ‡Ø¯ÙÙŠÙ†!');
          return;
        }

        const res = await api('POST', '/api/ai/notify/broadcast', { clients: targets, message });

        document.getElementById('broadcastModal').style.display = 'none';
        showAlert(`ØªÙ…Øª Ø¬Ø¯ÙˆÙ„Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„Ù€ ${res.queued} Ø¹Ù…ÙŠÙ„ ğŸš€`);

      } catch (err) {
        showAlert('ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: ' + err.message, 'error');
      }
    }
  </script>

  <!-- Notification Modal -->
  <div id="notifyModal" class="modal"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center;">
    <div class="ai-card" style="width: 90%; max-width: 500px; margin: 0;">
      <h3 style="margin-top: 0;">Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± <span id="notifyModalClientName" style="color: #3b82f6;"></span></h3>

      <div class="form-group">
        <label>Ù†ÙˆØ¹ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±</label>
        <select id="notifyType" onchange="toggleNotifyType(this.value)">
          <option value="custom">Ø±Ø³Ø§Ù„Ø© Ù…Ø®ØµØµØ©</option>
          <option value="salary">Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø±Ø§ØªØ¨</option>
        </select>
      </div>

      <div id="notifyCustomSection">
        <div class="form-group">
          <label>Ø§Ù„Ø±Ø³Ø§Ù„Ø©</label>
          <textarea id="notifyMessage" rows="5" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§..."></textarea>
        </div>
      </div>

      <div id="notifySalarySection" style="display: none;">
        <p style="color: #ccc; background: rgba(255,255,255,0.05); padding: 10px; border-radius: 4px;">
          Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± ÙŠØªØ¶Ù…Ù† ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø±Ø§ØªØ¨ Ù„Ù„ÙØªØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© (Ø¥Ù† ÙˆØ¬Ø¯).
        </p>
      </div>

      <div style="display: flex; gap: 8px; justify-content: flex-end; margin-top: 20px;">
        <button class="btn btn-secondary" onclick="closeNotifyModal()">Ø¥Ù„ØºØ§Ø¡</button>
        <button class="btn btn-primary" onclick="sendNotification()">Ø¥Ø±Ø³Ø§Ù„ ğŸš€</button>
      </div>
    </div>
  </div>

  <!-- Broadcast Modal -->
  <div id="broadcastModal" class="modal"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center;">
    <div class="ai-card" style="width: 90%; max-width: 600px; margin: 0;">
      <h3 style="margin-top: 0;">ğŸ“¢ Ø¥Ø±Ø³Ø§Ù„ Ø¬Ù…Ø§Ø¹ÙŠ (Broadcast)</h3>

      <div class="alert alert-warning" style="font-size: 0.9em; margin-bottom: 15px;">
        âš ï¸ Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø¨ÙÙˆØ§ØµÙ„ Ø²Ù…Ù†ÙŠØ© Ø¹Ø´ÙˆØ§Ø¦ÙŠØ© (5-15 Ø«Ø§Ù†ÙŠØ©) Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø­Ø¸Ø±.
      </div>

      <div class="form-group">
        <label>Ø§Ù„ÙÙ„ØªØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©:</label>
        <div id="broadcastFilterInfo"
          style="padding: 10px; background: rgba(255,255,255,0.05); border-radius: 4px; font-family: monospace;">
          ÙƒÙ„ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡
        </div>
        <p style="font-size: 0.8em; color: #a0a0b0; margin-top: 5px;">* Ø³ÙŠØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ø¸Ø§Ù‡Ø±ÙŠÙ† ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„
          Ø­Ø§Ù„ÙŠØ§Ù‹ (Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø­Ø«).</p>
      </div>

      <div class="form-group">
        <label>Ø§Ù„Ø±Ø³Ø§Ù„Ø©</label>
        <textarea id="broadcastMessage" rows="6" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§..."></textarea>
      </div>

      <div style="display: flex; gap: 8px; justify-content: flex-end; margin-top: 20px;">
        <button class="btn btn-secondary"
          onclick="document.getElementById('broadcastModal').style.display='none'">Ø¥Ù„ØºØ§Ø¡</button>
        <button class="btn btn-primary" onclick="sendBroadcast()">Ø¨Ø¯Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ ğŸš€</button>
      </div>
    </div>
  </div>


  <!-- Lookups Management Modal -->
  <div id="lookupModal" class="modal"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center;">
    <div class="ai-card" style="width: 90%; max-width: 500px; margin: 0;">
      <h3 id="lookupModalTitle" style="margin-top: 0;">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù‚ÙˆØ§Ø¦Ù…</h3>
      <div id="lookupList"
        style="max-height: 300px; overflow-y: auto; margin-bottom: 20px; border: 1px solid #333; padding: 10px;">
        <!-- Items will be here -->
      </div>
      <div style="display: flex; gap: 8px;">
        <input type="text" id="newLookupItem" placeholder="Ø¹Ù†ØµØ± Ø¬Ø¯ÙŠØ¯" style="flex: 1;">
        <button class="btn btn-primary" onclick="addLookupItem()">Ø¥Ø¶Ø§ÙØ©</button>
      </div>
      <div style="margin-top: 20px; text-align: right;">
        <button class="btn btn-secondary"
          onclick="document.getElementById('lookupModal').style.display='none'">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
    </div>
  </div>

  <script>
    // Global Lookups State
    let globalLookups = { agencies: [], countries: [] };
    let currentLookupType = ''; // agency, country, city
    let currentLookupParent = ''; // for city (country name)

    async function loadLookups() {
      try {
        globalLookups = await api('GET', '/api/ai/lookups');
        renderLookupSelects();
      } catch (err) {
        console.error('Failed to load lookups', err);
      }
    }

    function renderLookupSelects() {
      // Agency
      const agencySelect = document.getElementById('regAgency');
      const currentAgency = agencySelect.value;
      agencySelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„ÙˆÙƒØ§Ù„Ø©...</option>' +
        globalLookups.agencies.map(a => `<option value="${a}">${a}</option>`).join('');
      agencySelect.value = currentAgency;

      // Country
      const countrySelect = document.getElementById('regCountry');
      const currentCountry = countrySelect.value;
      countrySelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¯ÙˆÙ„Ø©...</option>' +
        globalLookups.countries.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
      countrySelect.value = currentCountry;

      renderCityOptions();
    }

    function renderCityOptions() {
      const countryName = document.getElementById('regCountry').value;
      const citySelect = document.getElementById('regCity');
      const currentCity = citySelect.value; // Store if possible

      citySelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©...</option>';

      if (!countryName) return;

      const country = globalLookups.countries.find(c => c.name === countryName);
      if (country && country.cities) {
        citySelect.innerHTML += country.cities.map(c => `<option value="${c}">${c}</option>`).join('');
      }

      // Restore if valid
      if (currentCity) citySelect.value = currentCity;
    }

    // Management UI
    function promptManageLookups(type) {
      currentLookupType = type;
      document.getElementById('lookupModal').style.display = 'flex';

      if (type === 'city') {
        const country = document.getElementById('regCountry').value;
        if (!country) {
          alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¯ÙˆÙ„Ø© Ø£ÙˆÙ„Ø§Ù‹ Ù„Ø¥Ø¯Ø§Ø±Ø© Ù…Ø¯Ù†Ù‡Ø§.');
          document.getElementById('lookupModal').style.display = 'none';
          return;
        }
        currentLookupParent = country;
        document.getElementById('lookupModalTitle').textContent = `Ø¥Ø¯Ø§Ø±Ø© Ù…Ø¯Ù†: ${country}`;
      } else if (type === 'country') {
        document.getElementById('lookupModalTitle').textContent = 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¯ÙˆÙ„';
      } else {
        document.getElementById('lookupModalTitle').textContent = 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙˆÙƒØ§Ù„Ø§Øª';
      }

      renderLookupList();
    }

    function renderLookupList() {
      const list = document.getElementById('lookupList');
      let items = [];

      if (currentLookupType === 'agency') {
        items = globalLookups.agencies;
      } else if (currentLookupType === 'country') {
        items = globalLookups.countries.map(c => c.name);
      } else if (currentLookupType === 'city') {
        const c = globalLookups.countries.find(x => x.name === currentLookupParent);
        items = c ? c.cities : [];
      }

      list.innerHTML = items.map(item => `
            <div style="display: flex; justify-content: space-between; padding: 5px; border-bottom: 1px solid #444;">
                <span>${item}</span>
                <button onclick="removeLookupItem('${item}')" style="background: none; border: none; cursor: pointer;">ğŸ—‘ï¸</button>
            </div>
        `).join('');
    }

    async function addLookupItem() {
      const val = document.getElementById('newLookupItem').value.trim();
      if (!val) return;

      try {
        if (currentLookupType === 'agency') {
          await api('POST', '/api/ai/lookups/agency', { name: val });
        } else if (currentLookupType === 'country') {
          await api('POST', '/api/ai/lookups/country', { name: val });
        } else if (currentLookupType === 'city') {
          await api('POST', '/api/ai/lookups/city', { country: currentLookupParent, city: val });
        }

        document.getElementById('newLookupItem').value = '';
        await loadLookups(); // Reload all
        renderLookupList(); // Re-render list
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    async function removeLookupItem(val) {
      if (!confirm('Ø­Ø°ÙØŸ')) return;
      try {
        if (currentLookupType === 'agency') {
          await api('DELETE', `/api/ai/lookups/agency/${encodeURIComponent(val)}`);
        } else if (currentLookupType === 'country') {
          await api('DELETE', `/api/ai/lookups/country/${encodeURIComponent(val)}`);
        } else if (currentLookupType === 'city') {
          await api('DELETE', `/api/ai/lookups/city/${encodeURIComponent(currentLookupParent)}/${encodeURIComponent(val)}`);
        }

        await loadLookups(); // Reload all
        renderLookupList(); // Re-render list
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    // Existing notification logic
    let currentNotifyClientKey = null;
    let currentNotifyPhone = null;

    function promptNotify(key, name, phone) {
      if (!phone) {
        showAlert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ù…Ø³Ø¬Ù„ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„', 'error');
        return;
      }
      currentNotifyClientKey = key;
      currentNotifyPhone = phone;
      document.getElementById('notifyModalClientName').textContent = ` - ${name}`;
      document.getElementById('notifyModal').style.display = 'flex';
      document.getElementById('notifyType').value = 'custom';
      toggleNotifyType('custom');
    }

    function closeNotifyModal() {
      document.getElementById('notifyModal').style.display = 'none';
      currentNotifyClientKey = null;
      currentNotifyPhone = null;
      document.getElementById('notifyMessage').value = '';
    }

    function toggleNotifyType(type) {
      document.getElementById('notifyCustomSection').style.display = type === 'custom' ? 'block' : 'none';
      document.getElementById('notifySalarySection').style.display = type === 'salary' ? 'block' : 'none';
    }

    async function sendNotification() {
      const type = document.getElementById('notifyType').value;
      try {
        if (type === 'custom') {
          const message = document.getElementById('notifyMessage').value.trim();
          if (!message) {
            showAlert('ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø©', 'error');
            return;
          }
          await api('POST', '/api/ai/notify/custom', { phone: currentNotifyPhone, message });
          showAlert('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­ ğŸš€');
        } else {
          const res = await api('POST', '/api/ai/notify/salary', { clientKey: currentNotifyClientKey });
          showAlert(res.message ? 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± ÙˆÙ†Ø³Ø®Ø© Ù…Ù†Ù‡ Ù„Ùƒ âœ…' : 'ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„');
        }
        closeNotifyModal();
      } catch (err) {
        showAlert('ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: ' + err.message, 'error');
      }
    }

    // Edit Logic
    let editingRegClientKey = null;

    window.promptEditRegClient = async (key) => {
      try {
        const clients = await api('GET', '/api/ai/registered-clients');
        const client = clients[key];
        if (!client) return;

        editingRegClientKey = key;

        // Populate IDs
        const ids = client.ids || [];
        const container = document.getElementById('regIdsContainer');
        container.innerHTML = ''; // Clear existing

        if (ids.length > 0) {
          ids.forEach((id, index) => {
            if (index === 0) {
              // First one always exists (or recreate it)
              container.innerHTML = `
                       <div class="input-group" style="margin-bottom: 5px; display: flex; gap: 5px;">
                          <input type="text" name="regClientId" value="${id}" placeholder="Ù…Ø«Ø§Ù„: 7099026" style="flex: 1;">
                       </div>
                   `;
            } else {
              addIdField(id);
            }
          });
        } else {
          // Default empty
          container.innerHTML = `
               <div class="input-group" style="margin-bottom: 5px; display: flex; gap: 5px;">
                  <input type="text" name="regClientId" placeholder="Ù…Ø«Ø§Ù„: 7099026" style="flex: 1;">
               </div>
            `;
        }

        document.getElementById('regFullName').value = client.fullName || '';
        document.getElementById('regPhone').value = client.phone || '';
        document.getElementById('regAgency').value = client.agencyName || '';
        document.getElementById('regCountry').value = client.country || '';
        document.getElementById('regCity').value = client.city || '';
        document.getElementById('regAddress').value = client.address || '';

        // Delete Logic
        window.promptDeleteRegClient = async (key) => {
          if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹.')) return;
          try {
            await api('DELETE', `/api/ai/registered-clients/${key}`);
            showAlert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­ ğŸ—‘ï¸');
            loadRegisteredClients();
          } catch (err) {
            showAlert('ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù: ' + err.message, 'error');
          }
        };

        // Populate custom fields
        renderCustomFieldsInForm().then(() => {
          // Fill custom fields values
          if (client.customFields) {
            Object.entries(client.customFields).forEach(([k, v]) => {
              // Try to find main field
              const fieldId = `customField_${k}`;
              const el = document.getElementById(fieldId);
              if (el) {
                el.value = v;
                // Trigger change for dropdowns to show subfields
                if (el.tagName === 'SELECT') {
                  // We need to look up the field key to pass to handler
                  // Assuming 'k' is the key
                  if (window.handleDropdownSubField) {
                    try { window.handleDropdownSubField(el, k); } catch (e) { }
                  }
                }
              }

              // Try subfield
              if (k.includes('__sub')) {
                const originalKey = k.split('__sub')[0];
                const subId = `customField_${originalKey}_sub`;
                const subEl = document.getElementById(subId);
                if (subEl) subEl.value = v;
              }
            });
          }
        });

        // Change button state
        const btn = document.getElementById('addRegClientBtn');
        btn.innerHTML = 'ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª';
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-success');

        // Scroll to form
        document.querySelector('#registered .ai-card').scrollIntoView({ behavior: 'smooth' });

      } catch (err) {
        showAlert('Ø®Ø·Ø£: ' + err.message, 'error');
      }
    };

    // Search Logic
    document.getElementById('searchRegClientInput').addEventListener('input', async (e) => {
      const q = e.target.value.trim();
      if (q.length < 1) {
        loadRegisteredClients();
        return;
      }

      try {
        const results = await api('GET', `/api/ai/registered-clients/search/query?q=${encodeURIComponent(q)}`);
        renderClientsList(results);
      } catch (err) {
        console.error(err);
      }
    });

    function renderClientsList(clientsArray) {
      const tbody = document.getElementById('regClientsBody');
      const countEl = document.getElementById('regClientCount');
      countEl.textContent = `Ø§Ù„Ù†ØªØ§Ø¦Ø¬: ${clientsArray.length}`;

      // Reset select all checkbox
      document.getElementById('selectAllClients').checked = false;
      updateDeleteButton();

      if (!clientsArray.length) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: #666;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</td></tr>';
        return;
      }

      tbody.innerHTML = clientsArray.map(c => `
          <tr data-key="${c.key}">
            <td><input type="checkbox" class="client-checkbox" data-key="${c.key}" onchange="updateDeleteButton()"></td>
            <td style="font-family: monospace; font-size: 0.85rem;">
              ${(c.ids || []).join('<br>')}
              <button class="btn btn-secondary" style="padding: 2px 8px; font-size: 0.7rem; margin-top: 4px;" onclick="promptAddId('${c.key}')">+ ID</button>
            </td>
            <td>${c.fullName || '-'}</td>
            <td>${c.phone || '-'}</td>
            <td>${c.city || '-'}</td>
            <td>${c.agencyName || '-'}</td>
            <td>${c.createdAt ? new Date(c.createdAt).toLocaleDateString('ar') : '-'}</td>
            <td>
              <div style="display: flex; gap: 4px; flex-wrap: wrap;">
                <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 0.8rem; background: #3b82f6;" onclick="promptEditRegClient('${c.key}')">âœï¸</button>
                <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 0.8rem; background: #10b981;" onclick="promptNotify('${c.key}', '${c.fullName}', '${c.phone}')">ğŸ””</button>
                <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 0.8rem; background: #f59e0b;" onclick="resetClientPin('${c.key}', '${c.fullName}')" title="ØªØ¬Ø¯ÙŠØ¯ PIN">ğŸ”</button>
                <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 0.8rem; background: #8b5cf6;" onclick="generatePortalLink('${c.key}', '${c.fullName}')" title="Ø±Ø§Ø¨Ø· Ø§Ù„Ø¨ÙˆØ§Ø¨Ø©">ğŸ”—</button>
                <button class="btn btn-danger" style="padding: 4px 8px; font-size: 0.8rem;" onclick="promptDeleteRegClient('${c.key}')">ğŸ—‘ï¸</button>
              </div>
            </td>
          </tr>
        `).join('');
    }

    // Toggle select all checkboxes
    window.toggleSelectAll = (checkbox) => {
      const checkboxes = document.querySelectorAll('.client-checkbox');
      checkboxes.forEach(cb => cb.checked = checkbox.checked);
      updateDeleteButton();
    };

    // Update delete button visibility and count
    window.updateDeleteButton = () => {
      const checkboxes = document.querySelectorAll('.client-checkbox:checked');
      const count = checkboxes.length;
      const btn = document.getElementById('deleteSelectedBtn');
      const countEl = document.getElementById('selectedCount');
      
      if (count > 0) {
        btn.style.display = 'inline-block';
        countEl.textContent = count;
      } else {
        btn.style.display = 'none';
      }
    };

    // Delete selected clients
    window.deleteSelectedClients = async () => {
      const checkboxes = document.querySelectorAll('.client-checkbox:checked');
      const keys = Array.from(checkboxes).map(cb => cb.dataset.key);
      
      if (keys.length === 0) {
        showAlert('Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø£ÙŠ Ø¹Ù…ÙŠÙ„', 'error');
        return;
      }
      
      if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù ${keys.length} Ø¹Ù…ÙŠÙ„ØŸ\n\nâš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡!`)) return;
      
      try {
        const result = await api('POST', '/api/ai/registered-clients/bulk-delete', { keys });
        showAlert(`âœ… ØªÙ… Ø­Ø°Ù ${result.deleted} Ø¹Ù…ÙŠÙ„${result.failed > 0 ? `\nâŒ ÙØ´Ù„ Ø­Ø°Ù ${result.failed}` : ''}`);
        loadRegisteredClients();
      } catch (err) {
        showAlert('âŒ ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù: ' + err.message, 'error');
      }
    };

  </script>
</body>

</html>
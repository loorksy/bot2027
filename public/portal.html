<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Ø¨ÙˆØ§Ø¨ØªÙŠ</title>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #09090b;
      --surface: #18181b;
      --surface-highlight: #27272a;
      --border: #27272a;
      --primary: #10b981;
      --primary-dim: rgba(16, 185, 129, 0.1);
      --text: #e4e4e7;
      --text-muted: #a1a1aa;
      --text-dim: #71717a;
      --success: #059669;
      --success-bg: rgba(5, 150, 105, 0.15);
      --danger: #ef4444;
      --danger-bg: rgba(239, 68, 68, 0.1);
      --warning: #f59e0b;
      --warning-bg: rgba(245, 158, 11, 0.1);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'IBM Plex Sans Arabic', sans-serif;
      background: var(--bg);
      color: var(--text);
      font-size: 14px;
      line-height: 1.5;
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
    }

    /* App Shell */
    .app-shell {
      max-width: 480px;
      margin: 0 auto;
      min-height: 100vh;
      position: relative;
      padding-bottom: 72px;
    }

    /* Header */
    .header {
      position: sticky;
      top: 0;
      z-index: 100;
      background: rgba(9, 9, 11, 0.85);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--border);
      padding: 12px 16px;
    }

    .header-content {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .header-title {
      font-size: 15px;
      font-weight: 600;
      color: var(--text);
    }

    .header-subtitle {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .header-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: var(--primary-dim);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--primary);
    }

    .notification-btn {
      position: relative;
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      padding: 8px;
      border-radius: 8px;
      transition: all 0.2s;
    }

    .notification-btn:hover {
      background: var(--surface);
      color: var(--text);
    }

    .notification-badge {
      position: absolute;
      top: 4px;
      left: 4px;
      width: 16px;
      height: 16px;
      background: var(--danger);
      border-radius: 50%;
      font-size: 10px;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
    }

    /* Sections */
    .section {
      display: none;
      padding: 16px;
      animation: fadeIn 0.2s ease;
    }

    .section.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Cards */
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      transition: all 0.2s;
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .card-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .card-title svg {
      width: 16px;
      height: 16px;
      color: var(--primary);
    }

    /* Salary Card - Premium Style */
    .salary-card {
      background: linear-gradient(145deg, var(--surface) 0%, var(--bg) 100%);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 12px;
      position: relative;
      overflow: hidden;
    }

    .salary-card::before {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 100px;
      height: 100px;
      background: radial-gradient(circle, var(--primary-dim) 0%, transparent 70%);
      opacity: 0.5;
    }

    .salary-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .salary-period {
      font-size: 12px;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .salary-status {
      font-size: 10px;
      font-weight: 600;
      padding: 4px 10px;
      border-radius: 20px;
    }

    .status-paid {
      background: var(--success-bg);
      color: var(--success);
    }

    .status-pending {
      background: var(--warning-bg);
      color: var(--warning);
    }

    .salary-amount {
      text-align: center;
      padding: 16px 0;
      border-top: 1px dashed var(--border);
      border-bottom: 1px dashed var(--border);
      margin: 12px 0;
    }

    .salary-label {
      font-size: 11px;
      color: var(--text-dim);
      margin-bottom: 4px;
    }

    .salary-value {
      font-size: 28px;
      font-weight: 700;
      color: var(--primary);
      font-family: 'IBM Plex Sans Arabic', monospace;
      letter-spacing: -1px;
    }

    .salary-currency {
      font-size: 14px;
      font-weight: 400;
      color: var(--text-muted);
      margin-right: 4px;
    }

    .salary-details {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-top: 12px;
    }

    .salary-detail {
      text-align: center;
    }

    .detail-label {
      font-size: 10px;
      color: var(--text-dim);
      margin-bottom: 4px;
    }

    .detail-value {
      font-size: 13px;
      font-weight: 600;
      color: var(--text);
    }

    .detail-value.deduction {
      color: var(--danger);
    }

    /* Info List */
    .info-list {
      display: flex;
      flex-direction: column;
    }

    .info-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid var(--border);
    }

    .info-item:last-child {
      border-bottom: none;
    }

    .info-label {
      font-size: 12px;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .info-label svg {
      width: 14px;
      height: 14px;
      color: var(--text-dim);
    }

    .info-value {
      font-size: 13px;
      font-weight: 500;
      color: var(--text);
      text-align: left;
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 10px 16px;
      border: none;
      border-radius: 8px;
      font-family: inherit;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn svg {
      width: 14px;
      height: 14px;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: #0d9668;
      transform: translateY(-1px);
    }

    .btn-secondary {
      background: var(--surface-highlight);
      color: var(--text);
    }

    .btn-secondary:hover {
      background: var(--border);
    }

    .btn-ghost {
      background: transparent;
      color: var(--text-muted);
      padding: 8px;
    }

    .btn-ghost:hover {
      color: var(--text);
      background: var(--surface);
    }

    .btn-sm {
      padding: 6px 12px;
      font-size: 11px;
    }

    /* PIN Display */
    .pin-display {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      padding: 20px;
      background: var(--bg);
      border-radius: 12px;
      margin: 12px 0;
    }

    .pin-value {
      font-size: 24px;
      font-weight: 700;
      letter-spacing: 4px;
      font-family: monospace;
      color: var(--primary);
    }

    .pin-warning {
      font-size: 11px;
      color: var(--warning);
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 8px;
    }

    /* Chat */
    .chat-container {
      display: flex;
      flex-direction: column;
      height: calc(100vh - 180px);
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 12px 0;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .chat-bubble {
      max-width: 80%;
      padding: 10px 14px;
      border-radius: 16px;
      font-size: 13px;
      line-height: 1.5;
    }

    .chat-bubble.client {
      align-self: flex-start;
      background: var(--primary);
      color: white;
      border-bottom-right-radius: 4px;
    }

    .chat-bubble.admin {
      align-self: flex-end;
      background: var(--surface-highlight);
      color: var(--text);
      border-bottom-left-radius: 4px;
    }

    .chat-time {
      font-size: 10px;
      color: var(--text-dim);
      margin-top: 4px;
    }

    .chat-input-area {
      display: flex;
      gap: 8px;
      padding: 12px 0;
      border-top: 1px solid var(--border);
    }

    .chat-input {
      flex: 1;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 24px;
      padding: 10px 16px;
      color: var(--text);
      font-family: inherit;
      font-size: 13px;
      outline: none;
      transition: all 0.2s;
    }

    .chat-input:focus {
      border-color: var(--primary);
    }

    .chat-input::placeholder {
      color: var(--text-dim);
    }

    .chat-send {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--primary);
      border: none;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .chat-send:hover {
      transform: scale(1.05);
    }

    /* Notifications */
    .notification-item {
      display: flex;
      gap: 12px;
      padding: 12px;
      background: var(--surface);
      border-radius: 10px;
      margin-bottom: 8px;
      border: 1px solid var(--border);
      transition: all 0.2s;
    }

    .notification-item.unread {
      border-color: var(--primary);
      background: var(--primary-dim);
    }

    .notification-icon {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      background: var(--surface-highlight);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .notification-content {
      flex: 1;
      min-width: 0;
    }

    .notification-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 2px;
    }

    .notification-message {
      font-size: 12px;
      color: var(--text-muted);
      white-space: pre-line;
    }

    .notification-time {
      font-size: 10px;
      color: var(--text-dim);
      margin-top: 6px;
    }

    /* Receipt Items */
    .receipt-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: var(--bg);
      border-radius: 10px;
      margin-bottom: 8px;
    }

    .receipt-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      background: var(--surface-highlight);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--primary);
    }

    .receipt-info {
      flex: 1;
      min-width: 0;
    }

    .receipt-name {
      font-size: 12px;
      font-weight: 500;
      color: var(--text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .receipt-meta {
      font-size: 10px;
      color: var(--text-dim);
      margin-top: 2px;
    }

    .receipt-actions {
      display: flex;
      gap: 4px;
    }

    /* Bottom Navigation */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 100%;
      max-width: 480px;
      background: rgba(24, 24, 27, 0.95);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: space-around;
      padding: 8px 0;
      padding-bottom: max(8px, env(safe-area-inset-bottom));
      z-index: 100;
    }

    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      padding: 8px 16px;
      border: none;
      background: none;
      color: var(--text-dim);
      cursor: pointer;
      transition: all 0.2s;
      border-radius: 12px;
    }

    .nav-item svg {
      width: 20px;
      height: 20px;
    }

    .nav-item span {
      font-size: 10px;
      font-weight: 500;
    }

    .nav-item.active {
      color: var(--primary);
    }

    .nav-item.active svg {
      filter: drop-shadow(0 0 6px var(--primary));
    }

    .nav-item:hover:not(.active) {
      color: var(--text-muted);
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-muted);
    }

    .empty-state svg {
      width: 48px;
      height: 48px;
      color: var(--text-dim);
      margin-bottom: 12px;
    }

    .empty-state p {
      font-size: 13px;
    }

    /* Loading & Error States */
    .state-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
      text-align: center;
    }

    .spinner {
      width: 32px;
      height: 32px;
      border: 3px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .state-text {
      margin-top: 16px;
      font-size: 13px;
      color: var(--text-muted);
    }

    .hidden {
      display: none !important;
    }

    /* Modal */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: flex-end;
      justify-content: center;
      z-index: 200;
      padding: 0;
    }

    .modal-content {
      background: var(--surface);
      width: 100%;
      max-width: 480px;
      max-height: 90vh;
      border-radius: 20px 20px 0 0;
      padding: 20px;
      overflow-y: auto;
      animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
      from { transform: translateY(100%); }
      to { transform: translateY(0); }
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border);
    }

    .modal-title {
      font-size: 15px;
      font-weight: 600;
    }

    .modal-close {
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      padding: 4px;
    }

    /* Form Fields */
    .form-group {
      margin-bottom: 16px;
    }

    .form-label {
      display: block;
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 6px;
    }

    .form-input {
      width: 100%;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px 12px;
      color: var(--text);
      font-family: inherit;
      font-size: 13px;
      outline: none;
      transition: all 0.2s;
    }

    .form-input:focus {
      border-color: var(--primary);
    }

    /* Alert */
    .alert {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--surface);
      border: 1px solid var(--border);
      padding: 12px 20px;
      border-radius: 10px;
      font-size: 13px;
      z-index: 300;
      animation: slideDown 0.3s ease;
      max-width: 90%;
    }

    .alert.success {
      border-color: var(--success);
      background: var(--success-bg);
    }

    .alert.error {
      border-color: var(--danger);
      background: var(--danger-bg);
    }

    @keyframes slideDown {
      from { transform: translate(-50%, -100%); opacity: 0; }
      to { transform: translate(-50%, 0); opacity: 1; }
    }

    /* Quick Stats Row */
    .stats-row {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 16px;
    }

    .stat-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      text-align: center;
    }

    .stat-value {
      font-size: 20px;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 4px;
    }

    .stat-label {
      font-size: 11px;
      color: var(--text-muted);
    }

    /* Section Title */
    .section-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .section-title svg {
      width: 16px;
      height: 16px;
      color: var(--primary);
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <!-- Loading State -->
    <div id="loadingState" class="state-container">
      <div class="spinner"></div>
      <p class="state-text">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
    </div>

    <!-- Error State -->
    <div id="errorState" class="state-container hidden">
      <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="color: var(--danger);">
        <circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/>
      </svg>
      <p class="state-text">Ø±Ø§Ø¨Ø· ØºÙŠØ± ØµØ§Ù„Ø­ Ø£Ùˆ Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</p>
    </div>

    <!-- Main Content -->
    <div id="mainContent" class="hidden">
      <!-- Header -->
      <header class="header">
        <div class="header-content">
          <div style="display: flex; align-items: center; gap: 12px;">
            <div class="header-avatar">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>
              </svg>
            </div>
            <div>
              <div class="header-title" data-testid="header-name">Ù…Ø±Ø­Ø¨Ø§Ù‹</div>
              <div class="header-subtitle">Ø¨ÙˆØ§Ø¨ØªÙƒ Ø§Ù„Ø´Ø®ØµÙŠØ©</div>
            </div>
          </div>
          <button class="notification-btn" onclick="showNotifications()" data-testid="notification-btn">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/>
            </svg>
            <span id="notifBadge" class="notification-badge hidden">0</span>
          </button>
        </div>
      </header>

      <!-- Home Section -->
      <section id="section-home" class="section active" data-testid="section-home">
        <!-- Quick Stats -->
        <div class="stats-row">
          <div class="stat-card" data-testid="stat-total-salary">
            <div class="stat-value" id="statTotalSalary">0</div>
            <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±Ø§ØªØ¨</div>
          </div>
          <div class="stat-card" data-testid="stat-net-salary">
            <div class="stat-value" id="statNetSalary">0</div>
            <div class="stat-label">ØµØ§ÙÙŠ Ø§Ù„Ø±Ø§ØªØ¨</div>
          </div>
        </div>

        <!-- Latest Salary -->
        <div class="section-title">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 7V4a1 1 0 0 0-1-1H5a2 2 0 0 0 0 4h15a1 1 0 0 1 1 1v4h-3a2 2 0 0 0 0 4h3a1 1 0 0 0 1-1v-2a1 1 0 0 0-1-1"/><path d="M3 5v14a2 2 0 0 0 2 2h15a1 1 0 0 0 1-1v-4"/>
          </svg>
          Ø¢Ø®Ø± Ø±Ø§ØªØ¨
        </div>
        <div id="latestSalaryCard"></div>

        <!-- Recent Notifications -->
        <div class="section-title" style="margin-top: 20px;">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/>
          </svg>
          Ø¢Ø®Ø± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
        </div>
        <div id="recentNotifications"></div>
      </section>

      <!-- Salaries Section -->
      <section id="section-salaries" class="section" data-testid="section-salaries">
        <div class="section-title">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 7V4a1 1 0 0 0-1-1H5a2 2 0 0 0 0 4h15a1 1 0 0 1 1 1v4h-3a2 2 0 0 0 0 4h3a1 1 0 0 0 1-1v-2a1 1 0 0 0-1-1"/><path d="M3 5v14a2 2 0 0 0 2 2h15a1 1 0 0 0 1-1v-4"/>
          </svg>
          Ø³Ø¬Ù„ Ø§Ù„Ø±ÙˆØ§ØªØ¨
        </div>
        <div id="salariesList"></div>
      </section>

      <!-- Chat Section -->
      <section id="section-chat" class="section" data-testid="section-chat">
        <div class="chat-container">
          <div class="chat-messages" id="chatMessages"></div>
          <div class="chat-input-area">
            <input type="text" class="chat-input" id="chatInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ..." data-testid="chat-input">
            <button class="chat-send" onclick="sendMessage()" data-testid="chat-send">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/>
              </svg>
            </button>
          </div>
        </div>
      </section>

      <!-- Profile Section -->
      <section id="section-profile" class="section" data-testid="section-profile">
        <!-- Profile Info -->
        <div class="card">
          <div class="card-header">
            <div class="card-title">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>
              </svg>
              Ø¨ÙŠØ§Ù†Ø§ØªÙŠ
            </div>
            <button class="btn btn-sm btn-secondary" onclick="openEditModal()" data-testid="edit-profile-btn">
              <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/>
              </svg>
              ØªØ¹Ø¯ÙŠÙ„
            </button>
          </div>
          <div class="info-list" id="profileInfo"></div>
        </div>

        <!-- PIN Card -->
        <div class="card">
          <div class="card-header">
            <div class="card-title">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/>
              </svg>
              Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ
            </div>
          </div>
          <div class="pin-display">
            <span class="pin-value" id="pinDisplay" data-testid="pin-display">******</span>
            <button class="btn btn-ghost" onclick="togglePin()" data-testid="toggle-pin-btn">
              <svg id="pinEyeIcon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/>
              </svg>
            </button>
          </div>
          <div style="display: flex; gap: 8px; justify-content: center;">
            <button class="btn btn-primary btn-sm" onclick="regeneratePin()" data-testid="regenerate-pin-btn">
              <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/>
              </svg>
              Ø·Ù„Ø¨ Ø±Ù…Ø² Ø¬Ø¯ÙŠØ¯
            </button>
          </div>
          <div class="pin-warning">
            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/>
            </svg>
            Ø§Ø­ÙØ¸ Ù‡Ø°Ø§ Ø§Ù„Ø±Ù…Ø² ÙˆÙ„Ø§ ØªØ´Ø§Ø±ÙƒÙ‡ Ù…Ø¹ Ø£Ø­Ø¯
          </div>
        </div>

        <!-- Receipts Card -->
        <div class="card">
          <div class="card-header">
            <div class="card-title">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8Z"/><path d="M14 2v6h6"/><path d="M16 13H8"/><path d="M16 17H8"/><path d="M10 9H8"/>
              </svg>
              Ø§Ù„Ø¥ÙŠØµØ§Ù„Ø§Øª
            </div>
          </div>
          <div id="receiptsList"></div>
        </div>
      </section>

      <!-- Bottom Navigation -->
      <nav class="bottom-nav">
        <button class="nav-item active" onclick="switchSection('home')" data-testid="nav-home">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/>
          </svg>
          <span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
        </button>
        <button class="nav-item" onclick="switchSection('salaries')" data-testid="nav-salaries">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 7V4a1 1 0 0 0-1-1H5a2 2 0 0 0 0 4h15a1 1 0 0 1 1 1v4h-3a2 2 0 0 0 0 4h3a1 1 0 0 0 1-1v-2a1 1 0 0 0-1-1"/><path d="M3 5v14a2 2 0 0 0 2 2h15a1 1 0 0 0 1-1v-4"/>
          </svg>
          <span>Ø§Ù„Ø±ÙˆØ§ØªØ¨</span>
        </button>
        <button class="nav-item" onclick="switchSection('chat')" data-testid="nav-chat">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M7.9 20A9 9 0 1 0 4 16.1L2 22Z"/>
          </svg>
          <span>Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©</span>
        </button>
        <button class="nav-item" onclick="switchSection('profile')" data-testid="nav-profile">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>
          </svg>
          <span>Ø­Ø³Ø§Ø¨ÙŠ</span>
        </button>
      </nav>
    </div>

    <!-- Edit Profile Modal -->
    <div id="editModal" class="modal hidden">
      <div class="modal-content">
        <div class="modal-header">
          <div class="modal-title">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</div>
          <button class="modal-close" onclick="closeEditModal()">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M18 6 6 18"/><path d="m6 6 12 12"/>
            </svg>
          </button>
        </div>
        <form id="editForm" onsubmit="saveProfile(event)">
          <div class="form-group">
            <label class="form-label">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
            <input type="text" class="form-input" id="editName" data-testid="edit-name">
          </div>
          <div class="form-group">
            <label class="form-label">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
            <input type="tel" class="form-input" id="editPhone" data-testid="edit-phone">
          </div>
          <div class="form-group">
            <label class="form-label">Ø§Ù„Ø¯ÙˆÙ„Ø©</label>
            <input type="text" class="form-input" id="editCountry" data-testid="edit-country">
          </div>
          <div class="form-group">
            <label class="form-label">Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</label>
            <input type="text" class="form-input" id="editCity" data-testid="edit-city">
          </div>
          <div class="form-group">
            <label class="form-label">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
            <input type="text" class="form-input" id="editAddress" data-testid="edit-address">
          </div>
          <div id="editCustomFields"></div>
          <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 12px;" data-testid="save-profile-btn">Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
        </form>
      </div>
    </div>

    <!-- Notifications Modal -->
    <div id="notifModal" class="modal hidden">
      <div class="modal-content">
        <div class="modal-header">
          <div class="modal-title">Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</div>
          <button class="modal-close" onclick="closeNotifModal()">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M18 6 6 18"/><path d="m6 6 12 12"/>
            </svg>
          </button>
        </div>
        <div id="allNotifications"></div>
      </div>
    </div>
  </div>

  <script>
    // Get token from URL
    const pathParts = window.location.pathname.split('/');
    const token = pathParts[pathParts.length - 1];
    
    let clientData = null;
    let salariesData = [];
    let notificationsData = [];
    let clientPin = null;
    let pinVisible = false;
    let currency = 'Ø±.Ø³';

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      if (!token || token === 'portal') {
        showError();
        return;
      }
      loadData();
      
      // Enter to send chat
      document.getElementById('chatInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendMessage();
      });
    });

    // API Helper
    async function api(method, url, data = null) {
      const options = { method, credentials: 'include' };
      if (data) {
        options.headers = { 'Content-Type': 'application/json' };
        options.body = JSON.stringify(data);
      }
      const res = await fetch(url, options);
      const json = await res.json();
      if (!res.ok) throw new Error(json.error || 'Ø­Ø¯Ø« Ø®Ø·Ø£');
      return json;
    }

    // Load all data
    async function loadData() {
      try {
        clientData = await api('GET', `/api/portal/${token}/profile`);
        
        try {
          salariesData = await api('GET', `/api/portal/${token}/salaries`);
        } catch (e) { salariesData = []; }

        try {
          const notifResult = await api('GET', `/api/portal/${token}/notifications`);
          notificationsData = notifResult.notifications || [];
          updateNotifBadge(notifResult.unreadCount || 0);
        } catch (e) { notificationsData = []; }

        // Load settings for currency
        try {
          const settings = await api('GET', '/api/ai/settings');
          currency = settings.salaryCurrency || 'Ø±.Ø³';
        } catch (e) {}

        renderAll();
        showMain();
        loadPin();
        loadChat();
        setInterval(loadChat, 5000);
      } catch (err) {
        console.error('Load error:', err);
        showError();
      }
    }

    function showError() {
      document.getElementById('loadingState').classList.add('hidden');
      document.getElementById('errorState').classList.remove('hidden');
    }

    function showMain() {
      document.getElementById('loadingState').classList.add('hidden');
      document.getElementById('mainContent').classList.remove('hidden');
    }

    // Navigation
    function switchSection(section) {
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
      document.getElementById(`section-${section}`).classList.add('active');
      document.querySelector(`[data-testid="nav-${section}"]`).classList.add('active');
    }

    // Render all data
    function renderAll() {
      const firstName = (clientData.fullName || '').split(' ')[0] || 'Ù…Ø±Ø­Ø¨Ø§Ù‹';
      document.querySelector('.header-title').textContent = `Ù…Ø±Ø­Ø¨Ø§Ù‹ ${firstName}`;

      renderStats();
      renderLatestSalary();
      renderSalaries();
      renderProfile();
      renderReceipts();
      renderRecentNotifications();
    }

    // Stats
    function renderStats() {
      let totalSalary = 0;
      let netSalary = 0;
      
      if (salariesData.length > 0) {
        const latest = salariesData[0];
        totalSalary = latest.total || 0;
        netSalary = latest.net || latest.total || 0;
      }

      document.getElementById('statTotalSalary').textContent = formatNumber(totalSalary);
      document.getElementById('statNetSalary').textContent = formatNumber(netSalary);
    }

    function formatNumber(num) {
      return new Intl.NumberFormat('ar-SA').format(num);
    }

    // Latest Salary Card
    function renderLatestSalary() {
      const container = document.getElementById('latestSalaryCard');
      
      if (!salariesData.length) {
        container.innerHTML = `
          <div class="empty-state">
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M19 7V4a1 1 0 0 0-1-1H5a2 2 0 0 0 0 4h15a1 1 0 0 1 1 1v4h-3a2 2 0 0 0 0 4h3a1 1 0 0 0 1-1v-2a1 1 0 0 0-1-1"/><path d="M3 5v14a2 2 0 0 0 2 2h15a1 1 0 0 0 1-1v-4"/>
            </svg>
            <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±ÙˆØ§ØªØ¨ Ù…Ø³Ø¬Ù„Ø©</p>
          </div>
        `;
        return;
      }

      const salary = salariesData[0];
      container.innerHTML = renderSalaryCard(salary, true);
    }

    // Salaries List
    function renderSalaries() {
      const container = document.getElementById('salariesList');
      
      if (!salariesData.length) {
        container.innerHTML = `
          <div class="empty-state">
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M19 7V4a1 1 0 0 0-1-1H5a2 2 0 0 0 0 4h15a1 1 0 0 1 1 1v4h-3a2 2 0 0 0 0 4h3a1 1 0 0 0 1-1v-2a1 1 0 0 0-1-1"/><path d="M3 5v14a2 2 0 0 0 2 2h15a1 1 0 0 0 1-1v-4"/>
            </svg>
            <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±ÙˆØ§ØªØ¨ Ù…Ø³Ø¬Ù„Ø© Ø­Ø§Ù„ÙŠØ§Ù‹</p>
          </div>
        `;
        return;
      }

      container.innerHTML = salariesData.map(s => renderSalaryCard(s)).join('');
    }

    function renderSalaryCard(salary, isLatest = false) {
      const total = salary.total || 0;
      const deduction = salary.deduction || 0;
      const net = salary.net || total;
      const isPaid = salary.status === 'paid';

      return `
        <div class="salary-card" data-testid="salary-card">
          <div class="salary-header">
            <div class="salary-period">
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/>
              </svg>
              ${salary.periodName || 'Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©'}
            </div>
            <span class="salary-status ${isPaid ? 'status-paid' : 'status-pending'}">
              ${isPaid ? 'ØªÙ… Ø§Ù„Ø¯ÙØ¹' : 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©'}
            </span>
          </div>
          <div class="salary-amount">
            <div class="salary-label">ØµØ§ÙÙŠ Ø§Ù„Ø±Ø§ØªØ¨</div>
            <div class="salary-value">
              ${formatNumber(net)}
              <span class="salary-currency">${currency}</span>
            </div>
          </div>
          <div class="salary-details">
            <div class="salary-detail">
              <div class="detail-label">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</div>
              <div class="detail-value">${formatNumber(total)}</div>
            </div>
            <div class="salary-detail">
              <div class="detail-label">Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª</div>
              <div class="detail-value deduction">-${formatNumber(deduction)}</div>
            </div>
            <div class="salary-detail">
              <div class="detail-label">Ø§Ù„Ù…Ø¹Ø±ÙØ§Øª</div>
              <div class="detail-value">${salary.salaries ? salary.salaries.length : 1}</div>
            </div>
          </div>
        </div>
      `;
    }

    // Profile
    function renderProfile() {
      const fields = [
        { label: 'Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„', value: clientData.fullName, icon: 'user' },
        { label: 'Ø£Ø±Ù‚Ø§Ù… ID', value: (clientData.ids || []).join('ØŒ '), icon: 'hash' },
        { label: 'Ø§Ù„Ù‡Ø§ØªÙ', value: clientData.phone, icon: 'phone' },
        { label: 'ÙˆØ§ØªØ³Ø§Ø¨', value: clientData.whatsappPhone || clientData.phone, icon: 'message' },
        { label: 'Ø§Ù„Ø¯ÙˆÙ„Ø©', value: clientData.country, icon: 'globe' },
        { label: 'Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©', value: clientData.city, icon: 'map' },
        { label: 'Ø§Ù„Ø¹Ù†ÙˆØ§Ù†', value: clientData.address, icon: 'home' },
        { label: 'Ø§Ù„ÙˆÙƒØ§Ù„Ø©', value: clientData.agencyName, icon: 'building' }
      ];

      // Add custom fields
      const customFields = clientData.customFields || {};
      Object.entries(customFields).forEach(([key, value]) => {
        if (!key.endsWith('__sub') && value) {
          const subValue = customFields[key + '__sub'];
          fields.push({
            label: key.replace(/_/g, ' '),
            value: subValue ? `${value} (${subValue})` : value,
            icon: 'tag'
          });
        }
      });

      document.getElementById('profileInfo').innerHTML = fields.map(f => `
        <div class="info-item">
          <span class="info-label">
            ${getIcon(f.icon, 14)}
            ${f.label}
          </span>
          <span class="info-value">${f.value || '-'}</span>
        </div>
      `).join('');
    }

    function getIcon(name, size = 16) {
      const icons = {
        user: `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>`,
        hash: `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="4" x2="20" y1="9" y2="9"/><line x1="4" x2="20" y1="15" y2="15"/><line x1="10" x2="8" y1="3" y2="21"/><line x1="16" x2="14" y1="3" y2="21"/></svg>`,
        phone: `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>`,
        message: `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M7.9 20A9 9 0 1 0 4 16.1L2 22Z"/></svg>`,
        globe: `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20"/><path d="M2 12h20"/></svg>`,
        map: `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>`,
        home: `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>`,
        building: `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect width="16" height="20" x="4" y="2" rx="2" ry="2"/><path d="M9 22v-4h6v4"/><path d="M8 6h.01"/><path d="M16 6h.01"/><path d="M12 6h.01"/><path d="M12 10h.01"/><path d="M12 14h.01"/><path d="M16 10h.01"/><path d="M16 14h.01"/><path d="M8 10h.01"/><path d="M8 14h.01"/></svg>`,
        tag: `<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2H2v10l9.29 9.29c.94.94 2.48.94 3.42 0l6.58-6.58c.94-.94.94-2.48 0-3.42L12 2Z"/><path d="M7 7h.01"/></svg>`
      };
      return icons[name] || '';
    }

    // Receipts
    async function renderReceipts() {
      const container = document.getElementById('receiptsList');
      
      try {
        const receipts = await api('GET', `/api/portal/${token}/receipts`);
        
        if (!receipts || receipts.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8Z"/><path d="M14 2v6h6"/>
              </svg>
              <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥ÙŠØµØ§Ù„Ø§Øª</p>
            </div>
          `;
          return;
        }

        container.innerHTML = receipts.map(r => {
          const date = new Date(r.uploadedAt).toLocaleDateString('ar', { month: 'short', day: 'numeric' });
          const sizeKB = Math.round((r.size || 0) / 1024);
          const isText = r.isTextOnly || !r.filename;
          
          return `
            <div class="receipt-item" data-testid="receipt-item">
              <div class="receipt-icon">
                ${isText ? 
                  '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/></svg>' :
                  '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8Z"/><path d="M14 2v6h6"/></svg>'
                }
              </div>
              <div class="receipt-info" style="flex: 1;">
                <div class="receipt-name">${isText ? 'ğŸ“ Ø¥ÙŠØµØ§Ù„ Ù†ØµÙŠ' : r.originalName}</div>
                <div class="receipt-meta">${date} â€¢ ${isText ? 'Ù†Øµ' : sizeKB + ' KB'}</div>
                ${r.description ? `
                  <div style="margin-top: 8px; padding: 8px; background: var(--surface); border-radius: 4px; font-size: 12px; white-space: pre-wrap; color: var(--text-muted);">
                    ${r.description}
                  </div>
                ` : ''}
              </div>
              ${!isText ? `
                <div class="receipt-actions">
                  <a href="/api/receipts/file/${r.filename}" target="_blank" class="btn btn-ghost btn-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/>
                    </svg>
                  </a>
                  <a href="/api/receipts/file/${r.filename}" download class="btn btn-ghost btn-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/>
                    </svg>
                  </a>
                </div>
              ` : ''}
            </div>
          `;
        }).join('');
      } catch (err) {
        container.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 20px;">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥ÙŠØµØ§Ù„Ø§Øª</p>';
      }
    }

    // Notifications
    function updateNotifBadge(count) {
      const badge = document.getElementById('notifBadge');
      if (count > 0) {
        badge.textContent = count > 9 ? '9+' : count;
        badge.classList.remove('hidden');
      } else {
        badge.classList.add('hidden');
      }
    }

    function renderRecentNotifications() {
      const container = document.getElementById('recentNotifications');
      const recent = notificationsData.slice(0, 2);
      
      if (!recent.length) {
        container.innerHTML = `
          <div class="empty-state" style="padding: 20px;">
            <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</p>
          </div>
        `;
        return;
      }

      container.innerHTML = recent.map(n => renderNotificationItem(n)).join('');
    }

    function renderNotificationItem(n) {
      const date = new Date(n.createdAt).toLocaleDateString('ar', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
      const isSalaryNotif = n.title.includes('Ø±Ø§ØªØ¨') || n.type === 'salary';
      const clickAction = isSalaryNotif ? `handleSalaryNotification('${n.id}')` : `markAsRead('${n.id}')`;
      const icon = isSalaryNotif 
        ? `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: var(--success);"><path d="M19 7V4a1 1 0 0 0-1-1H5a2 2 0 0 0 0 4h15a1 1 0 0 1 1 1v4h-3a2 2 0 0 0 0 4h3a1 1 0 0 0 1-1v-2a1 1 0 0 0-1-1"/><path d="M3 5v14a2 2 0 0 0 2 2h15a1 1 0 0 0 1-1v-4"/></svg>`
        : `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: var(--primary);"><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></svg>`;
      
      return `
        <div class="notification-item ${!n.isRead ? 'unread' : ''}" onclick="${clickAction}" data-testid="notification-item" style="cursor: pointer;">
          <div class="notification-icon">
            ${icon}
          </div>
          <div class="notification-content">
            <div class="notification-title">${n.title}</div>
            <div class="notification-message">${n.message}</div>
            <div class="notification-time">${date}${isSalaryNotif ? ' â€¢ Ø§Ø¶ØºØ· Ù„Ù„Ø¹Ø±Ø¶' : ''}</div>
          </div>
        </div>
      `;
    }

    // Handle salary notification click - go to salaries section
    async function handleSalaryNotification(id) {
      await markAsRead(id);
      closeNotifModal();
      switchSection('salaries');
    }

    function showNotifications() {
      document.getElementById('allNotifications').innerHTML = notificationsData.length 
        ? notificationsData.map(n => renderNotificationItem(n)).join('')
        : '<p style="color: var(--text-muted); text-align: center; padding: 40px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</p>';
      document.getElementById('notifModal').classList.remove('hidden');
    }

    function closeNotifModal() {
      document.getElementById('notifModal').classList.add('hidden');
    }

    async function markAsRead(id) {
      try {
        await api('POST', `/api/portal/${token}/notifications/${id}/read`);
        const notif = notificationsData.find(n => n.id === id);
        if (notif) notif.isRead = true;
        const unread = notificationsData.filter(n => !n.isRead).length;
        updateNotifBadge(unread);
        renderRecentNotifications();
      } catch (e) {}
    }

    // PIN
    async function loadPin() {
      try {
        const result = await api('GET', `/api/portal/${token}/pin`);
        clientPin = result.pin;
      } catch (e) {}
    }

    function togglePin() {
      pinVisible = !pinVisible;
      document.getElementById('pinDisplay').textContent = pinVisible && clientPin ? clientPin : '******';
      document.getElementById('pinEyeIcon').innerHTML = pinVisible 
        ? '<path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" x2="23" y1="1" y2="23"/>'
        : '<path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/>';
    }

    async function regeneratePin() {
      if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø·Ù„Ø¨ Ø±Ù…Ø² Ø³Ø±ÙŠ Ø¬Ø¯ÙŠØ¯ØŸ')) return;
      
      try {
        const result = await api('POST', `/api/portal/${token}/pin/regenerate`);
        clientPin = result.pin;
        pinVisible = true;
        document.getElementById('pinDisplay').textContent = result.pin;
        showAlert('ØªÙ… ØªÙˆÙ„ÙŠØ¯ Ø±Ù…Ø² Ø¬Ø¯ÙŠØ¯: ' + result.pin);
      } catch (e) {
        showAlert('ÙØ´Ù„ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø±Ù…Ø²', 'error');
      }
    }

    // Chat
    async function loadChat() {
      try {
        const result = await api('GET', `/api/portal/${token}/chat/messages`);
        renderChat(result.messages || []);
      } catch (e) {}
    }

    function renderChat(messages) {
      const container = document.getElementById('chatMessages');
      
      if (!messages.length) {
        container.innerHTML = `
          <div class="empty-state">
            <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M7.9 20A9 9 0 1 0 4 16.1L2 22Z"/>
            </svg>
            <p>Ø§Ø¨Ø¯Ø£ Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</p>
          </div>
        `;
        return;
      }

      container.innerHTML = messages.map(m => {
        const time = new Date(m.timestamp).toLocaleTimeString('ar', { hour: '2-digit', minute: '2-digit' });
        return `
          <div class="chat-bubble ${m.sender}" data-testid="chat-bubble">
            ${m.message}
            <div class="chat-time">${time}</div>
          </div>
        `;
      }).join('');

      container.scrollTop = container.scrollHeight;
    }

    async function sendMessage() {
      const input = document.getElementById('chatInput');
      const message = input.value.trim();
      if (!message) return;

      try {
        input.disabled = true;
        await api('POST', `/api/portal/${token}/chat/messages`, { message });
        input.value = '';
        await loadChat();
      } catch (e) {
        showAlert('ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©', 'error');
      } finally {
        input.disabled = false;
        input.focus();
      }
    }

    // Edit Profile
    function openEditModal() {
      document.getElementById('editName').value = clientData.fullName || '';
      document.getElementById('editPhone').value = clientData.phone || '';
      document.getElementById('editCountry').value = clientData.country || '';
      document.getElementById('editCity').value = clientData.city || '';
      document.getElementById('editAddress').value = clientData.address || '';

      // Custom fields
      const customFields = clientData.customFields || {};
      let customHtml = '';
      Object.entries(customFields).forEach(([key, value]) => {
        if (!key.endsWith('__sub')) {
          customHtml += `
            <div class="form-group">
              <label class="form-label">${key.replace(/_/g, ' ')}</label>
              <input type="text" class="form-input" id="editCustom_${key}" value="${value || ''}">
            </div>
          `;
          const subValue = customFields[key + '__sub'];
          if (subValue !== undefined) {
            customHtml += `
              <div class="form-group">
                <label class="form-label">${key.replace(/_/g, ' ')} (ØªÙØ§ØµÙŠÙ„)</label>
                <input type="text" class="form-input" id="editCustom_${key}__sub" value="${subValue || ''}">
              </div>
            `;
          }
        }
      });
      document.getElementById('editCustomFields').innerHTML = customHtml;

      document.getElementById('editModal').classList.remove('hidden');
    }

    function closeEditModal() {
      document.getElementById('editModal').classList.add('hidden');
    }

    async function saveProfile(e) {
      e.preventDefault();
      
      const updates = {
        fullName: document.getElementById('editName').value.trim(),
        phone: document.getElementById('editPhone').value.trim(),
        country: document.getElementById('editCountry').value.trim(),
        city: document.getElementById('editCity').value.trim(),
        address: document.getElementById('editAddress').value.trim()
      };

      // Custom fields
      const customFields = clientData.customFields || {};
      const updatedCustomFields = {};
      Object.keys(customFields).forEach(key => {
        if (!key.endsWith('__sub')) {
          const input = document.getElementById(`editCustom_${key}`);
          if (input) updatedCustomFields[key] = input.value.trim();
          const subInput = document.getElementById(`editCustom_${key}__sub`);
          if (subInput) updatedCustomFields[key + '__sub'] = subInput.value.trim();
        }
      });
      updates.customFields = updatedCustomFields;

      try {
        await api('PUT', `/api/portal/${token}/profile`, updates);
        Object.assign(clientData, updates);
        clientData.customFields = updatedCustomFields;
        renderAll();
        closeEditModal();
        showAlert('ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª');
      } catch (e) {
        showAlert(e.message, 'error');
      }
    }

    // Alert
    function showAlert(message, type = 'success') {
      const existing = document.querySelector('.alert');
      if (existing) existing.remove();

      const alert = document.createElement('div');
      alert.className = `alert ${type}`;
      alert.textContent = message;
      document.body.appendChild(alert);

      setTimeout(() => alert.remove(), 3000);
    }

    // Close modals on outside click
    document.querySelectorAll('.modal').forEach(modal => {
      modal.addEventListener('click', e => {
        if (e.target === modal) modal.classList.add('hidden');
      });
    });
  </script>
</body>
</html>
